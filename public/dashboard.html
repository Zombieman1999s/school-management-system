<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - School Hub</title>
    
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-bg: #f8f9fa;
            --card-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.15), 0 5px 10px -3px rgba(0, 0, 0, 0.1);
            --card-hover-shadow: 0 20px 35px -5px rgba(0, 0, 0, 0.2), 0 10px 15px -3px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: rgba(240, 242, 245, 0.85); 
            color: #1f2937;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: url('image_10.png'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(8px);
            transform: scale(1.02);
        }

        .snowflake {
            position: fixed; top: -10px; color: #fff; user-select: none; z-index: 9999;
            pointer-events: none; animation-name: fall; animation-timing-function: linear;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        @keyframes fall { to { transform: translateY(105vh); } }

        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease-out, visibility 0.5s; backdrop-filter: blur(10px);
        }
        #loadingScreen.hidden { opacity: 0; visibility: hidden; }

        .navbar { 
            background-color: rgba(255, 255, 255, 0.95) !important; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            padding: 0.8rem 0; 
            backdrop-filter: blur(10px);
        }
        .navbar-brand { 
            color: var(--primary-color) !important; 
            font-weight: 800; 
            font-size: 1.35rem; 
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
        }

        .navbar-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-right: 10px;
        }

        .user-info { font-size: 0.9rem; color: #4b5563; background: #f3f4f6; border: 1px solid #e5e7eb; }

        .card { 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            border-radius: 16px; 
            box-shadow: var(--card-shadow); 
            background-color: #ffffff; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .card-menu {
            cursor: pointer; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 1.5rem;
            background: white; border: 1px solid rgba(0,0,0,0.03); 
            position: relative; overflow: hidden;
        }
        
        .card-menu:hover { 
            transform: translateY(-8px); 
            box-shadow: var(--card-hover-shadow); 
            border-color: transparent; z-index: 1;
        }
        
        .card-menu i { font-size: 2.8rem; margin-bottom: 1rem; transition: transform 0.3s ease; }
        .card-menu:hover i { transform: scale(1.15) rotate(-5deg); }
        .card-menu h6 { font-weight: 700; margin: 0; color: #374151; font-size: 1rem; }

        .section-title { 
            display: inline-flex; align-items: center; 
            font-weight: 800; color: #111827; margin: 2.5rem 0 1.5rem 0; font-size: 1.25rem;
            background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); backdrop-filter: blur(5px);
        }
        .section-title::before { content: ''; display: block; width: 6px; height: 24px; background: var(--primary-color); margin-right: 12px; border-radius: 4px; }

        /* Calendar Styles */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.85rem; font-weight: bold; color: #6b7280; margin-bottom: 8px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; } 
        .calendar-day { 
            height: 45px; display: flex; align-items: center; justify-content: center; flex-direction: column;
            border-radius: 10px; font-size: 0.95rem; cursor: pointer; transition: all 0.2s;
            border: 1px solid #f3f4f6; position: relative; font-weight: 500;
        }
        .calendar-day:hover:not(.empty) { background-color: #eff6ff; transform: scale(1.1); z-index: 10; border-color: var(--primary-color); }
        .calendar-day.today { background-color: var(--primary-color); color: white; font-weight: 800; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.4); border: none; }
        .calendar-day.empty { cursor: default; border: none; }
        .calendar-day.has-event { font-weight: 800; color: #0d6efd; background-color: #f0f7ff; border-color: #cce5ff; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; bottom: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .calendar-day.today .event-dot { border: 1px solid white; }

        #newsList .list-group-item { border: none; border-bottom: 1px solid #f0f0f0; padding: 1.2rem 1.5rem; transition: background 0.2s; }
        #newsList .list-group-item:hover { background-color: #fafafa; }
        #newsList .list-group-item:last-child { border-bottom: none; }

        .btn-action { width: 34px; height: 34px; padding: 0; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .target-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: #eef2ff; color: #4f46e5; font-weight: 700; margin-left: 8px; border: 1px solid #e0e7ff; }
        
        .menu-icon-primary { color: #2563eb; background: #eff6ff; padding: 14px; border-radius: 16px; }
        .menu-icon-warning { color: #d97706; background: #fffbeb; padding: 14px; border-radius: 16px; }
        .menu-icon-success { color: #059669; background: #ecfdf5; padding: 14px; border-radius: 16px; }
        .menu-icon-purple { color: #7c3aed; background: #f5f3ff; padding: 14px; border-radius: 16px; }
        .menu-icon-info { color: #0891b2; background: #ecfeff; padding: 14px; border-radius: 16px; }
        .menu-icon-danger { color: #dc2626; background: #fef2f2; padding: 14px; border-radius: 16px; }
        .menu-icon-dark { color: #374151; background: #f3f4f6; padding: 14px; border-radius: 16px; }
        .menu-icon-ai { color: #db2777; background: #fdf2f8; padding: 14px; border-radius: 16px; }

        #teacherSection, #technicianSection, #transportSection, #personnelSection, #adminSection, #newsSection, #securitySection { display: none; }
        .admin-only { display: none; }

        @media (max-width: 767.98px) {
            .container { padding-left: 16px; padding-right: 16px; }
            .card-menu { padding: 1rem; min-height: 110px; }
            .card-menu i { font-size: 2rem; margin-bottom: 0.5rem; padding: 10px; }
            .card-menu h6 { font-size: 0.85rem; }
            .calendar-days { gap: 4px; }
            .calendar-day { height: 40px; font-size: 0.85rem; border-radius: 8px; }
            .calendar-header h6 { font-size: 1rem; }
            .table th, .table td { padding: 0.75rem 0.5rem; font-size: 0.85rem; }
            .badge { font-size: 0.7rem; padding: 5px 8px; }
            .section-title { margin: 1.5rem 0 1rem 0; font-size: 1.1rem; }
            .mb-5 { margin-bottom: 2.5rem !important; }
            .navbar-brand { font-size: 1.2rem; }
            #newsList .list-group-item { padding: 1rem; }
        }
    </style>
</head>
<body>

    <div id="loadingScreen">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h6 class="text-muted fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h6>
    </div>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="icon.png" alt="Logo" class="navbar-logo">
                School Hub
            </a>
            <div class="d-flex align-items-center gap-3">
                <div class="user-info d-none d-md-flex align-items-center bg-white px-3 py-2 rounded-pill shadow-sm border">
                    <i class="fa-regular fa-circle-user me-2 fs-5 text-secondary"></i>
                    <div>
                        <span id="userEmail" class="fw-bold d-block lh-1 text-dark">...</span>
                        <small id="userRoleBadge" class="text-muted" style="font-size: 0.75rem;">...</small>
                    </div>
                </div>
                <button id="btnLogout" class="btn btn-danger btn-sm rounded-circle shadow-sm" style="width: 38px; height: 38px;" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4 mb-5">
        
        <div id="newsSection" class="mb-5">
            <div class="row g-3 g-lg-4">
                <div class="col-lg-7 order-2 order-lg-1">
                    <div class="card h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-bottom-0">
                            <h5 class="m-0 fw-bold text-dark fs-5"><i class="fa-solid fa-bullhorn text-primary me-2"></i> ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</h5>
                            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-2">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                        </div>
                        <div class="card-body p-0">
                            <ul id="newsList" class="list-group list-group-flush">
                                <li class="list-group-item text-center py-5 text-muted">
                                    <div class="spinner-border spinner-border-sm text-secondary mb-2"></div>
                                    <div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 order-1 order-lg-2">
                    <div class="card h-100">
                        <div class="card-header bg-white border-0 py-3">
                            <div class="calendar-header">
                                <h6 class="m-0 fw-bold text-dark d-flex align-items-center fs-5">
                                    <i class="fa-regular fa-calendar-days text-success me-2"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
                                </h6>
                                <div class="d-flex align-items-center bg-light rounded-pill p-1">
                                    <button class="btn btn-sm btn-white rounded-circle shadow-sm me-1" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                                    <span id="calendarMonthYear" class="fw-bold text-dark small px-3" style="min-width: 100px; text-align: center;">...</span>
                                    <button class="btn btn-sm btn-white rounded-circle shadow-sm ms-1" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                                </div>
                                <button id="btnAddEvent" class="btn btn-sm btn-primary ms-2 rounded-circle d-none shadow-sm" onclick="openAddEventModal()"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="card-body pt-0">
                            <div class="calendar-weekdays">
                                <div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div>
                            </div>
                            <div id="calendarDays" class="calendar-days"></div>
                            <div class="text-center mt-3 small text-muted bg-light rounded py-1">
                                <i class="fa-solid fa-circle-info me-1"></i> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π/‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="teacherSection">
            <div class="section-title">‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</div>
            <div class="row g-3 g-md-4">
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='my_history.html'"><i class="fa-solid fa-clock-rotate-left menu-icon-primary"></i><h6>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='repair_form.html'"><i class="fa-solid fa-screwdriver-wrench menu-icon-warning"></i><h6>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='vehicle_form.html'"><i class="fa-solid fa-car-side menu-icon-success"></i><h6>‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏ñ</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='leave_form.html'"><i class="fa-solid fa-file-medical menu-icon-purple"></i><h6>‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='outside_form.html'"><i class="fa-solid fa-person-walking-luggage menu-icon-info"></i><h6>‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='manpower_form.html'"><i class="fa-solid fa-users menu-icon-danger"></i><h6>‡∏Ç‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</h6></div></div>
                
                <div class="col-6 col-md-3">
                    <div class="card card-menu"onclick="window.location.href='studentcare/student_care.html'">
                        <i class="fa-solid fa-chalkboard-user menu-icon-dark"></i>
                        <h6>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h6>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card card-menu"  onclick="window.location.href='ai_summary.html'">
                        <i class="fa-solid fa-robot menu-icon-ai"></i>
                        <h6>‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° AI</h6>
                    </div>
                </div>

            </div>
        </div>

        <div id="technicianSection">
            <div class="section-title text-warning">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</div>
            <div class="row mb-3 mb-md-4">
                <div class="col-12">
                    <div class="card card-menu flex-row align-items-center justify-content-start p-3 p-md-4 bg-white border-warning" onclick="window.location.href='technician_dashboard.html'" style="border-left: 6px solid #f59e0b;">
                        <i class="fa-solid fa-helmet-safety menu-icon-warning me-3 me-md-4 mb-0"></i>
                        <div><h5 class="fw-bold mb-1 fs-5 text-dark">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á</h5><p class="text-muted m-0">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</p></div>
                        <i class="fa-solid fa-chevron-right ms-auto text-muted"></i>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0"><thead><tr><th class="ps-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="admin-only text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="quickRepairTable"></tbody></table>
                </div>
            </div>
        </div>

        <div id="transportSection">
            <div class="section-title text-success">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</div>
            <div class="row mb-3 mb-md-4">
                <div class="col-12">
                    <div class="card card-menu flex-row align-items-center justify-content-start p-3 p-md-4 bg-white border-success" onclick="window.location.href='transport_dashboard.html'" style="border-left: 6px solid #10b981;">
                        <i class="fa-solid fa-van-shuttle menu-icon-success me-3 me-md-4 mb-0"></i>
                        <div><h5 class="fw-bold mb-1 fs-5 text-dark">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏ñ</h5><p class="text-muted m-0">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p></div>
                        <i class="fa-solid fa-chevron-right ms-auto text-muted"></i>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0"><thead><tr><th class="ps-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="admin-only text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="quickTransportTable"></tbody></table>
                </div>
            </div>
        </div>

        <div id="personnelSection">
            <div class="section-title" style="color: #8b5cf6;">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
            <div class="row mb-3 mb-md-4">
                <div class="col-12">
                    <div class="card card-menu flex-row align-items-center justify-content-start p-3 p-md-4 bg-white" onclick="window.location.href='personnel_dashboard.html'" style="border-left: 6px solid #8b5cf6;">
                        <i class="fa-solid fa-clipboard-user menu-icon-purple me-3 me-md-4 mb-0"></i>
                        <div><h5 class="fw-bold mb-1 fs-5 text-dark">‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠</h5><p class="text-muted m-0">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤/‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p></div>
                        <i class="fa-solid fa-chevron-right ms-auto text-muted"></i>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0"><thead><tr><th class="ps-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ú‡∏π‡πâ‡∏•‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="admin-only text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="quickLeaveTable"></tbody></table>
                </div>
            </div>
        </div>

        <div id="securitySection">
            <div class="section-title" style="color: #6c757d;">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏£‡∏õ‡∏†.)</div>
            <div class="row mb-3 mb-md-4">
                <div class="col-12">
                    <div class="card card-menu flex-row align-items-center justify-content-start p-3 p-md-4 bg-white" onclick="window.location.href='security_dashboard.html'" style="border-left: 6px solid #6c757d;">
                        <i class="fa-solid fa-shield-halved menu-icon-dark me-3 me-md-4 mb-0"></i>
                        <div><h5 class="fw-bold mb-1 fs-5 text-dark">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h5><p class="text-muted m-0">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</p></div>
                        <i class="fa-solid fa-chevron-right ms-auto text-muted"></i>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead><tr><th class="ps-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="admin-only text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="quickOutsideTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="adminSection">
            <div class="section-title text-danger">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</div>
            <div class="row g-2 g-md-3">
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='admin_register.html'"><i class="fa-solid fa-user-plus menu-icon-danger"></i><h6>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='admin_news.html'"><i class="fa-solid fa-bullhorn menu-icon-primary"></i><h6>‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='admin_report.html'"><i class="fa-solid fa-chart-pie menu-icon-dark"></i><h6>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h6></div></div>
                <div class="col-6 col-md-3"><div class="card card-menu" onclick="openUserManagement()"><i class="fa-solid fa-users-gear menu-icon-info"></i><h6>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h6></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userManageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-white border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold fs-5 text-dark"><i class="fa-solid fa-users-gear text-primary me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3 p-lg-4">
                    <div class="input-group mb-3 shadow-sm rounded-pill overflow-hidden border">
                        <span class="input-group-text bg-white border-0 ps-3"><i class="fa-solid fa-search text-muted"></i></span>
                        <input type="text" id="searchUser" class="form-control border-0 py-2" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•...">
                    </div>
                    <div class="table-responsive rounded-3 border">
                        <table class="table table-hover mb-0 align-middle"><thead class="bg-light"><tr><th class="py-3 ps-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th class="py-3">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th class="py-3">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th class="py-3 text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="userTableBody"><tr><td colspan="4" class="text-center py-4 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const snowContainer = document.createElement('div');
            snowContainer.style.position = 'fixed';
            snowContainer.style.top = '0';
            snowContainer.style.left = '0';
            snowContainer.style.width = '100%';
            snowContainer.style.height = '100%';
            snowContainer.style.pointerEvents = 'none';
            snowContainer.style.zIndex = '99999';
            document.body.appendChild(snowContainer);

            function createSnowflake() {
                const snowflake = document.createElement('div');
                snowflake.innerHTML = '‚ùÑ';
                snowflake.classList.add('snowflake');
                const left = Math.random() * 100;
                const animDuration = Math.random() * 3 + 2; 
                const size = Math.random() * 10 + 10; 
                const opacity = Math.random() * 0.6 + 0.2;
                Object.assign(snowflake.style, { left: `${left}vw`, animationDuration: `${animDuration}s`, fontSize: `${size}px`, opacity: opacity });
                snowContainer.appendChild(snowflake);
                setTimeout(() => { snowflake.remove(); }, animDuration * 1000);
            }
            const snowInterval = setInterval(createSnowflake, 100);
            setTimeout(() => { clearInterval(snowInterval); }, 60000);
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏° import ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, onSnapshot, where, deleteDoc, updateDoc, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserRole = "";
        let currentDate = new Date();
        let currentEvents = [];

        setTimeout(() => {
            const loader = document.getElementById('loadingScreen');
            if(loader && !loader.classList.contains('hidden')) { console.warn("Loader timed out"); loader.classList.add('hidden'); }
        }, 3000);

        window.changeMonth = (step) => { currentDate.setMonth(currentDate.getMonth() + step); loadEventsAndRender(); };

        function loadEventsAndRender() {
            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayStr = new Date(year, month, 1).toISOString().split('T')[0];
                const lastDayObj = new Date(year, month + 1, 0);
                const lastDayStr = lastDayObj.toISOString().split('T')[0];
                const q = query(collection(db, "events"), where("date", ">=", firstDayStr), where("date", "<=", lastDayStr));
                onSnapshot(q, (snapshot) => {
                    currentEvents = [];
                    snapshot.forEach(doc => { currentEvents.push({ id: doc.id, ...doc.data() }); });
                    renderCalendar();
                }, (error) => { 
                    console.error("Calendar Error:", error); 
                    // ‡∏ñ‡πâ‡∏≤ error permission ‡πÉ‡∏´‡πâ render ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÜ ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                    renderCalendar();
                });
            } catch (e) { console.error(e); renderCalendar(); }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const monthYearElem = document.getElementById('calendarMonthYear');
            if(monthYearElem) monthYearElem.innerText = `${thaiMonths[month]} ${year + 543}`;
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const daysContainer = document.getElementById('calendarDays');
            if(!daysContainer) return;
            daysContainer.innerHTML = "";
            for (let i = 0; i < firstDay; i++) daysContainer.innerHTML += `<div class="calendar-day empty"></div>`;
            for (let i = 1; i <= lastDate; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const event = currentEvents.find(e => e.date === dateStr);
                let className = "calendar-day";
                let style = "";
                let dotHtml = "";
                let clickAction = `onclick="viewEvent('${dateStr}')"`;
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) className += " today";
                if (event) {
                    className += " has-event";
                    const color = event.color || '#10b981';
                    style = `border: 2px solid ${color}; background-color: ${color}1a; color: ${color};`;
                    dotHtml = `<div class="event-dot" style="background-color: ${color}"></div>`;
                } else if (currentUserRole === 'admin') { clickAction = `onclick="openAddEventModal('${dateStr}')"`; } else { clickAction = ""; }
                daysContainer.innerHTML += `<div class="${className}" style="${style}" ${clickAction}>${i}${dotHtml}</div>`;
            }
        }

        window.openAddEventModal = async (preSelectedDate = '') => {
            if(currentUserRole !== 'admin') return;
            if(!preSelectedDate) { const now = new Date(); preSelectedDate = now.toISOString().split('T')[0]; }
            const { value: formValues } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà',
                html: `<label class="form-label text-start w-100">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="swal-date" type="date" class="form-control mb-3" value="${preSelectedDate}"><label class="form-label text-start w-100">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input id="swal-title" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©"><label class="form-label text-start w-100">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ò‡∏µ‡∏°</label><input id="swal-color" type="color" class="form-control form-control-color w-100" value="#10b981">`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#0d6efd',
                preConfirm: () => {
                    const dateVal = document.getElementById('swal-date').value;
                    const titleVal = document.getElementById('swal-title').value;
                    if(!dateVal || !titleVal) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return false; }
                    return { date: dateVal, title: titleVal, color: document.getElementById('swal-color').value }
                }
            });
            if (formValues) {
                try {
                    await addDoc(collection(db, "events"), {
                        date: formValues.date, title: formValues.title, color: formValues.color, created_by: auth.currentUser.uid, created_at: serverTimestamp()
                    });
                    Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                } catch (error) { Swal.fire('Error', error.message, 'error'); }
            }
        };

        window.viewEvent = (dateStr) => {
            const event = currentEvents.find(e => e.date === dateStr);
            if (!event) return;
            let htmlContent = `<h5 style="color:${event.color}">${event.title}</h5>`;
            if (currentUserRole === 'admin') {
                Swal.fire({
                    title: `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`, html: htmlContent, showDenyButton: true, showCancelButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á', denyButtonText: '‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', denyButtonColor: '#dc3545'
                }).then(async (result) => {
                    if (result.isDenied) { try { await deleteDoc(doc(db, "events", event.id)); Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success'); } catch (e) { Swal.fire('Error', e.message, 'error'); } }
                });
            } else { Swal.fire({ title: `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`, html: htmlContent, confirmButtonText: '‡∏õ‡∏¥‡∏î' }); }
        };

        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            if (user) {
                try {
                    document.getElementById('userEmail').innerText = user.email ? user.email.split('@')[0] : 'User';
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role || 'guest';
                        document.getElementById('userRoleBadge').innerText = getThaiRoleName(currentUserRole);
                        hideAllSections();
                        
                        // üî•üî•üî• ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö: ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å Role ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏°‡∏ô‡∏π 'teacher' (‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£)
                        if (isTeacher(currentUserRole)) showSec(['news', 'teacher']);
                        else if (currentUserRole === 'personnel') { showSec(['news', 'teacher', 'personnel']); loadQuickLeaves(); }
                        else if (currentUserRole === 'technician') { showSec(['news', 'teacher', 'technician']); loadQuickRepairs(); } // ‡πÄ‡∏û‡∏¥‡πà‡∏° 'teacher'
                        else if (currentUserRole === 'transport') { showSec(['news', 'teacher', 'transport']); loadQuickTransport(); } // ‡πÄ‡∏û‡∏¥‡πà‡∏° 'teacher'
                        else if (currentUserRole === 'security_guard') { showSec(['news', 'teacher', 'security']); loadQuickOutside(); } // ‡πÄ‡∏û‡∏¥‡πà‡∏° 'teacher'
                        else if (currentUserRole === 'admin') { 
                            showSec(['admin', 'teacher', 'news', 'personnel', 'technician', 'transport', 'security']); 
                            loadQuickRepairs(); loadQuickLeaves(); loadQuickTransport(); loadQuickOutside();
                            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'table-cell');
                            document.getElementById('btnAddEvent').classList.remove('d-none');
                        } 
                        else showSec(['news', 'teacher']); // ‡πÄ‡∏û‡∏¥‡πà‡∏° 'teacher' ‡πÉ‡∏´‡πâ Role ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô User ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤)
                        
                        // üî• ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
                        loadNews(); 
                        loadEventsAndRender();
                    }
                } catch (err) { console.error("Auth Error:", err); Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ', 'error'); }
            } else { window.location.href = "index.html"; }
            if(loadingScreen) loadingScreen.classList.add('hidden');
        });

        function isTeacher(role) { return role === 'teacher' || role === 'teacher_basic' || role === 'teacher_kindergarten'; }
        function getThaiRoleName(role) {
            const map = { 'admin': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'teacher_basic': '‡∏Ñ‡∏£‡∏π (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)', 'teacher_kindergarten': '‡∏Ñ‡∏£‡∏π (‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•)', 'teacher': '‡∏Ñ‡∏£‡∏π/‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', 'personnel': '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', 'technician': '‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', 'transport': '‡∏á‡∏≤‡∏ô‡∏£‡∏ñ', 'security_guard': '‡∏£‡∏õ‡∏†.' };
            return map[role] || role?.toUpperCase() || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
        }

        // üî• ‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß: ‡πÄ‡∏û‡∏¥‡πà‡∏° Error Handler
        function loadNews() {
            const newsList = document.getElementById('newsList');
            if(!newsList) return;
            
            // ‡πÉ‡∏ä‡πâ query ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ sort ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
            const q = query(collection(db, "news"), orderBy("created_at", "desc"), limit(5));
            
            onSnapshot(q, (snap) => {
                newsList.innerHTML = "";
                if (snap.empty) {
                    newsList.innerHTML = "<li class='list-group-item text-center py-5 text-muted'>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå -</li>";
                    return;
                }

                let hasNews = false;
                snap.forEach(d => {
                    const data = d.data();
                    const target = data.target || 'all';
                    let isVisible = false;
                    
                    if (currentUserRole === 'admin') isVisible = true;
                    else if (target === 'all') isVisible = true;
                    else if (target === currentUserRole) isVisible = true;
                    else if (target === 'teacher_all' && isTeacher(currentUserRole)) isVisible = true;

                    if (isVisible) {
                        hasNews = true;
                        let adminBtn = currentUserRole === 'admin' ? `<button class="btn btn-action btn-light text-danger btn-sm" onclick="deleteItem('news', '${d.id}')" title="‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®"><i class="fa-solid fa-trash"></i></button>` : "";
                        let targetBadge = currentUserRole === 'admin' ? `<span class="target-badge ms-2" style="font-size: 0.65rem;">${target}</span>` : "";
                        const dateStr = data.created_at?.seconds ? new Date(data.created_at.seconds*1000).toLocaleDateString('th-TH', { day: 'numeric', month: 'numeric', year: '2-digit' }) : '-';

                        newsList.innerHTML += `<li class="list-group-item py-3"><div class="d-flex justify-content-between align-items-start"><div class="flex-grow-1 pe-2" style="min-width: 0;"><div class="d-flex align-items-center flex-wrap mb-1"><span class="fw-bold text-dark" style="font-size: 0.95rem;">${data.topic || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'}</span>${targetBadge}</div><p class="text-muted small mb-0" style="white-space: pre-line; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; text-align: left;">${data.detail || '-'}</p></div><div class="d-flex flex-column align-items-end justify-content-start ps-1" style="min-width: 75px;"><small class="text-muted mb-2" style="font-size: 0.75rem; white-space: nowrap;">${dateStr}</small>${adminBtn}</div></div></li>`;
                    }
                });
                
                if (!hasNews) newsList.innerHTML = "<li class='list-group-item text-center py-5 text-muted'>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì -</li>";
            }, (error) => {
                console.error("News Load Error:", error);
                let errorMsg = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏î‡πâ";
                if (error.code === 'permission-denied') errorMsg = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß (Check Firestore Rules)";
                if (error.code === 'failed-precondition') errorMsg = "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Index (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á Admin)";
                
                newsList.innerHTML = `<li class='list-group-item text-center py-4 text-danger'><i class="fa-solid fa-triangle-exclamation mb-2"></i><br>${errorMsg}</li>`;
            });
        }

        // üî•üî•üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Update Status ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î üî•üî•üî•
        window.updateStatus = async (collectionName, docId, currentStatus) => {
            let options = {};
            if(collectionName === 'repair_requests') options = { 'pending': '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', 'in_progress': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', 'completed': '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' };
            else if (collectionName === 'vehicle_requests') options = { 'pending': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á)', 'rejected': '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'completed': '‡∏à‡∏ö‡∏á‡∏≤‡∏ô' };
            else if (collectionName === 'outside_requests') options = { 'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'completed': '‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'returned': '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß' };
            else options = { 'pending': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'rejected': '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };

            const { value: newStatus } = await Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', input: 'select', inputOptions: options, inputValue: currentStatus,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#0d6efd'
            });

            if (newStatus && newStatus !== currentStatus) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
                try {
                    const docRef = doc(db, collectionName, docId);
                    
                    // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ñ‡∏ô‡πÅ‡∏à‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£");
                    const data = docSnap.data();
                    
                    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    await updateDoc(docRef, { status: newStatus });
                    
                    // 3. ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡∏´‡∏≤‡∏Ñ‡∏ô‡πÅ‡∏à‡πâ‡∏á (‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
                    const reporterEmail = data.reporterEmail || data.email || data.requester_email;
                    if (reporterEmail) {
                        let taskTitle = data.equipment || data.destination || data.topic || "‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£";
                        let statusText = options[newStatus] || newStatus;
                        
                        let headerColor = '#6c757d'; 
                        let iconEmoji = 'üîî';
                        
                        if (['approved', 'completed', 'returned', 'success'].includes(newStatus)) {
                            headerColor = '#198754'; iconEmoji = '‚úÖ';
                        } else if (['rejected', 'cancelled'].includes(newStatus)) {
                            headerColor = '#dc3545'; iconEmoji = '‚ùå';
                        } else if (['in_progress', 'ongoing'].includes(newStatus)) {
                            headerColor = '#0dcaf0'; iconEmoji = '‚è≥';
                        }

                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        let detailsListHtml = '';
                        const details = [];
                        if (data.location) details.push(`<strong>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${data.location}`);
                        if (data.destination) details.push(`<strong>üìç ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á:</strong> ${data.destination}`);
                        if (data.reason) details.push(`<strong>üìù ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${data.reason}`);
                        if (data.detail) details.push(`<strong>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${data.detail}`);
                        if (data.use_date) details.push(`<strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${data.use_date}`);
                        if (data.out_date) details.push(`<strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${data.out_date}`);
                        if (data.start_date && data.end_date) details.push(`<strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${data.start_date} ‡∏ñ‡∏∂‡∏á ${data.end_date}`);
                        if (data.start_time && data.end_time) details.push(`<strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${data.start_time} - ${data.end_time}`);
                        if (data.leave_type) details.push(`<strong>üìå ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${data.leave_type}`);
                        
                        if (details.length > 0) {
                            detailsListHtml = `
                                <div style="background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #eee;">
                                    <p style="margin: 0 0 10px 0; font-weight: bold; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠</p>
                                    <ul style="margin: 0; padding-left: 20px; color: #444; font-size: 14px; line-height: 1.6;">
                                        ${details.map(d => `<li style="margin-bottom: 5px;">${d}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }

                        await addDoc(collection(db, "mail"), {
                            to: reporterEmail,
                            message: {
                                subject: `${iconEmoji} ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${taskTitle}`,
                                html: `
                                    <div style="font-family: 'Sarabun', sans-serif; max-width: 500px; margin: auto; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                                        <div style="background-color: ${headerColor}; color: white; padding: 25px; text-align: center;">
                                            <h2 style="margin: 0; font-size: 24px; font-weight: bold;">${iconEmoji} ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h2>
                                        </div>
                                        
                                        <div style="padding: 30px; background-color: #ffffff;">
                                            <p style="font-size: 16px; color: #333; margin-bottom: 20px;">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <strong>${data.reporterName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£'}</strong>,</p>
                                            
                                            <p style="font-size: 16px; color: #555; line-height: 1.6;">
                                                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <strong>"${taskTitle}"</strong> ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                                            </p>
                                            
                                            ${detailsListHtml}
                                            
                                            <div style="background-color: #f8f9fa; border-left: 6px solid ${headerColor}; padding: 20px; margin: 25px 0; border-radius: 4px;">
                                                <p style="margin: 0; font-size: 14px; color: #777;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                                                <p style="margin: 5px 0 0 0; font-size: 20px; color: ${headerColor}; font-weight: bold;">
                                                    ${statusText}
                                                </p>
                                            </div>

                                            <p style="font-size: 14px; color: #777; text-align: center; margin-top: 30px;">
                                                ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö School Hub
                                            </p>
                                            
                                            <div style="text-align: center; margin-top: 20px;">
                                                <a href="#" style="background-color: ${headerColor}; color: white; padding: 12px 30px; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 16px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                                            </div>
                                        </div>
                                        
                                        <div style="background-color: #f1f3f5; padding: 15px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #eee;">
                                            School Hub Management System ¬© 2024
                                        </div>
                                    </div>
                                `
                            }
                        });
                    }

                    Swal.fire({ icon: 'success', title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', text: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#0d6efd' });
                } catch (e) { 
                    console.error(e); 
                    Swal.fire('Error', e.message, 'error'); 
                }
            }
        };

        window.openUserManagement = () => { let userModal = new bootstrap.Modal(document.getElementById('userManageModal')); userModal.show(); loadUsers(); };
        function loadUsers() {
            const tbody = document.getElementById('userTableBody');
            onSnapshot(query(collection(db, "users"), orderBy("email")), (snapshot) => {
                tbody.innerHTML = "";
                if(snapshot.empty) { tbody.innerHTML = "<tr><td colspan='4' class='text-center py-4 text-muted'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</td></tr>"; return; }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    tbody.innerHTML += `<tr class="user-row"><td class="ps-4 fw-medium">${data.firstName || '-'}</td><td class="text-muted">${data.email}</td><td><span class="badge bg-light text-dark border">${getThaiRoleName(data.role)}</span></td><td class="text-end pe-4"><button class="btn btn-action btn-light text-primary me-1" onclick="editUserRole('${doc.id}', '${data.role}', '${data.email}')"><i class="fa-solid fa-pen"></i></button><button class="btn btn-action btn-light text-danger" onclick="deleteUser('${doc.id}', '${data.email}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
                });
            });
        }
        window.editUserRole = async (uid, currentRole, email) => {
            const { value: newRole } = await Swal.fire({
                title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á`, html: `<p class="text-muted mb-3">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${email}</p>`, input: 'select',
                inputOptions: { 'teacher_basic': '‡∏Ñ‡∏£‡∏π (‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)', 'teacher_kindergarten': '‡∏Ñ‡∏£‡∏π (‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•)', 'technician': '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', 'transport': '‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞', 'personnel': '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', 'security_guard': '‡∏£‡∏õ‡∏†.', 'admin': 'Admin' },
                inputValue: currentRole, showCancelButton: true
            });
            if (newRole && newRole !== currentRole) { await updateDoc(doc(db, "users", uid), { role: newRole }); Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success'); }
        };
        window.deleteUser = async (uid, email) => { if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${email}?`)) { try { await deleteDoc(doc(db, "users", uid)); Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success'); } catch(e) { Swal.fire('Error', e.message, 'error'); } } };
        window.deleteItem = async (col, id) => { Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢', confirmButtonColor: '#dc3545' }).then(async (result) => { if (result.isConfirmed) await deleteDoc(doc(db, col, id)); }); };
        
        function showSec(list) { list.forEach(id => { const el = document.getElementById(id + 'Section'); if(el) el.style.display = 'block'; }); }
        function hideAllSections() { ['news', 'teacher', 'technician', 'transport', 'personnel', 'admin', 'security'].forEach(s => { const el = document.getElementById(s + 'Section'); if(el) el.style.display = 'none'; }); }

        function loadQuickRepairs() { loadGenericTable('repair_requests', 'quickRepairTable', d => `<td class="fw-medium ps-4">${d.equipment||'-'}</td><td class="small text-muted">${d.location||'-'}</td><td><span class="badge ${getStatusClass(d.status)} rounded-pill">${getStatusLabel(d.status)}</span></td>`); }
        function loadQuickLeaves() { loadGenericTable('leave_requests', 'quickLeaveTable', d => `<td class="fw-medium ps-4">${d.leave_type||'-'}</td><td class="small text-muted">${d.requester_name||'-'}</td><td><span class="badge ${getStatusClass(d.status)} rounded-pill">${getStatusLabel(d.status)}</span></td>`); }
        function loadQuickTransport() { 
            loadGenericTable('vehicle_requests', 'quickTransportTable', d => {
                let driverHtml = '<span class="text-muted small">-</span>';
                if(d.driver_name && d.driver_name !== '-') {
                     driverHtml = `<span class="text-primary small fw-bold"><i class="fa-solid fa-id-card me-1"></i>${d.driver_name}</span>`;
                }
                return `
                    <td class="fw-medium ps-4">${d.use_date||'-'}</td>
                    <td class="small text-muted">${d.destination||'-'}</td>
                    <td>${driverHtml}</td>
                    <td><span class="badge ${getStatusClass(d.status)} rounded-pill">${getStatusLabel(d.status)}</span></td>
                `;
            }); 
        }
        function loadQuickOutside() { 
            loadGenericTable('outside_requests', 'quickOutsideTable', d => `<td class="fw-medium ps-4">${d.date||'-'}</td><td class="small text-muted">${d.requester_name||'-'}</td><td class="small">${d.start_time} - ${d.end_time}</td><td><span class="badge ${getStatusClass(d.status)} rounded-pill">${getStatusLabel(d.status)}</span></td>`); 
        }

        function loadGenericTable(col, elemId, rowHtml) {
            const tbody = document.getElementById(elemId);
            if(!tbody) return;
            let q = (currentUserRole === 'admin' || currentUserRole === 'security_guard') ? query(collection(db, col), orderBy("created_at", "desc"), limit(5)) : query(collection(db, col), where("status", "==", "pending"), limit(5));
            
            onSnapshot(q, (snap) => {
                tbody.innerHTML = snap.empty ? "<tr><td colspan='5' class='text-center py-4 text-muted small'>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -</td></tr>" : "";
                snap.forEach(d => {
                    const data = d.data();
                    let canEdit = (currentUserRole === 'admin' || (currentUserRole === 'security_guard' && col === 'outside_requests'));
                    let actionHtml = canEdit ? `<td class="text-end pe-4"><button class="btn btn-action btn-light text-primary" onclick="updateStatus('${col}', '${d.id}', '${data.status}')"><i class="fa-solid fa-pen"></i></button></td>` : "";
                    tbody.innerHTML += `<tr>${rowHtml(data)}${actionHtml}</tr>`;
                });
            });
        }
        function getStatusClass(status) { return { 'pending': 'bg-warning text-dark', 'approved': 'bg-success', 'in_progress': 'bg-info text-dark', 'completed': 'bg-primary', 'rejected': 'bg-danger' }[status] || 'bg-secondary'; }
        function getStatusLabel(status) { return { 'pending': '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'in_progress': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', 'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'rejected': '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' }[status] || status; }

        document.getElementById('btnLogout').addEventListener('click', () => {
             Swal.fire({ title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', icon: 'question', showCancelButton: true, confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢', confirmButtonColor: '#dc3545' }).then((result) => { if (result.isConfirmed) signOut(auth).then(() => window.location.href = "index.html"); });
        });

        document.getElementById('searchUser').addEventListener('keyup', function() {
            const value = this.value.toLowerCase();
            document.querySelectorAll('.user-row').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none'; });
        });
    </script>
</body>
</html>