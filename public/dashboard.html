<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - School Hub</title>
    
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-bg: #f8f9fa;
            --card-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.15), 0 5px 10px -3px rgba(0, 0, 0, 0.1);
            --card-hover-shadow: 0 20px 35px -5px rgba(0, 0, 0, 0.2), 0 10px 15px -3px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: rgba(240, 242, 245, 0.85); 
            color: #1f2937;
            position: relative;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: url('image_10.png'); 
            background-size: cover; background-position: center; background-repeat: no-repeat;
            filter: blur(8px);
            transform: scale(1.02);
        }

        /* Snow Effect */
        .snowflake {
            position: fixed; top: -10px; color: #fff; user-select: none; z-index: 9999;
            pointer-events: none; animation-name: fall; animation-timing-function: linear;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }
        @keyframes fall { to { transform: translateY(105vh); } }

        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease-out, visibility 0.5s; backdrop-filter: blur(10px);
        }
        #loadingScreen.hidden { opacity: 0; visibility: hidden; }

        .navbar { 
            background-color: rgba(255, 255, 255, 0.95) !important; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
            padding: 0.8rem 0; 
            backdrop-filter: blur(10px);
        }
        .navbar-brand { 
            color: var(--primary-color) !important; 
            font-weight: 800; 
            font-size: 1.35rem; 
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
        }

        .navbar-logo { width: 40px; height: 40px; object-fit: contain; margin-right: 10px; }

        /* Profile Nav Item */
        .user-info { font-size: 0.9rem; color: #4b5563; background: #f3f4f6; border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; }
        .user-info:hover { background: #eef2ff; border-color: var(--primary-color); }
        .profile-img-container {
            width: 40px; height: 40px; border-radius: 50%; overflow: hidden;
            margin-right: 10px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative; background-color: #e0e7ff;
            display: flex; justify-content: center; align-items: center;
        }
        .profile-img { width: 100%; height: 100%; object-fit: cover; }
        .profile-placeholder { font-size: 1.2rem; color: var(--primary-color); }

        /* Main Dashboard Cards */
        .card { 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            border-radius: 16px; 
            box-shadow: var(--card-shadow); 
            background-color: #ffffff; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card-menu {
            cursor: pointer; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 1.5rem;
            background: white; border: 1px solid rgba(0,0,0,0.03); 
            position: relative; overflow: hidden;
        }
        .card-menu:hover { 
            transform: translateY(-8px); 
            box-shadow: var(--card-hover-shadow); 
            border-color: transparent; z-index: 1;
        }
        .card-menu i { font-size: 2.8rem; margin-bottom: 1rem; transition: transform 0.3s ease; }
        .card-menu:hover i { transform: scale(1.15) rotate(-5deg); }
        .card-menu h6 { font-weight: 700; margin: 0; color: #374151; font-size: 1rem; }

        .section-title { 
            display: inline-flex; align-items: center; 
            font-weight: 800; color: #111827; margin: 2.5rem 0 1.5rem 0; font-size: 1.25rem;
            background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 50px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); backdrop-filter: blur(5px);
        }
        .section-title::before { content: ''; display: block; width: 6px; height: 24px; background: var(--primary-color); margin-right: 12px; border-radius: 4px; }

        /* Calendar Styles */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.85rem; font-weight: bold; color: #6b7280; margin-bottom: 8px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; } 
        .calendar-day { 
            height: 45px; display: flex; align-items: center; justify-content: center; flex-direction: column;
            border-radius: 10px; font-size: 0.95rem; cursor: pointer; transition: all 0.2s;
            border: 1px solid #f3f4f6; position: relative; font-weight: 500;
        }
        .calendar-day:hover:not(.empty) { background-color: #eff6ff; transform: scale(1.1); z-index: 10; border-color: var(--primary-color); }
        .calendar-day.today { background-color: var(--primary-color); color: white; font-weight: 800; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.4); border: none; }
        .calendar-day.empty { cursor: default; border: none; }
        .calendar-day.has-event { font-weight: 800; color: #0d6efd; background-color: #f0f7ff; border-color: #cce5ff; }
        .event-dot { width: 6px; height: 6px; border-radius: 50%; position: absolute; bottom: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .calendar-day.today .event-dot { border: 1px solid white; }

        /* News List */
        #newsList .list-group-item { border: none; border-bottom: 1px solid #f0f0f0; padding: 1.2rem 1.5rem; transition: background 0.2s; }
        #newsList .list-group-item:hover { background-color: #fafafa; }
        #newsList .list-group-item:last-child { border-bottom: none; }

        .btn-action { width: 34px; height: 34px; padding: 0; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .target-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: #eef2ff; color: #4f46e5; font-weight: 700; margin-left: 8px; border: 1px solid #e0e7ff; }
        
        /* Menu Icons */
        .menu-icon-primary { color: #2563eb; background: #eff6ff; padding: 14px; border-radius: 16px; }
        .menu-icon-warning { color: #d97706; background: #fffbeb; padding: 14px; border-radius: 16px; }
        .menu-icon-success { color: #059669; background: #ecfdf5; padding: 14px; border-radius: 16px; }
        .menu-icon-purple { color: #7c3aed; background: #f5f3ff; padding: 14px; border-radius: 16px; }
        .menu-icon-info { color: #0891b2; background: #ecfeff; padding: 14px; border-radius: 16px; }
        .menu-icon-danger { color: #dc2626; background: #fef2f2; padding: 14px; border-radius: 16px; }
        .menu-icon-dark { color: #374151; background: #f3f4f6; padding: 14px; border-radius: 16px; }
        .menu-icon-ai { color: #db2777; background: #fdf2f8; padding: 14px; border-radius: 16px; }

        /* üî• Profile Page Styles (New & Improved) */
        #profilePage { display: none; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .profile-header {
            background: linear-gradient(135deg, var(--primary-color), #6366f1);
            height: 180px; border-radius: 0 0 30px 30px; position: relative;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2); margin-bottom: 70px;
        }
        .profile-avatar-wrapper {
            position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; overflow: hidden;
        }
        .profile-avatar-lg { width: 100%; height: 100%; object-fit: cover; }
        .btn-edit-avatar {
            position: absolute; bottom: 0; right: 0; width: 35px; height: 35px;
            background: var(--primary-color); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            border: 2px solid white; transition: 0.2s;
        }
        .btn-edit-avatar:hover { background: #0b5ed7; transform: scale(1.1); }
        
        .profile-info-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .profile-label { font-size: 0.85rem; color: #6b7280; font-weight: 500; margin-bottom: 4px; }
        .profile-value { font-size: 1rem; color: #111827; font-weight: 600; margin-bottom: 16px; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; }
        .profile-value:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .form-control-plaintext { font-weight: 600; color: #111827; padding: 0; margin-bottom: 16px; border-bottom: 1px solid #f3f4f6; }
        .form-control-plaintext:focus { outline: none; border-bottom-color: var(--primary-color); }
        .form-control-plaintext[readonly] { border-bottom: 1px solid transparent; }

        /* Notification Popup Style */
        .notification-popup {
            position: fixed; bottom: 30px; right: 30px; background: white;
            border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            padding: 20px; width: 340px; z-index: 9999; display: none;
            border-left: 6px solid #ef4444; animation: slideInUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Sarabun', sans-serif;
        }
        @keyframes slideInUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notif-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .notif-title { font-weight: 800; font-size: 1.1rem; color: #1f2937; display: flex; align-items: center; gap: 8px; }
        .notif-close { cursor: pointer; color: #9ca3af; transition: 0.2s; font-size: 1.2rem; }
        .notif-close:hover { color: #4b5563; transform: scale(1.1); }
        .btn-check-notif { width: 100%; border-radius: 10px; font-size: 0.95rem; font-weight: 700; background: linear-gradient(to right, #ef4444, #f87171); border: none; padding: 10px; color: white; }
        .notif-item { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #f3f4f6; }

        #academicSection, #teacherSection, #technicianSection, #transportSection, #personnelSection, #adminSection, #newsSection, #securitySection, #studentSection, #healthSection { display: none; }
        .admin-only { display: none; }

        @media (max-width: 767.98px) {
            .container { padding-left: 16px; padding-right: 16px; }
            .profile-header { height: 140px; margin-bottom: 60px; }
            .profile-avatar-wrapper { width: 100px; height: 100px; bottom: -50px; }
            .section-title { font-size: 1.1rem; }
            .notification-popup { left: 15px; right: 15px; bottom: 15px; width: auto; }
        }
    </style>
</head>
<body>

    <div id="loadingScreen">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h6 class="text-muted fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h6>
    </div>

    <!-- Notification Popup -->
    <div id="notificationPopup" class="notification-popup">
        <div class="notif-header">
            <div class="notif-title"><i class="fa-solid fa-bell text-danger"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
            <span id="notifTotalCount" class="badge bg-danger rounded-pill">0</span>
            <i class="fa-solid fa-xmark notif-close ms-2" onclick="closeNotification()"></i>
        </div>
        <div id="notifContent" class="mb-3 small text-muted"></div>
        <button class="btn btn-check-notif" onclick="closeNotification()">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö <i class="fa-solid fa-check ms-1"></i></button>
    </div>

    <input type="file" id="profileUploadInput" accept="image/*" style="display: none;" onchange="handleProfileUpload(this)">

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <img src="icon.png" alt="Logo" class="navbar-logo">
                School Hub
            </a>
            <div class="d-flex align-items-center gap-3">
                <!-- User Profile Trigger -->
                <div class="user-info d-none d-md-flex align-items-center bg-white px-3 py-2 rounded-pill shadow-sm border" onclick="openProfilePage()">
                    <div class="profile-img-container">
                        <img id="navUserAvatar" src="" class="profile-img d-none">
                        <i id="navUserAvatarPlaceholder" class="fa-regular fa-circle-user profile-placeholder"></i>
                    </div>
                    <div>
                        <span id="userEmail" class="fw-bold d-block lh-1 text-dark">...</span>
                        <small id="userRoleBadge" class="text-muted" style="font-size: 0.75rem;">...</small>
                    </div>
                </div>
                <button id="btnLogout" class="btn btn-danger btn-sm rounded-circle shadow-sm" style="width: 38px; height: 38px;" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4 mb-5">
        
        <!-- üî• Wrap Main Dashboard Content -->
        <div id="mainDashboard">
            
            <div id="newsSection" class="mb-5">
                <div class="row g-3 g-lg-4">
                    <div class="col-lg-7 order-2 order-lg-1">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-bottom-0">
                                <h5 class="m-0 fw-bold text-dark fs-5"><i class="fa-solid fa-bullhorn text-primary me-2"></i> ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå</h5>
                                <div class="d-flex align-items-center">
                                    <button id="btnAddNews" class="btn btn-sm btn-primary rounded-pill d-none me-2 shadow-sm" onclick="window.location.href='admin_news.html'"><i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πà‡∏≤‡∏ß</button>
                                    <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-2">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <ul id="newsList" class="list-group list-group-flush">
                                    <li class="list-group-item text-center py-5 text-muted"><div class="spinner-border spinner-border-sm text-secondary mb-2"></div><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...</div></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5 order-1 order-lg-2">
                        <div class="card h-100">
                            <div class="card-header bg-white border-0 py-3">
                                <div class="calendar-header">
                                    <h6 class="m-0 fw-bold text-dark d-flex align-items-center fs-5"><i class="fa-regular fa-calendar-days text-success me-2"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h6>
                                    <div class="d-flex align-items-center bg-light rounded-pill p-1">
                                        <button class="btn btn-sm btn-white rounded-circle shadow-sm me-1" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                                        <span id="calendarMonthYear" class="fw-bold text-dark small px-3" style="min-width: 100px; text-align: center;">...</span>
                                        <button class="btn btn-sm btn-white rounded-circle shadow-sm ms-1" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                                    </div>
                                    <button id="btnAddEvent" class="btn btn-sm btn-primary ms-2 rounded-circle d-none shadow-sm" onclick="openAddEventModal()"><i class="fa-solid fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="card-body pt-0">
                                <div class="calendar-weekdays"><div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div></div>
                                <div id="calendarDays" class="calendar-days"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sections -->
            <div id="studentSection">
                <div class="section-title text-info">‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</div>
                <div class="row g-3 g-md-4">
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='canteen_dashboard.html'"><i class="fa-solid fa-wallet menu-icon-primary"></i><h6>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô / ‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='homework_dashboard.html'"><i class="fa-solid fa-clipboard-list menu-icon-primary"></i><h6>‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô / ‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-book-bookmark menu-icon-purple"></i><h6>‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (E-Book)</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏°‡∏£‡∏° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-users-rectangle menu-icon-warning"></i><h6>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏°‡∏£‡∏° / ‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-calendar-check menu-icon-success"></i><h6>‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-hand-holding-heart menu-icon-success"></i><h6>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô EQ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-brain menu-icon-info"></i><h6>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô EQ</h6></div></div>
                </div>
            </div>

            <div id="healthSection">
            <div class="section-title text-danger">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÉ‡∏à</div>
            <div class="row g-3 g-md-4">
                <!-- New 1: Calorie Counter -->
                <div class="col-6 col-md-3">
                    <div class="card card-menu" onclick="window.location.href='calorie_counter.html'">
                        <i class="fa-solid fa-camera-retro menu-icon-success"></i>
                        <h6>‡∏ô‡∏±‡∏ö‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û</h6>
                    </div>
                </div>
                <!-- New 2: Air Quality -->
                <div class="col-6 col-md-3">
                    <div class="card card-menu" onclick="window.location.href='pm25_dashboard.html'">
                        <i class="fa-solid fa-smog menu-icon-secondary" style="background-color: #e5e7eb; color: #4b5563;"></i>
                        <h6>‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô PM2.5</h6>
                    </div>
                </div>
                <!-- New 3: Stress Assessment -->
                <div class="col-6 col-md-3">
                    <div class="card card-menu" onclick="window.location.href='stress_assessment.html'">
                        <i class="fa-solid fa-face-tired menu-icon-warning"></i>
                        <h6>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</h6>
                    </div>
                </div>
                <!-- New 4: Depression Assessment -->
                <div class="col-6 col-md-3">
                    <div class="card card-menu" onclick="window.location.href='depression_assessment.html'">
                        <i class="fa-solid fa-cloud-showers-heavy menu-icon-dark"></i>
                        <h6>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤</h6>
                    </div>
                </div>
            </div>
        </div>

            <div id="academicSection">
                <div class="section-title text-primary">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏£‡∏π)</div>
                <div class="row g-3 g-md-4">
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='learning_record.html'"><i class="fa-solid fa-book-open menu-icon-primary"></i><h6>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='ai_scheduler.html'"><i class="fa-solid fa-wand-magic-sparkles menu-icon-ai"></i><h6>‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô AI</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-house-user menu-icon-success"></i><h6>‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-file-circle-check menu-icon-purple"></i><h6>‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡∏∑‡πà‡∏°‡∏ô‡∏°/‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-mug-hot menu-icon-warning"></i><h6>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡∏∑‡πà‡∏°‡∏ô‡∏°/‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-syringe menu-icon-success"></i><h6>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-heart-pulse menu-icon-danger"></i><h6>‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="Swal.fire('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤', 'info')"><i class="fa-solid fa-building-user menu-icon-primary"></i><h6>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h6></div></div>
                </div>
            </div>

            <div id="teacherSection">
                <div class="section-title">‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</div>
                <div class="row g-3 g-md-4">
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='my_history.html'"><i class="fa-solid fa-clock-rotate-left menu-icon-primary"></i><h6>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='repair_form.html'"><i class="fa-solid fa-screwdriver-wrench menu-icon-warning"></i><h6>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='vehicle_form.html'"><i class="fa-solid fa-car-side menu-icon-success"></i><h6>‡πÄ‡∏ö‡∏¥‡∏Å‡∏£‡∏ñ</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='leave_form.html'"><i class="fa-solid fa-file-medical menu-icon-purple"></i><h6>‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='outside_form.html'"><i class="fa-solid fa-person-walking-luggage menu-icon-info"></i><h6>‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='manpower_form.html'"><i class="fa-solid fa-users menu-icon-danger"></i><h6>‡∏Ç‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='document_registry.html'"><i class="fa-solid fa-chalkboard-user menu-icon-dark"></i><h6>‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='ai_summary.html'"><i class="fa-solid fa-robot menu-icon-ai"></i><h6>‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° AI</h6></div></div>
                </div>
            </div>

            <!-- Role Specific Cards -->
            <div id="technicianSection"><div class="section-title text-warning">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</div><div class="card"><div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div><div class="table-responsive"><table class="table table-hover mb-0"><tbody id="quickRepairTable"></tbody></table></div></div></div>
            <div id="transportSection"><div class="section-title text-success">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</div><div class="card"><div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ñ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div><div class="table-responsive"><table class="table table-hover mb-0"><tbody id="quickTransportTable"></tbody></table></div></div></div>
            <div id="personnelSection"><div class="section-title" style="color: #8b5cf6;">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div><div class="card"><div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div><div class="table-responsive"><table class="table table-hover mb-0"><tbody id="quickLeaveTable"></tbody></table></div></div></div>
            <div id="securitySection"><div class="section-title" style="color: #6c757d;">‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏£‡∏õ‡∏†.)</div><div class="card"><div class="card-header bg-white py-3 border-bottom"><h6 class="m-0 fw-bold text-dark">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6></div><div class="table-responsive"><table class="table table-hover mb-0"><tbody id="quickOutsideTable"></tbody></table></div></div></div>

            <div id="adminSection">
                <div class="section-title text-danger">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</div>
                <div class="row g-2 g-md-3">
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='admin_register.html'"><i class="fa-solid fa-user-plus menu-icon-danger"></i><h6>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='admin_news.html'"><i class="fa-solid fa-bullhorn menu-icon-primary"></i><h6>‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="window.location.href='admin_report.html'"><i class="fa-solid fa-chart-pie menu-icon-dark"></i><h6>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu" onclick="openUserManagement()"><i class="fa-solid fa-users-gear menu-icon-info"></i><h6>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h6></div></div>
                    <div class="col-6 col-md-3"><div class="card card-menu bg-danger text-white" onclick="resetAllUsersData()"><i class="fa-solid fa-radiation menu-icon-danger bg-white text-danger"></i><h6 class="text-white">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users (Reset)</h6></div></div>
                </div>
            </div>
        </div>

        <!-- üî•üî•üî• ‡∏´‡∏ô‡πâ‡∏≤ Profile Page ‡πÉ‡∏´‡∏°‡πà (Full Page Effect) üî•üî•üî• -->
        <div id="profilePage">
            <button class="btn btn-light rounded-pill shadow-sm mb-3 fw-bold text-primary" onclick="closeProfilePage()">
                <i class="fa-solid fa-chevron-left me-2"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>

            <div class="profile-header">
                <div class="profile-avatar-wrapper">
                    <img id="pageProfileImg" src="" class="profile-avatar-lg">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ (‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á) -->
                    <div id="btnEditAvatar" class="btn-edit-avatar d-none" onclick="document.getElementById('profileUploadInput').click()">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </div>
            </div>

            <div class="text-center mb-4">
                <h3 class="fw-bold mb-1" id="pageProfileName">...</h3>
                <span id="pageProfileRole" class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3">...</span>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="profile-info-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="fw-bold m-0"><i class="fa-regular fa-id-card me-2 text-primary"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h5>
                            <div id="profileActionBtns">
                                <button id="btnEditProfile" class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-bold d-none" onclick="toggleEditMode()">
                                    <i class="fa-solid fa-pen me-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                <button id="btnSaveProfile" class="btn btn-sm btn-primary rounded-pill px-3 fw-bold d-none" onclick="saveProfileChanges()">
                                    <i class="fa-solid fa-save me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </button>
                            </div>
                        </div>

                        <form id="profileForm">
                            <div class="mb-3">
                                <label class="profile-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <div class="profile-value" id="viewName">...</div>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="profile-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                                    <input type="text" id="editNickname" class="form-control form-control-plaintext" readonly>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="profile-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                    <input type="tel" id="editPhone" class="form-control form-control-plaintext" readonly>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="profile-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <div class="profile-value" id="viewEmail">...</div>
                            </div>
                            <div class="mb-3">
                                <label class="profile-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                <input type="text" id="editAddress" class="form-control form-control-plaintext" readonly placeholder="-">
                            </div>
                            <div class="mb-3">
                                <label class="profile-label text-danger">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß/‡πÅ‡∏û‡πâ‡∏¢‡∏≤)</label>
                                <textarea id="editHealth" class="form-control form-control-plaintext" readonly rows="2" placeholder="-"></textarea>
                            </div>
                            
                            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Role -->
                            <div id="roleSpecificInfo" class="mt-4 pt-3 border-top">
                                <!-- JS ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- User Management Modal (Admin View List) -->
    <div class="modal fade" id="userManageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-white border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold fs-5 text-dark"><i class="fa-solid fa-users-gear text-primary me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3 p-lg-4">
                    <div class="input-group mb-3 shadow-sm rounded-pill overflow-hidden border">
                        <span class="input-group-text bg-white border-0 ps-3"><i class="fa-solid fa-search text-muted"></i></span>
                        <input type="text" id="searchUser" class="form-control border-0 py-2" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•...">
                    </div>
                    <div class="table-responsive rounded-3 border">
                        <table class="table table-hover mb-0 align-middle"><thead class="bg-light"><tr><th class="py-3 ps-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th class="py-3">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th class="py-3">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th class="py-3 text-end pe-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="userTableBody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, onSnapshot, where, deleteDoc, updateDoc, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUserRole = "";
        let currentStudentClass = "";
        let currentDate = new Date();
        let currentEvents = [];
        let currentUserData = null;
        let viewingProfileUid = null; 

        // Init
        document.addEventListener('DOMContentLoaded', () => { /* Snow effect (Optional) */ });
        setTimeout(() => { const l=document.getElementById('loadingScreen'); if(l) l.classList.add('hidden'); }, 3000);

        // Auth & Main Logic
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (!user.emailVerified) { Swal.fire('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô', '', 'warning').then(() => signOut(auth)); return; }
                const userDocRef = doc(db, "users", user.uid);
                onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        currentUserData = d;
                        currentUserRole = d.role || 'guest';
                        currentStudentClass = d.studentClass || "";
                        
                        document.getElementById('userEmail').innerText = d.firstName || user.email;
                        document.getElementById('userRoleBadge').innerText = getThaiRoleName(currentUserRole);
                        if(d.profileImage) {
                            document.getElementById('navUserAvatar').src = d.profileImage;
                            document.getElementById('navUserAvatar').classList.remove('d-none');
                            document.getElementById('navUserAvatarPlaceholder').classList.add('d-none');
                        }

                        hideAllSections();
                        if (currentUserRole === 'student') showSec(['news', 'student', 'health']);
                        else if (isTeacher(currentUserRole)) { showSec(['news', 'teacher', 'health']); document.getElementById('academicSection').style.display='block'; }
                        else if (currentUserRole === 'admin' || currentUserRole === 'executive') { 
                            showSec(['admin', 'teacher', 'news', 'personnel', 'technician', 'transport', 'security', 'student', 'health']);
                            document.getElementById('academicSection').style.display='block';
                            document.querySelectorAll('.admin-only').forEach(el=>el.style.display='table-cell');
                            document.getElementById('btnAddNews').classList.remove('d-none');
                            document.getElementById('btnAddEvent').classList.remove('d-none');
                            loadQuickRepairs(); loadQuickLeaves(); loadQuickTransport(); loadQuickOutside();
                        } else { showSec(['news', 'teacher', 'health']); }

                        loadNews(); loadEventsAndRender(); listenToNotifications();
                    }
                });
            } else { window.location.href = "index.html"; }
        });

        // üî•üî•üî• Profile Page Logic (Unified) üî•üî•üî•
        window.openProfilePage = async (targetUid) => {
            const uid = targetUid || auth.currentUser.uid;
            viewingProfileUid = uid;
            
            Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', didOpen: ()=>Swal.showLoading()});

            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (!docSnap.exists()) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
                const data = docSnap.data();
                const isMe = (uid === auth.currentUser.uid);

                // UI Elements
                document.getElementById('pageProfileImg').src = data.profileImage || 'https://via.placeholder.com/150';
                document.getElementById('pageProfileName').innerText = `${data.prefix||''} ${data.firstName} ${data.lastName||''}`;
                document.getElementById('pageProfileRole').innerText = getThaiRoleName(data.role);
                
                document.getElementById('viewName').innerText = `${data.prefix||''} ${data.firstName} ${data.lastName||''}`;
                document.getElementById('viewEmail').innerText = data.email;
                
                setProfileInput('editNickname', data.nickname);
                setProfileInput('editPhone', data.phoneNumber);
                setProfileInput('editAddress', data.address);
                setProfileInput('editHealth', data.healthInfo);

                // Role Info
                let roleHtml = '';
                if(data.role === 'student') roleHtml = `<div class="mb-2"><small class="text-muted">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</small> <b>${data.studentId||'-'}</b></div><div class="mb-2"><small class="text-muted">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</small> <b>${data.studentClass||'-'}</b></div>`;
                else if(data.role.startsWith('teacher')) roleHtml = `<div class="mb-2"><small class="text-muted">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</small> <b>${data.academicPosition||'-'}</b></div><div class="mb-2"><small class="text-muted">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞:</small> <b>${data.department||'-'}</b></div>`;
                document.getElementById('roleSpecificInfo').innerHTML = roleHtml;

                // Edit Controls (Only for owner)
                if(isMe) {
                    document.getElementById('btnEditAvatar').classList.remove('d-none');
                    document.getElementById('btnEditProfile').classList.remove('d-none');
                } else {
                    document.getElementById('btnEditAvatar').classList.add('d-none');
                    document.getElementById('btnEditProfile').classList.add('d-none');
                }
                
                // Reset Mode
                document.getElementById('btnSaveProfile').classList.add('d-none');
                document.querySelectorAll('.form-control-plaintext').forEach(el => el.setAttribute('readonly', true));

                // Switch View
                Swal.close();
                document.getElementById('mainDashboard').style.display = 'none';
                document.getElementById('profilePage').style.display = 'block';
                window.scrollTo(0,0);

                // Close Modal if open
                const modalEl = document.getElementById('userManageModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();

            } catch (e) {
                console.error(e);
                Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            }
        };

        window.closeProfilePage = () => {
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
        };

        window.toggleEditMode = () => {
            const inputs = document.querySelectorAll('.form-control-plaintext');
            const isReadOnly = inputs[0].hasAttribute('readonly');
            
            inputs.forEach(el => {
                if(isReadOnly) el.removeAttribute('readonly');
                else el.setAttribute('readonly', true);
            });

            if(isReadOnly) {
                document.getElementById('btnSaveProfile').classList.remove('d-none');
                document.getElementById('btnEditProfile').innerHTML = '<i class="fa-solid fa-xmark"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                document.getElementById('editNickname').focus();
            } else {
                document.getElementById('btnSaveProfile').classList.add('d-none');
                document.getElementById('btnEditProfile').innerHTML = '<i class="fa-solid fa-pen"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                openProfilePage(viewingProfileUid); // Reset
            }
        };

        window.saveProfileChanges = async () => {
            try {
                Swal.fire({title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: ()=>Swal.showLoading()});
                await updateDoc(doc(db, "users", viewingProfileUid), {
                    nickname: document.getElementById('editNickname').value,
                    phoneNumber: document.getElementById('editPhone').value,
                    address: document.getElementById('editAddress').value,
                    healthInfo: document.getElementById('editHealth').value
                });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                toggleEditMode();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        // Reuse Image Upload
        window.handleProfileUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { Swal.fire('‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô', '‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB', 'warning'); return; }
            
            Swal.fire({ title: '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...', didOpen: () => Swal.showLoading() });
            try {
                const storageRef = ref(storage, `profile_images/${auth.currentUser.uid}_${Date.now()}`);
                const snap = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snap.ref);
                await updateDoc(doc(db, "users", auth.currentUser.uid), { profileImage: url });
                
                document.getElementById('pageProfileImg').src = url;
                document.getElementById('navUserAvatar').src = url;
                Swal.close();
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        };

        function setProfileInput(id, val) { document.getElementById(id).value = val || ''; }

        // User Management (Admin)
        window.openUserManagement = () => { new bootstrap.Modal(document.getElementById('userManageModal')).show(); loadUsers(); };
        function loadUsers() {
            const tbody = document.getElementById('userTableBody');
            onSnapshot(query(collection(db, "users"), orderBy("email")), (snap) => {
                tbody.innerHTML = "";
                snap.forEach(d => {
                    const u = d.data();
                    let viewBtn = `<button class="btn btn-action btn-light text-info me-1" onclick="openProfilePage('${d.id}')" title="‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="fa-solid fa-eye"></i></button>`;
                    let delBtn = `<button class="btn btn-action btn-light text-danger" onclick="deleteUser('${d.id}')"><i class="fa-solid fa-trash"></i></button>`;
                    tbody.innerHTML += `<tr><td class="ps-4">${u.firstName}</td><td>${u.email}</td><td>${getThaiRoleName(u.role)}</td><td class="text-end pe-4">${viewBtn}${delBtn}</td></tr>`;
                });
            });
        }
        window.deleteUser = async (id) => { if(confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')) await deleteDoc(doc(db, "users", id)); };

        // --- Helper Functions ---
        function isTeacher(role) { return ['teacher','teacher_basic','teacher_kindergarten'].includes(role); }
        function getThaiRoleName(role) { const m={'student':'‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','teacher_basic':'‡∏Ñ‡∏£‡∏π','admin':'‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö','staff':'‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'}; return m[role]||role; }
        function hideAllSections() { ['news', 'academic', 'teacher', 'technician', 'transport', 'personnel', 'admin', 'security', 'student', 'health'].forEach(s => { document.getElementById(s+'Section').style.display='none'; }); }
        function showSec(list) { list.forEach(id => { const el=document.getElementById(id+'Section'); if(el) el.style.display='block'; }); }
        window.changeMonth = (s) => { currentDate.setMonth(currentDate.getMonth()+s); loadEventsAndRender(); };
        
        function loadEventsAndRender() {
            try {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayStr = new Date(year, month, 1).toISOString().split('T')[0];
                const lastDayObj = new Date(year, month + 1, 0);
                const lastDayStr = lastDayObj.toISOString().split('T')[0];
                const q = query(collection(db, "events"), where("date", ">=", firstDayStr), where("date", "<=", lastDayStr));
                onSnapshot(q, (snapshot) => {
                    currentEvents = [];
                    snapshot.forEach(doc => { currentEvents.push({ id: doc.id, ...doc.data() }); });
                    renderCalendar();
                }, (error) => { renderCalendar(); });
            } catch (e) { renderCalendar(); }
        }
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const monthYearElem = document.getElementById('calendarMonthYear');
            if(monthYearElem) monthYearElem.innerText = `${thaiMonths[month]} ${year + 543}`;
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const daysContainer = document.getElementById('calendarDays');
            if(!daysContainer) return;
            daysContainer.innerHTML = "";
            for (let i = 0; i < firstDay; i++) daysContainer.innerHTML += `<div class="calendar-day empty"></div>`;
            for (let i = 1; i <= lastDate; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const event = currentEvents.find(e => e.date === dateStr);
                let className = "calendar-day";
                let style = "";
                let dotHtml = "";
                let clickAction = `onclick="viewEvent('${dateStr}')"`;
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) className += " today";
                if (event) {
                    className += " has-event";
                    const color = event.color || '#10b981';
                    style = `border: 2px solid ${color}; background-color: ${color}1a; color: ${color};`;
                    dotHtml = `<div class="event-dot" style="background-color: ${color}"></div>`;
                } else if (currentUserRole === 'admin' || currentUserRole === 'executive') { clickAction = `onclick="openAddEventModal('${dateStr}')"`; } else { clickAction = ""; }
                daysContainer.innerHTML += `<div class="${className}" style="${style}" ${clickAction}>${i}${dotHtml}</div>`;
            }
        }
        
        window.openAddEventModal = async (preSelectedDate = '') => {
            if(currentUserRole !== 'admin' && currentUserRole !== 'executive') return;
            if(!preSelectedDate) { const now = new Date(); preSelectedDate = now.toISOString().split('T')[0]; }
            const { value: formValues } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà',
                html: `<label class="form-label text-start w-100">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="swal-date" type="date" class="form-control mb-3" value="${preSelectedDate}"><label class="form-label text-start w-100">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input id="swal-title" class="form-control mb-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©"><label class="form-label text-start w-100">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ò‡∏µ‡∏°</label><input id="swal-color" type="color" class="form-control form-control-color w-100" value="#10b981">`,
                focusConfirm: false, showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#0d6efd',
                preConfirm: () => {
                    const dateVal = document.getElementById('swal-date').value;
                    const titleVal = document.getElementById('swal-title').value;
                    if(!dateVal || !titleVal) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return false; }
                    return { date: dateVal, title: titleVal, color: document.getElementById('swal-color').value }
                }
            });
            if (formValues) {
                try {
                    await addDoc(collection(db, "events"), {
                        date: formValues.date, title: formValues.title, color: formValues.color, created_by: auth.currentUser.uid, created_at: serverTimestamp()
                    });
                    Swal.fire({ icon: 'success', title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                } catch (error) { Swal.fire('Error', error.message, 'error'); }
            }
        };

        window.viewEvent = (dateStr) => {
            const event = currentEvents.find(e => e.date === dateStr);
            if (!event) return;
            let htmlContent = `<h5 style="color:${event.color}">${event.title}</h5>`;
            if (currentUserRole === 'admin' || currentUserRole === 'executive') {
                Swal.fire({
                    title: `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`, html: htmlContent, showDenyButton: true, showCancelButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á', denyButtonText: '‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', denyButtonColor: '#dc3545'
                }).then(async (result) => {
                    if (result.isDenied) { try { await deleteDoc(doc(db, "events", event.id)); Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success'); } catch (e) { Swal.fire('Error', e.message, 'error'); } }
                });
            } else { Swal.fire({ title: `‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`, html: htmlContent, confirmButtonText: '‡∏õ‡∏¥‡∏î' }); }
        };

        // Notifications
        let notifUnsubscribes = [];
        function listenToNotifications() {
            notifUnsubscribes.forEach(unsub => unsub()); notifUnsubscribes = [];
            const collectionsToCheck = [];
            if (currentUserRole === 'admin' || currentUserRole === 'executive') {
                collectionsToCheck.push({ name: 'repair_requests', label: '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' });
                collectionsToCheck.push({ name: 'vehicle_requests', label: '‡∏à‡∏≠‡∏á‡∏£‡∏ñ' });
                collectionsToCheck.push({ name: 'leave_requests', label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' });
                collectionsToCheck.push({ name: 'outside_requests', label: '‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' });
            } else if (currentUserRole === 'technician') collectionsToCheck.push({ name: 'repair_requests', label: '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' });
            else if (currentUserRole === 'transport') collectionsToCheck.push({ name: 'vehicle_requests', label: '‡∏à‡∏≠‡∏á‡∏£‡∏ñ' });
            else if (currentUserRole === 'personnel') { collectionsToCheck.push({ name: 'leave_requests', label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à/‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' }); collectionsToCheck.push({ name: 'outside_requests', label: '‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' }); }
            else if (currentUserRole === 'security_guard') collectionsToCheck.push({ name: 'outside_requests', label: '‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' });
            else if (currentUserRole === 'student' && currentStudentClass) {
                const todayStr = new Date().toISOString().split('T')[0];
                const q = query(collection(db, "learning_records"), where("className", "==", currentStudentClass), where("date", ">=", todayStr));
                const unsub = onSnapshot(q, (snapshot) => {
                    let hwCount = 0; snapshot.forEach(d => { if(d.data().homework) hwCount++; });
                    if(hwCount > 0) updateNotificationPopup({'‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà': hwCount});
                    else document.getElementById('notificationPopup').style.display = 'none';
                });
                notifUnsubscribes.push(unsub);
                return;
            }
            if (collectionsToCheck.length === 0) return;
            const counts = {};
            collectionsToCheck.forEach(col => {
                const q = query(collection(db, col.name), where("status", "==", "pending"));
                const unsub = onSnapshot(q, (snapshot) => {
                    counts[col.label] = snapshot.size;
                    updateNotificationPopup(counts);
                });
                notifUnsubscribes.push(unsub);
            });
        }
        function updateNotificationPopup(counts) {
            let total = 0; let detailsHtml = '';
            for (const [label, count] of Object.entries(counts)) { if (count > 0) { total += count; detailsHtml += `<div class="notif-item"><span>${label}</span> <b>${count}</b></div>`; } }
            const popup = document.getElementById('notificationPopup');
            if (total > 0) { document.getElementById('notifTotalCount').innerText = total; document.getElementById('notifContent').innerHTML = detailsHtml; popup.style.display = 'block'; } else { popup.style.display = 'none'; }
        }
        window.closeNotification = () => { document.getElementById('notificationPopup').style.display = 'none'; }

        // Status Update Logic
        window.updateStatus = async (collectionName, docId, currentStatus) => {
            let options = {};
            if(collectionName === 'repair_requests') options = { 'pending': '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', 'in_progress': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°', 'completed': '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'cancelled': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' };
            else if (collectionName === 'vehicle_requests') options = { 'pending': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á)', 'rejected': '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'completed': '‡∏à‡∏ö‡∏á‡∏≤‡∏ô' };
            else if (collectionName === 'outside_requests') options = { 'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'completed': '‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'returned': '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß' };
            else options = { 'pending': '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'rejected': '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' };

            const { value: newStatus } = await Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', input: 'select', inputOptions: options, inputValue: currentStatus,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonColor: '#0d6efd'
            });

            if (newStatus && newStatus !== currentStatus) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
                try {
                    const docRef = doc(db, collectionName, docId);
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£");
                    const data = docSnap.data();
                    await updateDoc(docRef, { status: newStatus });
                    
                    const reporterEmail = data.reporterEmail || data.email || data.requester_email;
                    if (reporterEmail) {
                        let taskTitle = data.equipment || data.destination || data.topic || "‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£";
                        let statusText = options[newStatus] || newStatus;
                        await addDoc(collection(db, "mail"), {
                            to: reporterEmail,
                            message: { subject: `üîî ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${taskTitle}`, html: `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£,<br>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <strong>"${taskTitle}"</strong> ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô: <strong>${statusText}</strong>` }
                        });
                    }
                    Swal.fire({ icon: 'success', title: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', confirmButtonColor: '#0d6efd' });
                } catch (e) { console.error(e); Swal.fire('Error', e.message, 'error'); }
            }
        };

        function loadNews() {
            const newsList = document.getElementById('newsList'); if(!newsList) return;
            const q = query(collection(db, "news"), orderBy("created_at", "desc"), limit(5));
            onSnapshot(q, (snap) => {
                newsList.innerHTML = "";
                if (snap.empty) { newsList.innerHTML = "<li class='list-group-item text-center py-5 text-muted'>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå -</li>"; return; }
                let hasNews = false;
                snap.forEach(d => {
                    const data = d.data();
                    const target = data.target || 'all';
                    let isVisible = false;
                    if (currentUserRole === 'admin' || currentUserRole === 'executive') isVisible = true;
                    else if (target === 'all' || target === currentUserRole) isVisible = true;
                    else if (target === 'teacher_all' && isTeacher(currentUserRole)) isVisible = true;
                    if (isVisible) {
                        hasNews = true;
                        let adminBtn = (currentUserRole === 'admin' || currentUserRole === 'executive') ? `<button class="btn btn-action btn-light text-danger btn-sm" onclick="deleteItem('news', '${d.id}')"><i class="fa-solid fa-trash"></i></button>` : "";
                        newsList.innerHTML += `<li class="list-group-item py-3"><div class="d-flex justify-content-between"><div><span class="fw-bold">${data.topic}</span><p class="text-muted small mb-0">${data.detail}</p></div>${adminBtn}</div></li>`;
                    }
                });
                if (!hasNews) newsList.innerHTML = "<li class='list-group-item text-center py-5 text-muted'>- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì -</li>";
            });
        }
        window.deleteItem = async (col, id) => { Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', icon: 'warning', showCancelButton: true, confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢', confirmButtonColor: '#dc3545' }).then(async (result) => { if (result.isConfirmed) await deleteDoc(doc(db, col, id)); }); };

        function loadQuickRepairs() { loadGenericTable('repair_requests', 'quickRepairTable', d=>`<td>${d.equipment}</td><td>${d.status}</td>`); }
        function loadQuickLeaves() { loadGenericTable('leave_requests', 'quickLeaveTable', d=>`<td>${d.leave_type}</td><td>${d.status}</td>`); }
        function loadQuickTransport() { loadGenericTable('vehicle_requests', 'quickTransportTable', d=>`<td>${d.destination}</td><td>${d.status}</td>`); }
        function loadQuickOutside() { loadGenericTable('outside_requests', 'quickOutsideTable', d=>`<td>${d.requester_name}</td><td>${d.status}</td>`); }
        function loadGenericTable(c,id,fn) { 
            const tbody = document.getElementById(id); if(!tbody) return;
            let q = (currentUserRole === 'admin' || currentUserRole === 'security_guard' || currentUserRole === 'executive') ? query(collection(db, c), orderBy("created_at", "desc"), limit(5)) : query(collection(db, c), where("status", "==", "pending"), limit(5));
            onSnapshot(q, s=>{ 
                tbody.innerHTML=""; 
                s.forEach(d=>{ 
                    const data=d.data(); 
                    let canEdit = (currentUserRole === 'admin' || (currentUserRole === 'security_guard' && c === 'outside_requests') || currentUserRole === 'executive');
                    let action = canEdit ? `<td class="text-end pe-4"><button class="btn btn-action btn-light text-primary" onclick="updateStatus('${c}', '${d.id}', '${data.status}')"><i class="fa-solid fa-pen"></i></button></td>` : "";
                    tbody.innerHTML+=`<tr>${fn(data)}${action}</tr>`; 
                }); 
            }); 
        }

        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth).then(()=>window.location.href="index.html"));
    </script>
</body>
</html>