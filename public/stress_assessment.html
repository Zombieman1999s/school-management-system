<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î & ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° - School Hub</title>
    <link rel="icon" href="icon.png" type="image/png">
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-color: #0ea5e9;
            --secondary-color: #6366f1;
            --success-color: #10b981;
            --bg-color: #f8fafc;
            --card-radius: 24px;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: #1e293b;
            padding-bottom: 100px;
        }

        .navbar-custom {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        .main-card {
            border: none; border-radius: var(--card-radius);
            background: white; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
            padding: 30px; position: relative; overflow: hidden;
        }

        /* --- Analysis Dashboard --- */
        .behavior-badge {
            background: #f1f5f9; padding: 8px 16px; border-radius: 50px;
            font-size: 0.85rem; color: #64748b; font-weight: 600;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* --- Coping Tools --- */
        .tool-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 16px;
            padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;
            height: 100%;
        }
        .tool-card:hover { transform: translateY(-5px); border-color: var(--primary-color); box-shadow: 0 10px 20px rgba(14, 165, 233, 0.1); }
        .tool-icon { font-size: 2rem; margin-bottom: 10px; display: block; }

        /* --- Breathing Animation (4-7-8 Technique) --- */
        .breathing-circle {
            width: 150px; height: 150px; background: #e0f2fe; border-radius: 50%;
            margin: 60px auto; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #0284c7; font-size: 1.2rem;
            transform: scale(1);
            transition: all 0.5s ease;
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
            position: relative;
            z-index: 10;
        }
        .breathe-in { transition: transform 4s ease-in-out, background-color 4s; transform: scale(1.6); background-color: #bae6fd; }
        .breathe-hold { transition: background-color 0.5s; transform: scale(1.6); background-color: #7dd3fc; }
        .breathe-out { transition: transform 8s ease-in-out, background-color 8s; transform: scale(1); background-color: #e0f2fe; }

        /* --- Result UI --- */
        .score-circle {
            width: 140px; height: 140px; border-radius: 50%; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            background: conic-gradient(var(--score-color) var(--score-pct), #f1f5f9 0);
        }
        .score-inner {
            width: 120px; height: 120px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .level-normal { color: #10b981; --score-color: #10b981; }
        .level-moderate { color: #f59e0b; --score-color: #f59e0b; }
        .level-severe { color: #ef4444; --score-color: #ef4444; }

        /* --- Safety Footer --- */
        .safety-footer {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0;
            text-align: center; font-size: 0.8rem; color: #94a3b8;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="dashboard.html">
                <i class="fa-solid fa-chevron-left me-2"></i> Dashboard
            </a>
            <span class="fw-bold text-dark"><i class="fa-solid fa-brain text-warning me-2"></i>Mind & Behavior</span>
        </div>
    </nav>

    <div class="container py-4">
        
        <!-- 1. Main Welcome & Last Result -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="main-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold m-0">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö, <span id="userNameDisplay">...</span> üëã</h4>
                        <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="startAssessment()">
                            <i class="fa-solid fa-clipboard-check me-2"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î
                        </button>
                    </div>
                    
                    <!-- Behavioral Data Summary -->
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <div class="behavior-badge"><i class="fa-solid fa-bed text-primary"></i> ‡∏ô‡∏≠‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <span id="avgSleep">-</span> ‡∏ä‡∏°.</div>
                        <div class="behavior-badge"><i class="fa-solid fa-fire text-danger"></i> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° <span id="avgActivity">-</span> kcal</div>
                        <div class="behavior-badge"><i class="fa-solid fa-utensils text-success"></i> ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ <span id="avgFood">-</span> kcal</div>
                    </div>

                    <p class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö</p>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="main-card h-100 d-flex flex-column justify-content-center align-items-center text-center bg-white">
                    <h6 class="text-muted mb-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <div id="lastStatusBadge" class="badge bg-light text-dark border rounded-pill px-3 py-2 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <small class="text-muted" id="lastCheckDate">-</small>
                </div>
            </div>
        </div>

        <!-- 2. Behavioral Analysis Chart -->
        <div class="row mb-4" id="analysisSection">
            <div class="col-12">
                <div class="card border-0 shadow-sm p-4 rounded-4">
                    <h5 class="fw-bold text-dark mb-4"><i class="fa-solid fa-chart-line me-2 text-info"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° & ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</h5>
                    <div class="chart-container">
                        <canvas id="behaviorChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. History Table (New!) -->
        <div class="row mb-5">
            <div class="col-lg-8 mx-auto">
                <div class="card border-0 shadow-sm p-4 rounded-4">
                    <h6 class="fw-bold text-dark mb-3"><i class="fa-solid fa-list-check me-2 text-primary"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0 rounded-start">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="border-0 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                                    <th class="border-0 text-center">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                                    <th class="border-0 rounded-end text-end">‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr><td colspan="4" class="text-center py-4 text-muted"><i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Smart Coping Tools -->
        <h5 class="fw-bold mb-3 px-2"><i class="fa-solid fa-toolbox me-2 text-secondary"></i>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏à (Coping Tools)</h5>
        <div class="row g-3 mb-5">
            <div class="col-6 col-md-3">
                <div class="tool-card" onclick="openBreathing()">
                    <span class="tool-icon">üå¨Ô∏è</span>
                    <h6 class="fw-bold">‡∏ù‡∏∂‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à 4-7-8</h6>
                    <small class="text-muted">‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô/‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="tool-card" onclick="openMindfulness()">
                    <span class="tool-icon">üßò</span>
                    <h6 class="fw-bold">Mindfulness</h6>
                    <small class="text-muted">‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ò‡∏¥ 2 ‡∏ô‡∏≤‡∏ó‡∏µ</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="tool-card" onclick="openMiniExercise()">
                    <span class="tool-icon">üôÜ‚Äç‚ôÇÔ∏è</span>
                    <h6 class="fw-bold">‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î</h6>
                    <small class="text-muted">‡∏Ñ‡∏•‡∏≤‡∏¢‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏≠/‡∏ö‡πà‡∏≤</small>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="tool-card border-danger bg-danger bg-opacity-10" onclick="showHelpline()">
                    <span class="tool-icon">üÜò</span>
                    <h6 class="fw-bold text-danger">‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h6>
                    <small class="text-danger">‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï</small>
                </div>
            </div>
        </div>

        <!-- Safety Footer -->
        <div class="safety-footer">
            <p class="mb-1"><i class="fa-solid fa-shield-halved me-1"></i> <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</strong> ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            <p class="mb-0">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ô‡∏µ‡πâ <u>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ</u> ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</p>
            <button class="btn btn-link btn-sm text-muted mt-2" onclick="deleteMyData()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (PDPA)</button>
        </div>

    </div>

    <!-- Quiz Modal with Sleep Input -->
    <div class="modal fade" id="quizModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <div>
                        <h5 class="modal-title fw-bold">üìù ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h5>
                        <p class="text-muted small mb-0">‡∏ä‡πà‡∏ß‡∏á 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Behavioral Check -->
                    <div class="mb-4 p-3 bg-light rounded-3 border">
                        <label class="form-label fw-bold"><i class="fa-solid fa-moon text-primary me-2"></i>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏ô‡∏≠‡∏ô‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á?</label>
                        <input type="number" id="sleepHours" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô 6 ‡∏´‡∏£‡∏∑‡∏≠ 7.5">
                    </div>
                    
                    <form id="assessmentForm">
                        <div id="questionsContainer"></div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold w-100" onclick="submitAssessment()">
                        ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal (AI Powered) -->
    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="modal-body p-4 text-center">
                    <div id="scoreCircle" class="score-circle level-normal" style="--score-pct: 0%;">
                        <div class="score-inner">
                            <h1 class="fw-bold m-0 display-4" id="resScore">0</h1>
                            <small class="text-muted">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
                        </div>
                    </div>
                    <h4 class="fw-bold mt-3 mb-1" id="resLevel">...</h4>
                    
                    <!-- AI Box -->
                    <div class="mt-4 text-start bg-light p-3 rounded-3 border">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fa-solid fa-robot text-primary me-2"></i>
                            <strong class="text-primary">AI Insight & Behavioral Link</strong>
                        </div>
                        <div id="aiLoading" class="text-center py-3"><i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                        <div id="aiContent" class="small text-dark" style="line-height: 1.6;"></div>
                    </div>

                    <!-- Recommended Action -->
                    <div id="recommendAction" class="mt-3"></div>

                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal" onclick="updateHistory()">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Breathing Modal (4-7-8) -->
    <div class="modal fade" id="breathingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4 bg-dark text-white">
                <div class="modal-body p-4 text-center">
                    <h3 class="fw-bold mb-5"><i class="fa-solid fa-lungs me-2"></i>‡∏ù‡∏∂‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à 4-7-8</h3>
                    <!-- Margin added to prevent overlap -->
                    <div class="breathing-circle mx-auto my-5" id="breathCircle">
                        <span id="breathMainText">‡∏û‡∏£‡πâ‡∏≠‡∏°...</span>
                    </div>
                    <p class="mt-5 text-white-50" id="breathSubText">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏™‡∏ö‡∏≤‡∏¢ ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡πÑ‡∏´‡∏•‡πà</p>
                    <button class="btn btn-outline-light rounded-pill mt-3 px-4" onclick="stopBreathing()">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const GEMINI_API_KEY = "AIzaSyBPdWK_BNfCXt_SXXGD-MKbG5qfAJlb5C8"; 

        // 10 Detailed Questions
        const questions = [
            "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö (‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)",
            "‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î ‡∏Å‡∏£‡∏∞‡∏ß‡∏ô‡∏Å‡∏£‡∏∞‡∏ß‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πâ‡∏≤‡∏ß‡∏∏‡πà‡∏ô‡πÉ‡∏à",
            "‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏≤‡∏¢ ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏•‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏¥‡∏ô",
            "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏ö‡∏õ‡∏∞‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß",
            "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á ‡∏õ‡∏ß‡∏î‡∏ï‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠",
            "‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ò‡∏¥ ‡∏à‡∏î‡∏à‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏¢‡∏≤‡∏Å",
            "‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏£‡∏á",
            "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡∏ß‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô ‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÜ ‡∏ã‡πâ‡∏≥‡πÑ‡∏õ‡∏ã‡πâ‡∏≥‡∏°‡∏≤",
            "‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
            "‡∏Å‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡∏Å‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥"
        ];

        let currentUser = null;
        let chartInstance = null;
        let breathInterval = null;
        let breathTimeouts = [];

        // Init
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userNameDisplay').innerText = user.displayName || '‡∏Ñ‡∏∏‡∏ì';
                loadData();
            } else {
                window.location.href = "index.html";
            }
        });

        // --- 1. DATA LOAD & CHART & TABLE ---
        async function loadData() {
            // Fetch History from Firebase
            const q = query(collection(db, "stress_assessments"), where("userId", "==", currentUser.uid), orderBy("timestamp", "asc"), limit(14));
            const snapshot = await getDocs(q);
            
            const labels = [];
            const stressData = [];
            const sleepData = [];
            let totalSleep = 0;
            let lastStatus = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
            let lastDate = "-";
            
            // For Table (Reverse Order)
            const historyDocs = [];

            snapshot.forEach(doc => {
                const d = doc.data();
                historyDocs.push(d); // Store for table
                
                const date = new Date(d.timestamp.seconds * 1000).toLocaleDateString('th-TH', {weekday:'short', day:'numeric'});
                labels.push(date);
                stressData.push(d.score); 
                sleepData.push(d.sleepHours || 0);
                totalSleep += (d.sleepHours || 0);
                
                // Get last status
                if(d.score <= 5) lastStatus = "‡∏õ‡∏Å‡∏ï‡∏¥";
                else if(d.score <= 10) lastStatus = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢";
                else if(d.score <= 17) lastStatus = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
                else if(d.score <= 24) lastStatus = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á";
                else lastStatus = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á";
                
                lastDate = new Date(d.timestamp.seconds * 1000).toLocaleDateString('th-TH', {day:'numeric', month:'short'});
            });

            // Get LocalStorage Data (Calories/Activity)
            const meals = JSON.parse(localStorage.getItem('meals')||'[]');
            const activities = JSON.parse(localStorage.getItem('activities')||'[]');
            
            // Calculate Averages
            const avgSleep = snapshot.size > 0 ? (totalSleep / snapshot.size).toFixed(1) : "-";
            const today = new Date().toISOString().split('T')[0];
            const todayCal = meals.filter(m=>m.date===today).reduce((s,m)=>s+m.calories,0);
            const todayAct = activities.filter(a=>a.date===today).reduce((s,a)=>s+a.calories,0);

            // Update UI Badges
            document.getElementById('avgSleep').innerText = avgSleep;
            document.getElementById('avgFood').innerText = todayCal;
            document.getElementById('avgActivity').innerText = todayAct;
            document.getElementById('lastStatusBadge').innerText = lastStatus;
            document.getElementById('lastCheckDate').innerText = "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + lastDate;

            // Render Chart (Dual Axis)
            renderChart(labels, stressData, sleepData);
            
            // Render History Table
            renderHistoryTable(historyDocs.reverse());
        }

        function renderHistoryTable(docs) {
            const tbody = document.getElementById('historyTableBody');
            if(docs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</td></tr>`;
                return;
            }
            
            let html = "";
            docs.forEach(d => {
                const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString('th-TH', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}) : "-";
                
                let level = "‡∏õ‡∏Å‡∏ï‡∏¥", badgeClass = "bg-success";
                if(d.score > 5) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"; badgeClass = "bg-success bg-opacity-75"; }
                if(d.score > 10) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"; badgeClass = "bg-warning text-dark"; }
                if(d.score > 17) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á"; badgeClass = "bg-warning"; }
                if(d.score > 24) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á"; badgeClass = "bg-danger"; }

                html += `
                    <tr>
                        <td class="small text-muted">${date}</td>
                        <td class="text-center fw-bold">${d.score}/30</td>
                        <td class="text-center"><span class="badge rounded-pill ${badgeClass}">${level}</span></td>
                        <td class="text-end text-primary fw-bold"><i class="fa-solid fa-moon me-1"></i> ${d.sleepHours || '-'}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function renderChart(labels, stress, sleep) {
            const ctx = document.getElementById('behaviorChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î (30 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
                            data: stress,
                            type: 'line',
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏≠‡∏ô',
                            data: sleep,
                            backgroundColor: '#0ea5e9',
                            yAxisID: 'y1',
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: true, max: 30, position: 'left', title: {display:true, text:'‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î'} },
                        y1: { beginAtZero: true, max: 12, position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏≠‡∏ô'} }
                    }
                }
            });
        }

        // --- 2. ASSESSMENT LOGIC ---
        window.startAssessment = () => {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = questions.map((q, i) => `
                <div class="mb-3">
                    <p class="mb-2 fw-bold">${i+1}. ${q}</p>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="q${i}" id="q${i}_0" value="0" autocomplete="off" required>
                        <label class="btn btn-outline-success" for="q${i}_0">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢</label>

                        <input type="radio" class="btn-check" name="q${i}" id="q${i}_1" value="1" autocomplete="off">
                        <label class="btn btn-outline-warning" for="q${i}_1">‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô</label>

                        <input type="radio" class="btn-check" name="q${i}" id="q${i}_2" value="2" autocomplete="off">
                        <label class="btn btn-outline-warning" for="q${i}_2">‡∏ö‡πà‡∏≠‡∏¢</label>

                        <input type="radio" class="btn-check" name="q${i}" id="q${i}_3" value="3" autocomplete="off">
                        <label class="btn btn-outline-danger" for="q${i}_3">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</label>
                    </div>
                </div>
            `).join('');
            new bootstrap.Modal(document.getElementById('quizModal')).show();
        };

        window.submitAssessment = async () => {
            let score = 0;
            let answered = 0;
            questions.forEach((q, i) => {
                const el = document.querySelector(`input[name="q${i}"]:checked`);
                if(el) { score += parseInt(el.value); answered++; }
            });
            const sleep = document.getElementById('sleepHours').value;

            if(answered < questions.length || !sleep) {
                Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', '‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ô‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞', 'warning');
                return;
            }

            bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();
            
            // Save to Firebase Immediately
            try {
                await addDoc(collection(db, "stress_assessments"), {
                    userId: currentUser.uid, score: score, sleepHours: parseFloat(sleep), timestamp: serverTimestamp()
                });
                // Reload data to reflect in chart
                loadData();
            } catch(e) { console.error("Save error", e); }

            processResult(score, sleep);
        };

        async function processResult(score, sleep) {
            new bootstrap.Modal(document.getElementById('resultModal')).show();
            
            // Interpret (Max Score 30)
            let level = "‡∏õ‡∏Å‡∏ï‡∏¥", color = "level-normal";
            if(score > 5) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"; color = "level-moderate"; }
            if(score > 10) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"; color = "level-moderate"; }
            if(score > 17) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á"; color = "level-severe"; }
            if(score > 24) { level = "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á"; color = "level-severe"; }

            // UI Update
            document.getElementById('resScore').innerText = score;
            document.getElementById('resLevel').innerText = level;
            document.getElementById('resLevel').className = `fw-bold mt-3 mb-1 ${color}`;
            document.getElementById('scoreCircle').className = `score-circle ${color}`;
            document.getElementById('scoreCircle').style.setProperty('--score-pct', `${(score/30)*100}%`);

            // AI Analysis (Combining Stress + Sleep + Calories)
            const meals = JSON.parse(localStorage.getItem('meals')||'[]');
            const todayCal = meals.filter(m=>m.date===new Date().toISOString().split('T')[0]).reduce((s,m)=>s+m.calories,0);
            
            const prompt = `User Data: Stress Score ${score}/30 (${level}), Sleep ${sleep} hrs, Calories today ${todayCal}.
            Role: AI Health Coach.
            Task: Analyze the link between their stress and behavior (sleep/diet). Suggest 1 actionable tip.
            Output: Thai language, friendly, emojis. Use Markdown.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                document.getElementById('aiContent').innerHTML = marked.parse(text);
            } catch(e) {
                document.getElementById('aiContent').innerText = "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô";
            } finally {
                document.getElementById('aiLoading').classList.add('d-none');
            }

            // Smart Recommendation Button
            const actionDiv = document.getElementById('recommendAction');
            if(score > 17) {
                actionDiv.innerHTML = `<button class="btn btn-danger rounded-pill w-100 mb-2" onclick="showHelpline()">üìû ‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï (‡∏Ñ‡∏•‡∏¥‡∏Å)</button>`;
            } else if(score > 5) {
                actionDiv.innerHTML = `<button class="btn btn-primary rounded-pill w-100" onclick="openBreathing()">üå¨Ô∏è ‡∏ù‡∏∂‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏Ñ‡∏•‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î</button>`;
            } else {
                actionDiv.innerHTML = `<button class="btn btn-success rounded-pill w-100">‚ú® ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏î‡πÉ‡∏™‡πÑ‡∏ß‡πâ‡∏ô‡∏∞!</button>`;
            }
        }

        // --- 3. TOOLS (Improved 4-7-8 Breathing) ---
        window.openBreathing = () => {
            const modal = new bootstrap.Modal(document.getElementById('breathingModal'));
            modal.show();
            document.getElementById('resultModal').classList.remove('show'); // Hide result if open
            
            startBreathingCycle();
        };

        function startBreathingCycle() {
            const circle = document.getElementById('breathCircle');
            const mainText = document.getElementById('breathMainText');
            const subText = document.getElementById('breathSubText');
            
            // Clear any existing timeouts
            breathTimeouts.forEach(t => clearTimeout(t));
            breathTimeouts = [];

            // Cycle Function
            const runCycle = () => {
                // Step 1: Inhale (4s)
                circle.className = 'breathing-circle breathe-in mx-auto my-5';
                mainText.innerText = '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤';
                subText.innerText = '‡∏™‡∏π‡∏î‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏∂‡∏Å‡πÜ ‡∏ó‡∏≤‡∏á‡∏à‡∏°‡∏π‡∏Å (4 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)';
                
                // Step 2: Hold (7s)
                breathTimeouts.push(setTimeout(() => {
                    circle.className = 'breathing-circle breathe-hold mx-auto my-5';
                    mainText.innerText = '‡∏Å‡∏•‡∏±‡πâ‡∏ô‡πÑ‡∏ß‡πâ';
                    subText.innerText = '‡∏ô‡∏±‡∏ö 1-7 ‡πÉ‡∏ô‡πÉ‡∏à... ‡∏≠‡∏î‡∏ó‡∏ô‡πÑ‡∏ß‡πâ‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á';
                }, 4000));

                // Step 3: Exhale (8s)
                breathTimeouts.push(setTimeout(() => {
                    circle.className = 'breathing-circle breathe-out mx-auto my-5';
                    mainText.innerText = '‡∏ú‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å';
                    subText.innerText = '‡πÄ‡∏õ‡πà‡∏≤‡∏•‡∏°‡∏≠‡∏≠‡∏Å‡∏ó‡∏≤‡∏á‡∏õ‡∏≤‡∏Å‡∏¢‡∏≤‡∏ß‡πÜ ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î‡∏õ‡∏≠‡∏î (8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)';
                }, 11000)); // 4000 + 7000

                // Loop
                breathTimeouts.push(setTimeout(runCycle, 19000)); // 4000 + 7000 + 8000
            };

            // Start immediately
            runCycle();
        }

        window.stopBreathing = () => {
            breathTimeouts.forEach(t => clearTimeout(t));
            breathTimeouts = [];
            const circle = document.getElementById('breathCircle');
            circle.className = 'breathing-circle mx-auto my-5'; // Reset class
            document.getElementById('breathMainText').innerText = '‡∏û‡∏£‡πâ‡∏≠‡∏°...';
            document.getElementById('breathSubText').innerText = '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏™‡∏ö‡∏≤‡∏¢ ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡πÑ‡∏´‡∏•‡πà';
            bootstrap.Modal.getInstance(document.getElementById('breathingModal')).hide();
        };

        window.openMindfulness = () => {
            let timer = 120;
            Swal.fire({
                title: 'üßò Mindfulness 2 ‡∏ô‡∏≤‡∏ó‡∏µ',
                html: '‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤... ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à...<br><h1 id="timer" class="display-4 mt-3">2:00</h1>',
                showConfirmButton: false,
                didOpen: () => {
                    const content = Swal.getHtmlContainer().querySelector('#timer');
                    const interval = setInterval(() => {
                        timer--;
                        const m = Math.floor(timer / 60);
                        const s = timer % 60;
                        content.textContent = `${m}:${s < 10 ? '0'+s : s}`;
                        if (timer <= 0) {
                            clearInterval(interval);
                            Swal.fire('‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!', '‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        }
                    }, 1000);
                }
            });
        };

        window.openMiniExercise = () => {
            Swal.fire({
                title: 'üôÜ‚Äç‚ôÇÔ∏è ‡∏¢‡∏∑‡∏î‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î‡∏á‡πà‡∏≤‡∏¢‡πÜ',
                imageUrl: 'https://cdn-icons-png.flaticon.com/512/2548/2548535.png',
                imageWidth: 100,
                html: '<ul class="text-start"><li>‡∏´‡∏°‡∏∏‡∏ô‡∏Ñ‡∏≠‡∏ä‡πâ‡∏≤‡πÜ 5 ‡∏£‡∏≠‡∏ö</li><li>‡∏¢‡∏±‡∏Å‡πÑ‡∏´‡∏•‡πà‡∏Ç‡∏∂‡πâ‡∏ô-‡∏•‡∏á 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</li><li>‡∏ö‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ ‡∏ä‡πâ‡∏≤‡πÜ</li></ul>',
                confirmButtonText: '‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!'
            });
        };

        window.showHelpline = () => {
            Swal.fire({
                icon: 'warning',
                title: '‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï',
                html: '<h3>üìû 1323</h3><p>‡πÇ‡∏ó‡∏£‡∏ü‡∏£‡∏µ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p><br>‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                confirmButtonText: '‡πÇ‡∏ó‡∏£‡πÄ‡∏•‡∏¢',
                confirmButtonColor: '#ef4444',
                showCancelButton: true,
                cancelButtonText: '‡∏õ‡∏¥‡∏î'
            }).then(r => {
                if(r.isConfirmed) window.location.href = "tel:1323";
            });
        };

        window.deleteMyData = () => {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö (PDPA)', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444'
            }).then(async r => {
                if(r.isConfirmed) {
                    // Logic to delete query would go here (requires fetching doc IDs and deleteDoc loop)
                    Swal.fire('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => location.reload());
                }
            });
        }

        window.updateHistory = () => loadData();

    </script>
</body>
</html>