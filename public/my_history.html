<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - School System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; }
        .page-header { background-color: #0d6efd; color: white; padding: 30px 20px; border-radius: 0 0 25px 25px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2); }
        
        .nav-pills .nav-link { 
            border-radius: 50px; color: #555; font-weight: 500; padding: 8px 20px; margin: 0 5px; 
            border: 1px solid #eee; background: white; white-space: nowrap;
        }
        .nav-pills .nav-link.active { background-color: #0d6efd; color: white; border-color: #0d6efd; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3); }
        
        .card-history { 
            border: none; border-radius: 15px; margin-bottom: 15px; background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; 
            border-left: 5px solid #ddd;
        }
        .card-history:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        
        .status-badge { font-size: 0.75rem; padding: 6px 12px; border-radius: 20px; font-weight: 600; }
        .history-icon { 
            width: 45px; height: 45px; border-radius: 12px; display: flex; 
            align-items: center; justify-content: center; font-size: 1.3rem; margin-right: 15px; flex-shrink: 0;
        }
        
        /* ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        .border-pending { border-left-color: #ffc107 !important; }
        .border-approved { border-left-color: #198754 !important; }
        .border-rejected { border-left-color: #dc3545 !important; }
        .border-completed { border-left-color: #0d6efd !important; }

        /* ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
        .icon-repair { background-color: #e7f1ff; color: #0d6efd; }
        .icon-leave { background-color: #f3e5f5; color: #9c27b0; }
        .icon-vehicle { background-color: #d1e7dd; color: #198754; }
        .icon-outside { background-color: #cff4fc; color: #0dcaf0; }
        .icon-manpower { background-color: #f8d7da; color: #dc3545; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container">
            <span class="navbar-brand"><i class="fa-solid fa-school-flag"></i> School System</span>
            <a href="dashboard.html" class="btn btn-sm btn-outline-light rounded-pill px-3">
                <i class="fa-solid fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>
    </nav>

    <div class="page-header text-center">
        <h2 class="fw-bold"><i class="fa-solid fa-clock-rotate-left"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
        <p class="mb-0 opacity-75">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
        <small id="userDebug" class="d-none badge bg-white text-dark mt-2"></small>
    </div>

    <div class="container mb-5">
        
        <div class="d-flex overflow-auto pb-2 mb-3">
            <ul class="nav nav-pills mx-auto" id="pills-tab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-repair">üõ†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-leave">üìù ‡πÉ‡∏ö‡∏•‡∏≤</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-vehicle">üöç ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-outside">üèÉ ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-manpower">üí™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</button></li>
            </ul>
        </div>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="tab-repair"><div id="repairList"></div></div>
            <div class="tab-pane fade" id="tab-leave"><div id="leaveList"></div></div>
            <div class="tab-pane fade" id="tab-vehicle"><div id="vehicleList"></div></div>
            <div class="tab-pane fade" id="tab-outside"><div id="outsideList"></div></div>
            <div class="tab-pane fade" id="tab-manpower"><div id="manpowerList"></div></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• Config ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡πå‡∏°
        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Debug: ‡πÇ‡∏ä‡∏ß‡πå ID ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏°‡∏∏‡∏°‡∏ö‡∏ô (‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡πÄ‡∏ä‡πá‡∏Ñ)
                document.getElementById('userDebug').innerText = `ID: ${user.uid}`;
                document.getElementById('userDebug').classList.remove('d-none');

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                loadData("repair_requests", "repairList", user.uid);
                loadData("leave_requests", "leaveList", user.uid);
                loadData("vehicle_requests", "vehicleList", user.uid);
                loadData("outside_requests", "outsideList", user.uid);
                loadData("manpower_requests", "manpowerList", user.uid);
            } else {
                window.location.href = "index.html";
            }
        });

        function loadData(collectionName, elementId, uid) {
            const list = document.getElementById(elementId);
            list.innerHTML = `<div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm text-primary"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;

            // üî• ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ Field ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö)
            // Repair & Vehicle ‡πÉ‡∏ä‡πâ 'uid'
            // Leave, Outside, Manpower ‡πÉ‡∏ä‡πâ 'requester_uid'
            let uidField = 'uid';
            if (['leave_requests', 'outside_requests', 'manpower_requests'].includes(collectionName)) {
                uidField = 'requester_uid';
            }

            // Query ‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á orderBy ‡πÉ‡∏ô Database ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Index)
            const q = query(collection(db, collectionName), where(uidField, "==", uid));

            onSnapshot(q, (snapshot) => {
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="text-center py-5 text-muted opacity-50">
                            <i class="fa-regular fa-folder-open display-4 mb-2"></i><br>
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ
                        </div>`;
                    return;
                }

                // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏™‡πà Array
                let items = [];
                snapshot.forEach((doc) => {
                    let item = doc.data();
                    item.id = doc.id;
                    items.push(item);
                });

                // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á‡πÉ‡∏ô JavaScript (‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤)
                items.sort((a, b) => {
                    const timeA = a.created_at ? a.created_at.seconds : 0;
                    const timeB = b.created_at ? b.created_at.seconds : 0;
                    return timeB - timeA;
                });

                // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                items.forEach((data) => {
                    let title = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", detail = "-", iconClass = "", iconName = "fa-file";
                    
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    const dateObj = data.created_at ? new Date(data.created_at.seconds*1000) : new Date();
                    const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit' });

                    // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                    if (collectionName === 'repair_requests') {
                        title = data.equipment || data.topic || "‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°";
                        detail = `<i class="fa-solid fa-location-dot text-danger"></i> ${data.location || '-'} | ${data.description || '-'}`;
                        iconClass = 'icon-repair'; iconName = 'fa-screwdriver-wrench';
                    } 
                    else if (collectionName === 'leave_requests') {
                        title = `‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: ${data.leave_type}`;
                        detail = `üìÖ ${formatDate(data.start_date)} - ${formatDate(data.end_date)}<br><small class="text-muted">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${data.reason}</small>`;
                        iconClass = 'icon-leave'; iconName = 'fa-file-medical';
                    } 
                    else if (collectionName === 'vehicle_requests') {
                        title = `‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÑ‡∏õ: ${data.destination}`;
                        detail = `üìÖ ${formatDate(data.use_date)} (${data.start_time || '-'} - ${data.end_time || '-'})<br><small class="text-muted">‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£: ${data.passenger_count || '-'} ‡∏Ñ‡∏ô</small>`;
                        iconClass = 'icon-vehicle'; iconName = 'fa-van-shuttle';
                    }
                    else if (collectionName === 'outside_requests') {
                        title = `‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà`;
                        detail = `üìÖ ${formatDate(data.out_date)} (${data.start_time || '-'} - ${data.end_time || '-'})<br><small class="text-muted">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${data.reason}</small>`;
                        iconClass = 'icon-outside'; iconName = 'fa-person-walking-luggage';
                    }
                    else if (collectionName === 'manpower_requests') {
                        title = `‡∏Ç‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•: ${data.activity}`;
                        detail = `üìÖ ${formatDate(data.use_date)} (${data.use_time || '-'}) | üìç ${data.location || '-'}<br><small class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${data.people_count || '-'} ‡∏Ñ‡∏ô</small>`;
                        iconClass = 'icon-manpower'; iconName = 'fa-users';
                    }

                    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö
                    let borderClass = 'border-pending';
                    if (['approved', 'completed'].includes(data.status)) borderClass = 'border-approved';
                    if (['rejected', 'cancelled'].includes(data.status)) borderClass = 'border-rejected';

                    list.innerHTML += `
                        <div class="card card-history p-3 ${borderClass}">
                            <div class="d-flex align-items-start">
                                <div class="history-icon ${iconClass}">
                                    <i class="fa-solid ${iconName}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="fw-bold mb-1 text-dark">${title}</h6>
                                        ${getStatusBadge(data.status)}
                                    </div>
                                    <div class="small text-secondary mb-2" style="line-height: 1.6;">${detail}</div>
                                    <div class="text-end">
                                        <small class="text-muted" style="font-size: 0.75rem;">
                                            <i class="fa-regular fa-clock"></i> ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${dateStr}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }, (error) => {
                console.error(`Error loading ${collectionName}:`, error);
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Error ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô
                list.innerHTML = `<div class="alert alert-danger p-2 small"><i class="fa-solid fa-triangle-exclamation"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console)</div>`;
            });
        }

        function formatDate(dateString) {
            if(!dateString) return "-";
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
        }

        function getStatusBadge(status) {
            const map = {
                'pending': '<span class="status-badge bg-warning text-dark"><i class="fa-solid fa-hourglass-half"></i> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>',
                'in_progress': '<span class="status-badge bg-info text-dark"><i class="fa-solid fa-screwdriver"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</span>',
                'approved': '<span class="status-badge bg-success text-white"><i class="fa-solid fa-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>',
                'rejected': '<span class="status-badge bg-danger text-white"><i class="fa-solid fa-xmark"></i> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>',
                'completed': '<span class="status-badge bg-success text-white"><i class="fa-solid fa-check-double"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>',
                'cancelled': '<span class="status-badge bg-secondary text-white"><i class="fa-solid fa-ban"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>'
            };
            return map[status] || `<span class="status-badge bg-secondary text-white">${status}</span>`;
        }
    </script>
</body>
</html>