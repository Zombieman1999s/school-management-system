<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - School Hub</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        
        .main-header {
            background: linear-gradient(135deg, #343a40, #495057); 
            color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .btn-back {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);
            color: white; border-radius: 50px; padding: 5px 15px; font-size: 0.9rem;
            text-decoration: none; transition: 0.3s; display: flex; align-items: center; gap: 5px;
        }
        .btn-back:hover { background: white; color: #343a40; }

        .nav-pills .nav-link {
            border-radius: 50px; color: #6c757d; font-weight: 600; padding: 8px 20px; margin-right: 5px;
            border: 1px solid transparent; transition: all 0.3s; white-space: nowrap;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd; color: white; box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
        }
        .nav-pills .nav-link:hover:not(.active) { background-color: #e9ecef; }

        .history-card {
            border: none; border-radius: 12px; background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px;
            transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .history-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
        .status-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        .status-pending { background-color: #ffc107; }
        .status-approved { background-color: #198754; }
        .status-rejected { background-color: #dc3545; }
        .status-completed { background-color: #0d6efd; }
        .status-ongoing { background-color: #0dcaf0; }
        .status-ai { background-color: #d63384; } /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π AI */

        .badge-status { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #adb5bd; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }

        /* Scrollbar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .nav-pills { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 5px; }
        .nav-pills::-webkit-scrollbar { height: 4px; }
        .nav-pills::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="main-header">
        <div class="fw-bold fs-5"><i class="fa-solid fa-clock-rotate-left me-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠</div>
        <a href="dashboard.html" class="btn-back"><i class="fa-solid fa-house"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </div>

    <div class="container py-4">
        
        <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" onclick="filterType('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></li>
            <li class="nav-item"><button class="nav-link" onclick="filterType('ai')">ü§ñ ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° AI</button></li>
            <li class="nav-item"><button class="nav-link" onclick="filterType('leave')">üìù ‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button></li>
            <li class="nav-item"><button class="nav-link" onclick="filterType('repair')">üîß ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button></li>
            <li class="nav-item"><button class="nav-link" onclick="filterType('vehicle')">üöó ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</button></li>
            <li class="nav-item"><button class="nav-link" onclick="filterType('outside')">üåç ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</button></li>
        </ul>

        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted small">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
        </div>

        <div id="historyContainer"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allData = []; 

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadAllHistory(user);
            } else {
                window.location.href = "index.html";
            }
        });

        async function loadAllHistory(user) {
            const container = document.getElementById('historyContainer');
            const spinner = document.getElementById('loadingSpinner');
            allData = [];

            try {
                // 1. ‡∏î‡∏∂‡∏á AI Summary
                const qAI = query(collection(db, "meeting_summaries"), where("created_by", "==", user.uid));
                const snapAI = await getDocs(qAI);
                snapAI.forEach(doc => allData.push({ ...doc.data(), id: doc.id, type: 'ai', sortDate: doc.data().created_at, status: 'completed' }));

                // 2. ‡∏î‡∏∂‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
                const qRepair = query(collection(db, "repair_requests"), where("reporterEmail", "==", user.email));
                const snapRepair = await getDocs(qRepair);
                snapRepair.forEach(doc => allData.push({ ...doc.data(), id: doc.id, type: 'repair', sortDate: doc.data().created_at }));

                // 3. ‡∏î‡∏∂‡∏á‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞
                const qVehicle = query(collection(db, "vehicle_requests"), where("requester_uid", "==", user.uid));
                const snapVehicle = await getDocs(qVehicle);
                snapVehicle.forEach(doc => allData.push({ ...doc.data(), id: doc.id, type: 'vehicle', sortDate: doc.data().created_at }));

                // 4. ‡∏î‡∏∂‡∏á‡πÉ‡∏ö‡∏•‡∏≤
                const qLeave = query(collection(db, "leave_requests"), where("requester_uid", "==", user.uid));
                const snapLeave = await getDocs(qLeave);
                snapLeave.forEach(doc => allData.push({ ...doc.data(), id: doc.id, type: 'leave', sortDate: doc.data().created_at }));

                // 5. ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                const qOutside = query(collection(db, "outside_requests"), where("requester_uid", "==", user.uid));
                const snapOutside = await getDocs(qOutside);
                snapOutside.forEach(doc => allData.push({ ...doc.data(), id: doc.id, type: 'outside', sortDate: doc.data().created_at }));

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
                allData.sort((a, b) => {
                    const timeA = a.sortDate?.seconds || 0;
                    const timeB = b.sortDate?.seconds || 0;
                    return timeB - timeA;
                });

                spinner.style.display = 'none';
                renderList(allData);

            } catch (error) {
                console.error(error);
                spinner.innerHTML = `<p class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</p>`;
            }
        }

        window.filterType = (type) => {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            if (type === 'all') {
                renderList(allData);
            } else {
                const filtered = allData.filter(item => item.type === type);
                renderList(filtered);
            }
        };

        function renderList(data) {
            const container = document.getElementById('historyContainer');
            container.innerHTML = "";

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-folder-open"></i>
                        <h5>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                        <p class="small">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>
                    </div>`;
                return;
            }

            data.forEach(item => {
                const html = createCard(item);
                container.innerHTML += html;
            });
        }

        function createCard(item) {
            let icon, title, detail, dateTxt;
            const createdDate = item.created_at?.seconds ? new Date(item.created_at.seconds * 1000).toLocaleDateString('th-TH', { day:'numeric', month:'short', year:'2-digit', hour:'2-digit', minute:'2-digit' }) : '-';
            
            let statusConfig = getStatusConfig(item.status);

            if (item.type === 'ai') {
                icon = '<i class="fa-solid fa-robot text-pink" style="color: #d63384;"></i>';
                title = `‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°: ${item.topic}`;
                detail = `
                    <div class="text-muted small mb-2"><i class="fa-solid fa-users me-1"></i> ${item.participants || '-'}</div>
                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="showSummary('${item.id}')">
                        <i class="fa-solid fa-eye me-1"></i> ‡∏î‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                    </button>
                `;
                dateTxt = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${createdDate}`;
                statusConfig = { label: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß', colorClass: 'status-ai', badgeClass: 'bg-light text-dark border' }; // Override status for AI
            } 
            else if (item.type === 'repair') {
                icon = '<i class="fa-solid fa-screwdriver-wrench text-warning"></i>';
                title = `‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°: ${item.equipment || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`;
                detail = `üìç ${item.location} <br> <small class="text-muted">${item.problem || ''}</small>`;
                dateTxt = `‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${createdDate}`;
            } 
            else if (item.type === 'vehicle') {
                icon = '<i class="fa-solid fa-car-side text-success"></i>';
                title = `‡∏à‡∏≠‡∏á‡∏£‡∏ñ: ${item.destination}`;
                detail = `üìÖ ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: ${item.use_date} (${item.start_time} ‡∏ô.)`;
                dateTxt = `‡∏à‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${createdDate}`;
            } 
            else if (item.type === 'leave') {
                icon = '<i class="fa-solid fa-file-medical text-purple" style="color:#6f42c1;"></i>';
                title = `‡∏•‡∏≤: ${item.leave_type}`;
                detail = `üìÖ ${item.start_date} ‡∏ñ‡∏∂‡∏á ${item.end_date} (${item.total_days} ‡∏ß‡∏±‡∏ô)`;
                dateTxt = `‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${createdDate}`;
            } 
            else if (item.type === 'outside') {
                icon = '<i class="fa-solid fa-person-walking-luggage text-info"></i>';
                title = `‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${item.destination}`;
                detail = `üìÖ ${item.out_date} ‚è∞ ${item.start_time}-${item.end_time}`;
                dateTxt = `‡∏Ç‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${createdDate}`;
            }

            return `
                <div class="card history-card p-3">
                    <div class="status-bar ${statusConfig.colorClass}"></div>
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-4" style="width: 40px; text-align: center;">${icon}</div>
                            <div>
                                <h6 class="fw-bold mb-0 text-dark">${title}</h6>
                                <small class="text-muted" style="font-size: 0.75rem;">${dateTxt}</small>
                            </div>
                        </div>
                        <span class="badge ${statusConfig.badgeClass} badge-status">${statusConfig.label}</span>
                    </div>
                    <div class="ps-5 text-secondary small mt-1">
                        ${detail}
                    </div>
                </div>
            `;
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ AI
        window.showSummary = (id) => {
            const item = allData.find(d => d.id === id);
            if(item) {
                Swal.fire({
                    title: `<strong>${item.topic}</strong>`,
                    html: `
                        <div class="text-start p-2" style="max-height: 60vh; overflow-y: auto; font-size: 0.95rem; line-height: 1.6;">
                            ${marked.parse(item.ai_summary)}
                        </div>
                    `,
                    width: 800,
                    showCloseButton: true,
                    showConfirmButton: false,
                    footer: '<small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Gemini AI</small>'
                });
            }
        };

        function getStatusConfig(status) {
            switch (status) {
                case 'pending': return { label: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', colorClass: 'status-pending', badgeClass: 'bg-warning text-dark' };
                case 'approved': return { label: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', colorClass: 'status-approved', badgeClass: 'bg-success' };
                case 'rejected': 
                case 'cancelled': return { label: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', colorClass: 'status-rejected', badgeClass: 'bg-danger' };
                case 'in_progress': 
                case 'ongoing': return { label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', colorClass: 'status-ongoing', badgeClass: 'bg-info text-dark' };
                case 'completed': 
                case 'returned': return { label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', colorClass: 'status-completed', badgeClass: 'bg-primary' };
                default: return { label: status, colorClass: 'bg-secondary', badgeClass: 'bg-secondary' };
            }
        }
    </script>
</body>
</html>