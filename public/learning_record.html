<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô & ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô - School Hub</title>
    <link rel="icon" href="icon.png" type="image/png">
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #818cf8;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-radius: 20px;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: #1e293b;
            padding-bottom: 80px;
        }

        .navbar-custom {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        /* Cards */
        .main-card {
            border: none; border-radius: var(--card-radius);
            background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            padding: 25px; transition: transform 0.2s; position: relative; overflow: hidden;
        }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 600;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .status-pending { background: #fef3c7; color: #b45309; }
        .status-submitted { background: #d1fae5; color: #047857; }
        .status-late { background: #fee2e2; color: #b91c1c; }
        .status-graded { background: #e0f2fe; color: #0369a1; }

        /* Step Form */
        .step-container { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .step-container::before {
            content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 2px;
            background: #e2e8f0; z-index: 0;
        }
        .step-item {
            width: 35px; height: 35px; border-radius: 50%; background: white;
            border: 2px solid #e2e8f0; color: #94a3b8;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; position: relative; z-index: 1; cursor: pointer; transition: 0.2s;
        }
        .step-item.active { border-color: var(--primary-color); background: var(--primary-color); color: white; }
        .step-item.completed { border-color: var(--success-color); background: var(--success-color); color: white; }

        /* Tables */
        .table-custom th { background: #f8fafc; color: #64748b; font-weight: 600; border-top: none; }
        .table-custom td { vertical-align: middle; }
        
        /* Floating Button */
        .fab-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #4338ca);
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
            border: none; z-index: 1000; transition: transform 0.2s;
        }
        .fab-btn:hover { transform: scale(1.1); }

        .form-section { display: none; animation: fadeIn 0.3s; }
        .form-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }
        
        /* Upload Area in Modal */
        .upload-zone {
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px;
            text-align: center; background: #f8fafc; cursor: pointer; transition: 0.2s;
        }
        .upload-zone:hover { border-color: var(--primary-color); background: #eef2ff; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="dashboard.html">
                <i class="fa-solid fa-chevron-left me-2"></i> Dashboard
            </a>
            <span class="fw-bold text-dark"><i class="fa-solid fa-chalkboard-user text-warning me-2"></i>Teaching & HW</span>
        </div>
    </nav>

    <div class="container py-4">

        <!-- Role Toggle (For Demo/Testing) -->
        <div class="d-flex justify-content-end mb-3">
            <div class="btn-group shadow-sm">
                <input type="radio" class="btn-check" name="role" id="roleTeacher" autocomplete="off" checked onclick="switchRole('teacher')">
                <label class="btn btn-outline-primary btn-sm" for="roleTeacher">üë©‚Äçüè´ ‡∏Ñ‡∏£‡∏π</label>
                <input type="radio" class="btn-check" name="role" id="roleStudent" autocomplete="off" onclick="switchRole('student')">
                <label class="btn btn-outline-primary btn-sm" for="roleStudent">üßë‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            </div>
        </div>

        <!-- 1. TEACHER VIEW -->
        <div id="teacherView">
            <!-- Dashboard Stats -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="main-card py-3 px-4 h-100 border-start border-4 border-primary">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted text-uppercase fw-bold">‡∏Ñ‡∏≤‡∏ö‡∏™‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                                <h3 class="fw-bold m-0 mt-1 text-dark" id="statTodayCount">-</h3>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary"><i class="fa-solid fa-clock"></i></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="main-card py-3 px-4 h-100 border-start border-4 border-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted text-uppercase fw-bold">‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</small>
                                <h3 class="fw-bold m-0 mt-1 text-warning" id="statHwCount">-</h3>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning"><i class="fa-solid fa-clipboard-check"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Logs Table -->
            <div class="main-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0"><i class="fa-solid fa-list-ul me-2 text-primary"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
                    <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadTeachingLogs()">
                        <i class="fa-solid fa-rotate me-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-custom table-hover align-middle">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>‡∏ß‡∏¥‡∏ä‡∏≤/‡∏´‡πâ‡∏≠‡∏á</th>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="teachingLogTable">
                            <tr><td colspan="6" class="text-center py-4 text-muted"><i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FAB -->
            <button class="fab-btn" onclick="openTeachingModal()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <!-- 2. STUDENT VIEW -->
        <div id="studentView" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0">üìã ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h4>
                <select id="studentClassFilter" class="form-select w-auto shadow-sm" onchange="loadStudentHomework()">
                    <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                    <optgroup label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                        <option value="‡∏õ.1/1">‡∏õ.1/1</option><option value="‡∏õ.1/2">‡∏õ.1/2</option>
                        <option value="‡∏õ.2/1">‡∏õ.2/1</option>
                        <option value="‡∏õ.3/1">‡∏õ.3/1</option><option value="‡∏õ.3/2">‡∏õ.3/2</option><option value="‡∏õ.3/3">‡∏õ.3/3</option>
                        <option value="‡∏õ.4/1">‡∏õ.4/1</option><option value="‡∏õ.4/2">‡∏õ.4/2</option><option value="‡∏õ.4/3">‡∏õ.4/3</option>
                        <option value="‡∏õ.5/1">‡∏õ.5/1</option><option value="‡∏õ.5/2">‡∏õ.5/2</option><option value="‡∏õ.5/3">‡∏õ.5/3</option>
                        <option value="‡∏õ.6/1">‡∏õ.6/1</option><option value="‡∏õ.6/2">‡∏õ.6/2</option>
                    </optgroup>
                    <optgroup label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                        <option value="‡∏°.1/1" selected>‡∏°.1/1</option><option value="‡∏°.1/2">‡∏°.1/2</option>
                        <option value="‡∏°.2/1">‡∏°.2/1</option><option value="‡∏°.2/2">‡∏°.2/2</option>
                        <option value="‡∏°.3/1">‡∏°.3/1</option><option value="‡∏°.3/2">‡∏°.3/2</option>
                        <option value="‡∏°.4/1">‡∏°.4/1</option><option value="‡∏°.4/2">‡∏°.4/2</option>
                        <option value="‡∏°.5/1">‡∏°.5/1</option><option value="‡∏°.5/2">‡∏°.5/2</option>
                        <option value="‡∏°.6/1">‡∏°.6/1</option><option value="‡∏°.6/2">‡∏°.6/2</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="row g-3" id="studentHomeworkList">
                <!-- JS Inject -->
            </div>
        </div>

    </div>

    <!-- Modal: Teaching Log Form (Teacher) -->
    <div class="modal fade" id="teachingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô & ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    
                    <!-- Steps -->
                    <div class="step-container">
                        <div class="step-item active" id="step1" onclick="showStep(1)">1</div>
                        <div class="step-item" id="step2" onclick="showStep(2)">2</div>
                        <div class="step-item" id="step3" onclick="showStep(3)">3</div>
                    </div>

                    <form id="teachingForm">
                        <!-- Step 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                        <div id="formStep1" class="form-section active">
                            <h6 class="fw-bold text-primary mb-3">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô</label>
                                    <input type="date" id="tDate" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà</label>
                                    <select id="tPeriod" class="form-select">
                                        <option value="1">1 (08:30-09:20)</option>
                                        <option value="2">2 (09:20-10:10)</option>
                                        <option value="3">3 (10:10-11:00)</option>
                                        <option value="4">4 (11:00-11:50)</option>
                                        <option value="5">5 (13:00-13:50)</option>
                                        <option value="6">6 (13:50-14:40)</option>
                                        <option value="7">7 (14:40-15:30)</option>
                                        <option value="8">8 (15:30-16:20)</option>
                                        <option value="9">9 (16:20-17:10)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">‡∏ß‡∏¥‡∏ä‡∏≤</label>
                                    <input type="text" id="tSubject" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</label>
                                    <select id="tClass" class="form-select" onchange="loadStudentsForCheck()">
                                        <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                                        <optgroup label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                                            <option value="‡∏õ.1/1">‡∏õ.1/1</option><option value="‡∏õ.1/2">‡∏õ.1/2</option>
                                            <option value="‡∏õ.2/1">‡∏õ.2/1</option>
                                            <option value="‡∏õ.3/1">‡∏õ.3/1</option><option value="‡∏õ.3/2">‡∏õ.3/2</option><option value="‡∏õ.3/3">‡∏õ.3/3</option>
                                            <option value="‡∏õ.4/1">‡∏õ.4/1</option><option value="‡∏õ.4/2">‡∏õ.4/2</option><option value="‡∏õ.4/3">‡∏õ.4/3</option>
                                            <option value="‡∏õ.5/1">‡∏õ.5/1</option><option value="‡∏õ.5/2">‡∏õ.5/2</option><option value="‡∏õ.5/3">‡∏õ.5/3</option>
                                            <option value="‡∏õ.6/1">‡∏õ.6/1</option><option value="‡∏õ.6/2">‡∏õ.6/2</option>
                                        </optgroup>
                                        <optgroup label="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                                            <option value="‡∏°.1/1">‡∏°.1/1</option><option value="‡∏°.1/2">‡∏°.1/2</option>
                                            <option value="‡∏°.2/1">‡∏°.2/1</option><option value="‡∏°.2/2">‡∏°.2/2</option>
                                            <option value="‡∏°.3/1">‡∏°.3/1</option><option value="‡∏°.3/2">‡∏°.3/2</option>
                                            <option value="‡∏°.4/1">‡∏°.4/1</option><option value="‡∏°.4/2">‡∏°.4/2</option>
                                            <option value="‡∏°.5/1">‡∏°.5/1</option><option value="‡∏°.5/2">‡∏°.5/2</option>
                                            <option value="‡∏°.6/1">‡∏°.6/1</option><option value="‡∏°.6/2">‡∏°.6/2</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small text-muted">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô / ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                                    <textarea id="tTopic" class="form-control" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå..."></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small text-muted">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="tType" id="typeOnsite" value="Onsite" checked>
                                        <label class="btn btn-outline-secondary" for="typeOnsite">Onsite</label>
                                        <input type="radio" class="btn-check" name="tType" id="typeOnline" value="Online">
                                        <label class="btn btn-outline-secondary" for="typeOnline">Online</label>
                                        <input type="radio" class="btn-check" name="tType" id="typeHybrid" value="Hybrid">
                                        <label class="btn btn-outline-secondary" for="typeHybrid">Hybrid</label>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="nextStep(2)">‡∏ï‡πà‡∏≠‡πÑ‡∏õ <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                        </div>

                        <!-- Step 2: ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠ -->
                        <div id="formStep2" class="form-section">
                            <h6 class="fw-bold text-primary mb-3">2. ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (<span id="stdCount">0</span> ‡∏Ñ‡∏ô)</h6>
                            <div class="alert alert-info py-2 small"><i class="fa-solid fa-info-circle"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
                            <div class="table-responsive border rounded-3" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                            <th class="text-center" style="width: 180px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceList">
                                        <!-- JS Generate -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4" onclick="prevStep(1)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="nextStep(3)">‡∏ï‡πà‡∏≠‡πÑ‡∏õ <i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                        </div>

                        <!-- Step 3: ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô & ‡∏™‡∏£‡∏∏‡∏õ -->
                        <div id="formStep3" class="form-section">
                            <h6 class="fw-bold text-primary mb-3">3. ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô</h6>
                            
                            <div class="form-check form-switch mb-3 p-3 bg-white border rounded-3">
                                <input class="form-check-input" type="checkbox" id="hasHomework" onchange="toggleHomeworkSection()">
                                <label class="form-check-label fw-bold ms-2" for="hasHomework">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô/‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</label>
                            </div>

                            <div id="homeworkFields" class="p-3 bg-warning bg-opacity-10 rounded-3 border border-warning mb-3 hidden">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label class="small text-muted">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</label>
                                        <input type="text" id="hwTitle" class="form-control fw-bold" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏ó‡∏µ‡πà 1.2">
                                    </div>
                                    <div class="col-6">
                                        <label class="small text-muted">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
                                        <input type="datetime-local" id="hwDeadline" class="form-control">
                                    </div>
                                    <div class="col-6">
                                        <label class="small text-muted">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</label>
                                        <input type="number" id="hwScore" class="form-control" value="10">
                                    </div>
                                    <div class="col-12">
                                        <label class="small text-muted">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                        <textarea id="hwDesc" class="form-control" rows="2" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small text-muted">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏ô (Reflection)</label>
                                <textarea id="tReflection" class="form-control" rows="2" placeholder="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-light rounded-pill px-4" onclick="prevStep(2)">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                                <button type="button" class="btn btn-success rounded-pill px-4 fw-bold shadow-sm" onclick="submitTeachingLog()">
                                    <i class="fa-solid fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Submit Homework (Student) -->
    <div class="modal fade" id="submitModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-paper-plane me-2"></i>‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="submitDocId">
                    <h6 class="fw-bold mb-3" id="submitHwTitle">...</h6>
                    
                    <div class="mb-3">
                        <label class="form-label small text-muted">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏£‡∏π</label>
                        <textarea id="submitMsg" class="form-control" rows="3" placeholder="‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                    </div>

                    <div class="upload-zone mb-3" onclick="document.getElementById('submitFile').click()">
                        <i class="fa-solid fa-cloud-arrow-up fa-2x text-primary mb-2"></i>
                        <p class="mb-0 text-muted small">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏á‡∏≤‡∏ô (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/PDF) <br> <span class="text-danger small">*‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 300KB</span></p>
                        <input type="file" id="submitFile" class="d-none" accept="image/*,.pdf">
                        <div id="fileName" class="small text-success mt-2"></div>
                    </div>

                    <div class="d-grid">
                        <button class="btn btn-success rounded-pill fw-bold" onclick="confirmSubmission()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üî• Modal: Grading Homework (Teacher) -->
    <div class="modal fade" id="gradingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-clipboard-check me-2"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <h6 class="fw-bold mb-3" id="gradeHwTitle">...</h6>
                    <input type="hidden" id="gradeDocId">
                    <input type="hidden" id="gradeMaxScore">
                    
                    <div class="table-responsive border rounded-3" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á</th>
                                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                                    <th>‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="gradingList">
                                <!-- JS Inject -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: View Files List (Teacher) -->
    <div class="modal fade" id="filesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">üìÇ ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="fileListContainer" class="d-grid gap-2">
                        <!-- JS will inject buttons here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, query, where, orderBy, limit, getDocs, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM", 
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let mockStudents = [
            {id: 's1', name: '‡∏î.‡∏ä. ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ'}, {id: 's2', name: '‡∏î.‡∏ç. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'},
            {id: 's3', name: '‡∏î.‡∏ä. ‡πÄ‡∏Å‡πà‡∏á ‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç'}, {id: 's4', name: '‡∏î.‡∏ç. ‡∏°‡∏≤‡∏ô‡∏µ ‡∏°‡∏µ‡∏ï‡∏≤'}
        ];

        onAuthStateChanged(auth, (user) => {
            if (user) { 
                currentUser = user; 
                loadTeachingLogs(); 
            } else { 
                window.location.href = "index.html"; 
            }
        });

        // --- Helper: Preview File Global Function ---
        window.previewFile = (url) => {
            if (!url) {
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå', 'error');
                return;
            }
            // Check if URL (Firebase Storage) or Base64
            if (url.startsWith('http')) {
                window.open(url, '_blank');
            } else {
                // Base64 fallback
                const win = window.open();
                if (win) {
                    win.document.write(`<iframe src="${url}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
                    win.document.title = "Preview File";
                } else {
                    Swal.fire('Blocked', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Pop-up ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå', 'warning');
                }
            }
        };

        // --- Helper: Convert File to Base64 ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- UI Logic ---
        window.switchRole = (role) => {
            if(role === 'teacher') {
                document.getElementById('teacherView').classList.remove('hidden');
                document.getElementById('studentView').classList.add('hidden');
            } else {
                document.getElementById('teacherView').classList.add('hidden');
                document.getElementById('studentView').classList.remove('hidden');
                loadStudentHomework();
            }
        }

        window.openTeachingModal = () => {
            document.getElementById('teachingForm').reset();
            document.getElementById('tDate').valueAsDate = new Date();
            document.getElementById('attendanceList').innerHTML = '<tr><td colspan="2" class="text-center text-muted py-3">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô</td></tr>';
            document.getElementById('stdCount').innerText = '0';
            toggleHomeworkSection();
            showStep(1);
            new bootstrap.Modal(document.getElementById('teachingModal')).show();
        };

        window.showStep = (step) => {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`formStep${step}`).classList.add('active');
            for(let i=1; i<=3; i++) {
                const el = document.getElementById(`step${i}`);
                el.classList.remove('active', 'completed');
                if(i < step) el.classList.add('completed');
                if(i === step) el.classList.add('active');
            }
        };

        window.nextStep = (step) => showStep(step);
        window.prevStep = (step) => showStep(step);
        window.toggleHomeworkSection = () => {
            const chk = document.getElementById('hasHomework').checked;
            const sec = document.getElementById('homeworkFields');
            if(chk) sec.classList.remove('hidden'); else sec.classList.add('hidden');
        };

        window.loadStudentsForCheck = () => {
            const cls = document.getElementById('tClass').value;
            const tbody = document.getElementById('attendanceList');
            tbody.innerHTML = '';
            document.getElementById('stdCount').innerText = mockStudents.length;
            mockStudents.forEach(s => {
                tbody.innerHTML += `
                    <tr><td>${s.name}</td><td class="text-center"><div class="btn-group btn-group-sm w-100"><input type="radio" class="btn-check" name="att_${s.id}" id="p_${s.id}" value="present" checked><label class="btn btn-outline-success" for="p_${s.id}">‡∏°‡∏≤</label><input type="radio" class="btn-check" name="att_${s.id}" id="l_${s.id}" value="late"><label class="btn btn-outline-warning" for="l_${s.id}">‡∏™‡∏≤‡∏¢</label><input type="radio" class="btn-check" name="att_${s.id}" id="a_${s.id}" value="absent"><label class="btn btn-outline-danger" for="a_${s.id}">‡∏Ç‡∏≤‡∏î</label></div></td></tr>
                `;
            });
        };

        // --- Teacher Submit ---
        window.submitTeachingLog = async () => {
            const date = document.getElementById('tDate').value;
            const subject = document.getElementById('tSubject').value;
            const classroom = document.getElementById('tClass').value;
            if(!date || !subject || !classroom) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤', 'warning'); return; }

            const formData = {
                teacherId: currentUser.uid, teacherName: currentUser.displayName||"‡∏Ñ‡∏£‡∏π", date: date, period: document.getElementById('tPeriod').value,
                subject: subject, classroom: classroom, topic: document.getElementById('tTopic').value, type: document.querySelector('input[name="tType"]:checked').value,
                reflection: document.getElementById('tReflection').value, hasHomework: document.getElementById('hasHomework').checked, timestamp: serverTimestamp()
            };
            
            const attendance = {};
            const rows = document.querySelectorAll('#attendanceList tr');
            if(rows.length>0) mockStudents.forEach(s => { const el=document.querySelector(`input[name="att_${s.id}"]:checked`); if(el) attendance[s.id]=el.value; });
            formData.attendance = attendance;

            if(formData.hasHomework) {
                formData.homework = {
                    title: document.getElementById('hwTitle').value||"‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô", deadline: document.getElementById('hwDeadline').value,
                    score: document.getElementById('hwScore').value, description: document.getElementById('hwDesc').value,
                    submissions: [] // Array to store student submissions
                };
            }

            Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading() });
            try {
                await addDoc(collection(db, "teaching_logs"), formData);
                Swal.fire({ icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer:1500, showConfirmButton:false });
                bootstrap.Modal.getInstance(document.getElementById('teachingModal')).hide();
                loadTeachingLogs();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.loadTeachingLogs = async () => {
            const tbody = document.getElementById('teachingLogTable');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
            const q = query(collection(db, "teaching_logs"), where("teacherId", "==", currentUser.uid), orderBy("timestamp", "desc"), limit(10));
            try {
                const snap = await getDocs(q);
                tbody.innerHTML = '';
                let todayCount = 0; let hwCount = 0;
                const todayStr = new Date().toISOString().split('T')[0];
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td></tr>'; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.date ? new Date(d.date).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'}) : '-';
                    const hwBadge = d.hasHomework ? '<span class="badge bg-warning text-dark rounded-pill">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</span>' : '<span class="badge bg-light text-muted border rounded-pill">‡πÑ‡∏°‡πà‡∏°‡∏µ</span>';
                    if(d.date === todayStr) todayCount++;
                    if(d.hasHomework) hwCount++;

                    // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô
                    let actionBtn = `<button class="btn btn-sm btn-light text-primary" onclick="Swal.fire('‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', '${d.topic || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"}', 'info')"><i class="fa-solid fa-eye"></i></button>`;
                    if(d.hasHomework) {
                        actionBtn += ` <button class="btn btn-sm btn-warning text-dark ms-1" onclick="openGradingModal('${doc.id}')"><i class="fa-solid fa-check-double"></i> ‡∏ï‡∏£‡∏ß‡∏à</button>`;
                    }

                    tbody.innerHTML += `<tr><td><div class="fw-bold">${date}</div><small class="text-muted">‡∏Ñ‡∏≤‡∏ö ${d.period}</small></td><td><div class="fw-bold text-primary">${d.subject}</div><small>${d.classroom}</small></td><td>${d.topic||'-'}</td><td>${hwBadge}</td><td><span class="status-badge status-submitted"><i class="fa-solid fa-check"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span></td><td>${actionBtn}</td></tr>`;
                });
                document.getElementById('statTodayCount').innerText = todayCount;
                document.getElementById('statHwCount').innerText = hwCount;
            } catch(e) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firebase ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</td></tr>'; }
        }

        // --- Teacher Grading Logic (UPDATED üî•) ---
        window.openGradingModal = async (docId) => {
            const list = document.getElementById('gradingList');
            list.innerHTML = '<tr><td colspan="5" class="text-center py-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á...</td></tr>';
            new bootstrap.Modal(document.getElementById('gradingModal')).show();

            try {
                const docSnap = await getDoc(doc(db, "teaching_logs", docId));
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    const hw = data.homework || {};
                    const submissions = hw.submissions || [];
                    
                    document.getElementById('gradeHwTitle').innerText = `‡∏á‡∏≤‡∏ô: ${hw.title} (‡πÄ‡∏ï‡πá‡∏° ${hw.score || 10})`;
                    document.getElementById('gradeDocId').value = docId;
                    document.getElementById('gradeMaxScore').value = hw.score || 10;
                    
                    if(submissions.length === 0) {
                        list.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</td></tr>';
                        return;
                    }

                    list.innerHTML = '';
                    // Reset temp storage for files
                    window.tempStudentFiles = {};

                    submissions.forEach(sub => {
                        const date = new Date(sub.submittedAt).toLocaleString('th-TH');
                        const scoreVal = sub.score !== undefined ? sub.score : '';
                        const feedbackVal = sub.feedback || '';
                        
                        // üî• Logic ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå
                        let fileDisplay = '-';
                        
                        if (sub.attachments && sub.attachments.length > 0) {
                            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå (‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà)
                            window.tempStudentFiles[sub.studentId] = sub.attachments;
                            fileDisplay = `<button class="btn btn-sm btn-outline-info text-dark" onclick="viewStudentFiles('${sub.studentId}')">
                                <i class="fa-solid fa-folder-open"></i> ‡πÑ‡∏ü‡∏•‡πå (${sub.attachments.length})
                            </button>`;
                        } else if (sub.fileData) {
                             // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ Base64)
                             fileDisplay = `<button class="btn btn-sm btn-outline-info text-dark" onclick="previewFile('${sub.fileData}')"><i class="fa-solid fa-file-invoice"></i> ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</button>`;
                        } else if (sub.hasFile) {
                             fileDisplay = '<span class="badge bg-secondary">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)</span>';
                        }

                        list.innerHTML += `
                            <tr>
                                <td><div class="fw-bold">${sub.studentName}</div><small class="text-muted">${date}</small></td>
                                <td>${sub.message || '-'} <br>${fileDisplay}</td>
                                <td style="width:100px"><input type="number" class="form-control form-control-sm" id="score_${sub.studentId}" value="${scoreVal}" max="${hw.score}"></td>
                                <td><input type="text" class="form-control form-control-sm" id="feedback_${sub.studentId}" value="${feedbackVal}" placeholder="‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå..."></td>
                                <td><button class="btn btn-sm btn-success" onclick="saveGrade('${docId}', '${sub.studentId}')"><i class="fa-solid fa-save"></i></button></td>
                            </tr>
                        `;
                    });
                }
            } catch(e) { console.error(e); }
        };

        // Function to view student files in modal
        window.viewStudentFiles = (studentId) => {
            const files = window.tempStudentFiles[studentId] || [];
            const container = document.getElementById('fileListContainer');
            container.innerHTML = '';

            files.forEach(file => {
                const fileUrl = file.url || file.data;
                // Escape simple quotes
                const safeUrl = fileUrl ? fileUrl.replace(/'/g, "\\'") : '';

                container.innerHTML += `
                    <button class="btn btn-light border text-start p-3 d-flex justify-content-between align-items-center" onclick="previewFile('${safeUrl}')">
                        <div class="text-truncate" style="max-width: 300px;">
                            <i class="fa-solid fa-file-lines text-primary me-2"></i>
                            <span class="fw-bold text-dark">${file.name}</span>
                        </div>
                        <i class="fa-solid fa-arrow-up-right-from-square text-muted"></i>
                    </button>
                `;
            });

            new bootstrap.Modal(document.getElementById('filesModal')).show();
        };

        window.saveGrade = async (docId, studentId) => {
            const score = document.getElementById(`score_${studentId}`).value;
            const feedback = document.getElementById(`feedback_${studentId}`).value;
            
            try {
                const docRef = doc(db, "teaching_logs", docId);
                const docSnap = await getDoc(docRef);
                const data = docSnap.data();
                const submissions = data.homework.submissions;

                // Find and update specific submission
                const updatedSubmissions = submissions.map(sub => {
                    if(sub.studentId === studentId) {
                        return { ...sub, score: score, feedback: feedback, gradedAt: new Date().toISOString() };
                    }
                    return sub;
                });

                await updateDoc(docRef, { "homework.submissions": updatedSubmissions });
                Swal.fire({ icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß', toast:true, position:'top-end', showConfirmButton:false, timer:1500 });
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        // --- Student View & Submission ---
        window.loadStudentHomework = async () => {
            const container = document.getElementById('studentHomeworkList');
            const selectedClass = document.getElementById('studentClassFilter').value;
            container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';
            try {
                const q = query(collection(db, "teaching_logs"), where("classroom", "==", selectedClass), where("hasHomework", "==", true), orderBy("timestamp", "desc"), limit(10));
                const snap = await getDocs(q);
                container.innerHTML = '';
                if(snap.empty) { container.innerHTML = `<div class="col-12 text-center text-muted py-5"><i class="fa-solid fa-check-circle fa-3x mb-3 text-success opacity-50"></i><p>‡πÄ‡∏¢‡πâ! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${selectedClass}</p></div>`; return; }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const hw = d.homework || {};
                    const deadline = hw.deadline ? new Date(hw.deadline).toLocaleString('th-TH', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}) : '‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
                    
                    // Check submission status
                    const mySub = hw.submissions ? hw.submissions.find(sub => sub.studentId === currentUser.uid) : null;
                    const isSubmitted = !!mySub;
                    const isGraded = mySub && mySub.score !== undefined;
                    
                    let statusBadge = '<span class="badge bg-warning text-dark">‡∏£‡∏≠‡∏™‡πà‡∏á</span>';
                    let btnAction = `<button class="btn btn-sm btn-primary rounded-pill px-3" onclick="openSubmitModal('${doc.id}', '${hw.title}')">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
                    let gradeInfo = '';

                    if(isSubmitted) {
                        statusBadge = '<span class="badge bg-success">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>';
                        btnAction = `<button class="btn btn-sm btn-outline-success rounded-pill px-3" disabled><i class="fa-solid fa-check"></i> ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>`;
                        if(isGraded) {
                            statusBadge = '<span class="badge bg-info text-dark">‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
                            gradeInfo = `<div class="mt-2 p-2 bg-light rounded border text-start small"><strong class="text-primary">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${mySub.score}/${hw.score}</strong><br><span class="text-muted">‡∏Ñ‡∏£‡∏π: ${mySub.feedback || '-'}</span></div>`;
                        }
                    }

                    container.innerHTML += `
                        <div class="col-md-6 col-lg-4">
                            <div class="card h-100 border-start border-4 ${isSubmitted ? 'border-success' : 'border-warning'} shadow-sm hover-shadow transition">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        ${statusBadge}
                                        <small class="text-muted fw-bold">${d.subject}</small>
                                    </div>
                                    <h6 class="fw-bold mb-2">${hw.title}</h6>
                                    <p class="text-muted small mb-3 text-truncate-2">${hw.description || '-'}</p>
                                    ${gradeInfo}
                                    <div class="d-flex justify-content-between align-items-center mt-auto pt-3 border-top">
                                        <small class="text-danger"><i class="fa-regular fa-clock me-1"></i>${deadline}</small>
                                        ${btnAction}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch(e) { console.error(e); container.innerHTML = '<div class="col-12 text-center text-danger">Index Missing?</div>'; }
        }

        // --- Submission Modal Logic ---
        window.openSubmitModal = (docId, title) => {
            document.getElementById('submitDocId').value = docId;
            document.getElementById('submitHwTitle').innerText = title;
            document.getElementById('submitMsg').value = '';
            document.getElementById('submitFile').value = '';
            document.getElementById('fileName').innerText = '';
            new bootstrap.Modal(document.getElementById('submitModal')).show();
        };

        document.getElementById('submitFile').addEventListener('change', function(){
            const file = this.files[0];
            if(file) {
                // Check size < 300KB
                if(file.size > 300 * 1024) {
                    Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 300KB ‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                    this.value = ''; // Reset
                    document.getElementById('fileName').innerText = '';
                    return;
                }
                document.getElementById('fileName').innerText = `‡πÑ‡∏ü‡∏•‡πå: ${file.name}`;
            }
        });

        // üî• Submit with File Upload Logic
        window.confirmSubmission = async () => {
            const docId = document.getElementById('submitDocId').value;
            const message = document.getElementById('submitMsg').value;
            const fileInput = document.getElementById('submitFile');
            const file = fileInput.files[0];

            Swal.fire({ title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô...', text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...', didOpen:()=>Swal.showLoading() });

            try {
                let fileBase64 = null;
                if(file) {
                    fileBase64 = await toBase64(file);
                }

                const submissionData = {
                    studentId: currentUser.uid,
                    studentName: currentUser.displayName || '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    submittedAt: new Date().toISOString(),
                    message: message,
                    hasFile: !!fileBase64,
                    fileName: file ? file.name : null,
                    fileData: fileBase64 // Store base64 string
                };

                const docRef = doc(db, "teaching_logs", docId);
                await updateDoc(docRef, { "homework.submissions": arrayUnion(submissionData) });
                Swal.fire({ icon:'success', title:'‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', timer:1500, showConfirmButton:false });
                bootstrap.Modal.getInstance(document.getElementById('submitModal')).hide();
                loadStudentHomework();
            } catch(e) {
                console.error(e);
                Swal.fire('Error', '‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
            }
        };

    </script>
</body>
</html>