<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ - School System</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; color: #333; }
        .dashboard-header { 
            background: linear-gradient(135deg, #198754, #20c997); color: white; 
            padding: 40px 20px; border-radius: 0 0 30px 30px; margin-bottom: 40px; 
            box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3);
        }
        .card-request { 
            border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            margin-bottom: 20px; border-left: 6px solid #198754; background-color: #fff;
            transition: transform 0.2s;
        }
        .card-request:hover { transform: translateY(-3px); }
        .tab-btn { 
            border-radius: 50px; padding: 10px 30px; border: 2px solid #198754; 
            color: #198754; background: white; font-weight: 600; transition: all 0.3s ease; 
        }
        .tab-btn.active { background-color: #198754; color: white; box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4); }
        .table-responsive { border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .table thead th { background-color: #f1f3f5; padding: 15px; }
        .table tbody td { padding: 15px; vertical-align: middle; }
        .badge-custom { padding: 6px 12px; border-radius: 20px; font-weight: 500; font-size: 0.85rem; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container">
            <span class="navbar-brand fw-bold"><i class="fa-solid fa-van-shuttle me-2"></i>‡∏á‡∏≤‡∏ô‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</span>
            <a href="dashboard.html" class="btn btn-sm btn-outline-light rounded-pill px-3">
                <i class="fa-solid fa-arrow-left me-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>
    </nav>

    <div class="dashboard-header text-center">
        <h2 class="fw-bold mb-2"><i class="fa-solid fa-calendar-check me-2"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏ñ</h2>
        <p class="mb-0 opacity-75">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</p>
    </div>

    <div class="container mb-5">
        
        <div class="d-flex justify-content-center gap-3 mb-5">
            <button class="tab-btn active" id="btn-active" onclick="switchTab('active')">
                <i class="fa-solid fa-list-check me-1"></i> <span id="tab-active-text">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
            </button>
            <button class="tab-btn" id="btn-history" onclick="switchTab('history')">
                <i class="fa-solid fa-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏ñ
            </button>
        </div>

        <div id="content-active" style="display: block;">
            <div id="activeList">
                <div class="text-center py-5 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <div id="content-history" style="display: none;">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive bg-white">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                                    <th>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr><td colspan="5" class="text-center py-5 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, addDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• Config ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡πå‡∏°
        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const driverOptions = {
            'driver1': '‡∏ô‡∏Ç-7613 ‡∏ö‡∏∏‡∏ç‡∏®‡∏£‡∏µ ‡∏ß‡∏¥‡∏ä‡∏±‡∏¢‡πÇ‡∏¢',
            'driver2': '‡∏ô‡∏Ç-2600 ‡∏Å‡∏¥‡∏ï‡∏¥‡∏û‡∏á‡∏®‡πå ‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏π',
            'driver3': '‡∏ô‡∏Ç-6123 ‡∏ì‡∏±‡∏ê‡∏ß‡∏∏‡∏í‡∏¥ ‡∏™‡∏≤‡∏¢‡πÅ‡∏ß‡∏ß'
        };

        let currentUserRole = "";

        window.switchTab = (tabName) => {
            if (tabName === 'active') {
                document.getElementById('content-active').style.display = 'block';
                document.getElementById('content-history').style.display = 'none';
                document.getElementById('btn-active').classList.add('active');
                document.getElementById('btn-history').classList.remove('active');
            } else {
                document.getElementById('content-active').style.display = 'none';
                document.getElementById('content-history').style.display = 'block';
                document.getElementById('btn-active').classList.remove('active');
                document.getElementById('btn-history').classList.add('active');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if(userDoc.exists()) {
                        currentUserRole = userDoc.data().role;
                        
                        // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏ï‡∏≤‡∏° Role
                        if (currentUserRole === 'admin') {
                            document.getElementById('tab-active-text').innerText = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Admin)';
                        } else if (currentUserRole === 'transport') {
                            document.getElementById('tab-active-text').innerText = '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢';
                        } else {
                            // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Role ‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏•‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                            Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', confirmButtonColor: '#dc3545' }).then(()=>window.location.href='dashboard.html');
                            return;
                        }
                        
                        loadRequests();
                    }
                } catch(e) { console.error(e); }
            } else { window.location.href = "index.html"; }
        });

        function loadRequests() {
            const q = collection(db, "vehicle_requests");
            
            onSnapshot(q, (snapshot) => {
                const activeList = document.getElementById('activeList');
                const historyBody = document.getElementById('historyTableBody');
                
                activeList.innerHTML = "";
                historyBody.innerHTML = "";

                let activeItems = [];
                let historyItems = [];

                snapshot.forEach(doc => { 
                    const data = { id: doc.id, ...doc.data() };
                    
                    // üî• Logic ‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏° Role üî•
                    if (currentUserRole === 'admin') {
                        // Admin: ‡πÄ‡∏´‡πá‡∏ô 'pending' ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Active, ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏õ History
                        if (data.status === 'pending') {
                            activeItems.push(data);
                        } else {
                            historyItems.push(data);
                        }
                    } else if (currentUserRole === 'transport') {
                        // Transport (Driver): ‡πÄ‡∏´‡πá‡∏ô 'approved' ‡∏´‡∏£‡∏∑‡∏≠ 'in_progress' ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö Active
                        if (data.status === 'approved' || data.status === 'in_progress') {
                            activeItems.push(data);
                        } else if (data.status === 'completed') {
                            // Completed ‡πÑ‡∏õ History (Rejected ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÉ‡∏´‡πâ‡∏£‡∏Å‡πÉ‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏î‡∏π‡∏Å‡πá‡πÑ‡∏î‡πâ)
                            historyItems.push(data);
                        }
                    }
                });

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
                activeItems.sort((a, b) => new Date(a.use_date) - new Date(b.use_date));
                historyItems.sort((a, b) => (b.created_at?.seconds || 0) - (a.created_at?.seconds || 0));

                // --- Render Active List ---
                if(activeItems.length === 0) {
                    let emptyMsg = currentUserRole === 'admin' ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡∏ö (‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á)";
                    activeList.innerHTML = `<div class="text-center py-5 text-muted opacity-50"><i class="fa-regular fa-calendar-check fa-2x mb-2"></i><br>${emptyMsg}</div>`;
                } else {
                    activeItems.forEach(data => {
                        const dateTxt = new Date(data.use_date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                        const email = data.reporterEmail || data.requester_email || ''; 
                        
                        let actionButtons = '';

                        // üî• ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò)
                        if (currentUserRole === 'admin' && data.status === 'pending') {
                            if (data.driver_name && data.driver_name !== '-') {
                                actionButtons = `<button class="btn btn-success rounded-pill px-4" onclick="approveDirect('${data.id}', '${data.destination}', '${email}', '${data.driver_name}')"><i class="fa-solid fa-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á)</button>`;
                            } else {
                                actionButtons = `<button class="btn btn-success rounded-pill px-4" onclick="approveSelect('${data.id}', '${data.destination}', '${email}')"><i class="fa-solid fa-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</button>`;
                            }
                            actionButtons += `<button class="btn btn-outline-danger rounded-pill px-4 ms-2" onclick="reject('${data.id}', '${data.destination}', '${email}')"><i class="fa-solid fa-xmark"></i></button>`;
                        }
                        
                        // üî• ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Driver (‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô/‡∏à‡∏ö‡∏á‡∏≤‡∏ô)
                        else if (currentUserRole === 'transport') {
                            if (data.status === 'approved') {
                                actionButtons = `<button class="btn btn-primary rounded-pill px-4 w-100" onclick="startJob('${data.id}', '${data.destination}', '${email}')"><i class="fa-solid fa-car-side"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô / ‡∏≠‡∏≠‡∏Å‡∏£‡∏ñ</button>`;
                            } else if (data.status === 'in_progress') {
                                actionButtons = `<button class="btn btn-warning text-dark rounded-pill px-4 w-100" onclick="finishJob('${data.id}', '${data.destination}', '${email}')"><i class="fa-solid fa-flag-checkered"></i> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô / ‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢</button>`;
                            }
                        }

                        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Card
                        let statusBadge = getStatusBadge(data.status);
                        
                        activeList.innerHTML += `
                            <div class="card card-request p-4">
                                <div class="row align-items-center">
                                    <div class="col-md-8 mb-3 mb-md-0">
                                        <div class="d-flex align-items-center mb-2">
                                            ${statusBadge}
                                            <h5 class="fw-bold mb-0 text-dark ms-2">${data.destination}</h5>
                                        </div>
                                        <div class="text-secondary mb-2">
                                            <i class="fa-regular fa-calendar-check me-2 text-success"></i> ${dateTxt} <span class="mx-1">|</span> ${data.start_time} - ${data.end_time} ‡∏ô.
                                        </div>
                                        <div class="d-flex align-items-center text-muted small">
                                            <div class="me-3"><i class="fa-solid fa-user-circle me-1"></i> ${data.reporterName}</div>
                                            <div class="me-3"><i class="fa-solid fa-users me-1"></i> ${data.passenger_count} ‡∏Ñ‡∏ô</div>
                                            <div class="text-primary"><i class="fa-solid fa-id-card"></i> ${data.driver_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} (${data.car_plate || '-'})</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        ${actionButtons}
                                    </div>
                                </div>
                            </div>`;
                    });
                }

                // --- Render History ---
                if(historyItems.length === 0) {
                    historyBody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -</td></tr>`;
                } else {
                    historyItems.forEach(data => {
                        const dateTxt = new Date(data.use_date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                        let historyDriver = data.driver_name || '-';
                        if(data.car_plate) historyDriver += ` (${data.car_plate})`;

                        historyBody.innerHTML += `
                            <tr>
                                <td class="fw-medium">${dateTxt}</td>
                                <td>${data.destination}</td>
                                <td>${data.reporterName}</td>
                                <td><span class="text-muted small">${historyDriver}</span></td>
                                <td>${getStatusBadge(data.status)}</td>
                            </tr>`;
                    });
                }
            });
        }

        // --- Admin Actions ---
        
        window.approveSelect = async (id, dest, email) => {
            const { value: driverInfo } = await Swal.fire({
                title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö/‡∏£‡∏ñ', input: 'select', inputOptions: driverOptions, inputPlaceholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö...',
                showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', confirmButtonColor: '#198754',
                inputValidator: (val) => !val && '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'
            });
            if (driverInfo) {
                const parts = driverOptions[driverInfo].split(' ');
                updateAndNotify(id, dest, email, 'approved', parts[0], parts.slice(1).join(' '), '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ');
            }
        };

        window.approveDirect = async (id, dest, email, driverName) => {
             const { value: plate } = await Swal.fire({
                title: `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ ${driverName}?`, html: '‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)', input: 'text', inputValue: '‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞‡∏ä‡πà‡∏≤‡∏á',
                showCancelButton: true, confirmButtonColor: '#198754', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'
            });
            if (plate) updateAndNotify(id, dest, email, 'approved', plate, driverName, '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ (‡∏Ç‡∏±‡∏ö‡πÄ‡∏≠‡∏á)');
        }

        window.reject = async (id, dest, email) => {
            const result = await Swal.fire({ title: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' });
            if (result.isConfirmed) updateAndNotify(id, dest, email, 'rejected', '-', '-', '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏ñ');
        };

        // --- Driver Actions ---

        window.startJob = async (id, dest, email) => {
            const result = await Swal.fire({ title: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á?', text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏ß‡πà‡∏≤ "‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß"', icon: 'info', showCancelButton: true, confirmButtonText: '‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', confirmButtonColor: '#0d6efd' });
            if (result.isConfirmed) updateAndNotify(id, dest, email, 'in_progress', null, null, 'üöó ‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß');
        };

        window.finishJob = async (id, dest, email) => {
            const result = await Swal.fire({ title: '‡∏à‡∏ö‡∏á‡∏≤‡∏ô/‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢?', text: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏Ç‡∏≠', icon: 'success', showCancelButton: true, confirmButtonText: '‡∏à‡∏ö‡∏á‡∏≤‡∏ô', confirmButtonColor: '#198754' });
            if (result.isConfirmed) updateAndNotify(id, dest, email, 'completed', null, null, 'üèÅ ‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≤‡∏¢/‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
        };

        // --- Core Update & Notify Function ---

        async function updateAndNotify(id, dest, email, status, plate, name, subject) {
             Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
             try {
                let updateData = { status: status };
                if(plate) updateData.car_plate = plate;
                if(name) updateData.driver_name = name;

                await updateDoc(doc(db, "vehicle_requests", id), updateData);
                
                if(email) {
                    let msgBody = "";
                    if(status === 'approved') msgBody = `<p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÑ‡∏õ <strong>${dest}</strong> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p><p>‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö: ${name} (${plate})</p>`;
                    else if(status === 'rejected') msgBody = `<p>‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÑ‡∏õ <strong>${dest}</strong> ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>`;
                    else if(status === 'in_progress') msgBody = `<p>‡∏£‡∏ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà <strong>${dest}</strong> ‡∏Ñ‡∏£‡∏±‡∏ö</p>`;
                    else if(status === 'completed') msgBody = `<p>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á <strong>${dest}</strong> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö</p>`;

                    await addDoc(collection(db, "mail"), {
                        to: email,
                        message: { 
                            subject: subject + `: ${dest}`, 
                            html: `<div style="font-family: sans-serif; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
                                    <h3 style="color: #333;">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ñ</h3>
                                    ${msgBody}
                                    <hr><p style="color: gray; font-size: 0.9em;">School Hub System</p>
                                   </div>` 
                        }
                    });
                }
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } catch (error) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        function getStatusBadge(status) {
            const map = { 
                'approved': '<span class="badge bg-success badge-custom">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏≠‡∏≠‡∏≠‡∏Å‡∏£‡∏ñ)</span>', 
                'in_progress': '<span class="badge bg-primary badge-custom"><i class="fa-solid fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</span>',
                'rejected': '<span class="badge bg-danger badge-custom">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>', 
                'completed': '<span class="badge bg-secondary badge-custom">‡∏à‡∏ö‡∏á‡∏≤‡∏ô</span>',
                'pending': '<span class="badge bg-warning text-dark badge-custom">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>'
            };
            return map[status] || status;
        }
    </script>
</body>
</html>