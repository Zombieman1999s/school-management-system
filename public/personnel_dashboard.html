<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• - School Hub</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f3e5f5; font-family: 'Sarabun', sans-serif; color: #4a148c; }
        
        .dashboard-header { 
            background: linear-gradient(135deg, #7b1fa2, #9c27b0); color: white; 
            padding: 40px 20px; border-radius: 0 0 30px 30px; margin-bottom: 30px; 
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
        }
        
        .tab-btn { 
            border-radius: 50px; padding: 10px 25px; border: 2px solid #7b1fa2; 
            color: #7b1fa2; background: white; font-weight: 600; transition: all 0.3s; 
        }
        .tab-btn.active { background-color: #7b1fa2; color: white; box-shadow: 0 4px 12px rgba(123, 31, 162, 0.3); }
        .tab-btn:hover:not(.active) { background-color: #f3e5f5; }

        .card-request { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; background: white; }
        .card-request:hover { transform: translateY(-3px); }
        
        /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πå‡∏î */
        .border-leave { border-left: 6px solid #9c27b0; }
        .border-outside { border-left: 6px solid #00acc1; }

        .badge-status { font-size: 0.85rem; padding: 5px 12px; border-radius: 20px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container">
            <span class="navbar-brand fw-bold"><i class="fa-solid fa-users-gear me-2"></i>‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span>
            <a href="dashboard.html" class="btn btn-sm btn-outline-light rounded-pill px-3">
                <i class="fa-solid fa-arrow-left me-1"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </a>
        </div>
    </nav>

    <div class="dashboard-header text-center">
        <h2 class="fw-bold mb-2"><i class="fa-solid fa-clipboard-check me-2"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</h2>
        <p class="mb-0 opacity-75">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</p>
    </div>

    <div class="container mb-5">
        
        <div class="d-flex justify-content-center gap-3 mb-4">
            <button class="tab-btn active" id="btn-leave" onclick="switchTab('leave')">
                <i class="fa-solid fa-file-medical me-1"></i> ‡πÉ‡∏ö‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏Å‡∏¥‡∏à
            </button>
            <button class="tab-btn" id="btn-outside" onclick="switchTab('outside')">
                <i class="fa-solid fa-person-walking-luggage me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
            </button>
        </div>

        <div id="content-leave" style="display: block;">
            <div id="leaveList">
                <div class="text-center py-5 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

        <div id="content-outside" style="display: none;">
            <div id="outsideList">
                <div class="text-center py-5 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, updateDoc, addDoc, getDoc, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.switchTab = (tabName) => {
            if (tabName === 'leave') {
                document.getElementById('content-leave').style.display = 'block';
                document.getElementById('content-outside').style.display = 'none';
                document.getElementById('btn-leave').classList.add('active');
                document.getElementById('btn-outside').classList.remove('active');
            } else {
                document.getElementById('content-leave').style.display = 'none';
                document.getElementById('content-outside').style.display = 'block';
                document.getElementById('btn-leave').classList.remove('active');
                document.getElementById('btn-outside').classList.add('active');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) {
                    const role = userDoc.data().role;
                    // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÅ‡∏•‡∏∞ Personnel
                    if(!['personnel', 'admin'].includes(role)) {
                        Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', text: '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' })
                            .then(()=>window.location.href='dashboard.html');
                        return;
                    }
                    loadData();
                }
            } else { window.location.href = "index.html"; }
        });

        function loadData() {
            // 1. ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏•‡∏≤ (Leave)
            onSnapshot(query(collection(db, "leave_requests"), orderBy("created_at", "desc")), (snapshot) => {
                const list = document.getElementById('leaveList');
                list.innerHTML = "";
                
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                
                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Approved/Rejected ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏°‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ
                // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÇ‡∏ä‡∏ß‡πå Pending ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                items.sort((a,b) => (a.status === 'pending' ? -1 : 1));

                if(items.length === 0) {
                    list.innerHTML = `<div class="text-center py-5 text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤ -</div>`;
                } else {
                    items.forEach(data => {
                        const dateTxt = `${new Date(data.start_date).toLocaleDateString('th-TH')} - ${new Date(data.end_date).toLocaleDateString('th-TH')}`;
                        const statusBadge = getStatusBadge(data.status);
                        const isPending = data.status === 'pending';

                        let btnGroup = '';
                        if(isPending) {
                            btnGroup = `
                                <div class="d-flex gap-2 justify-content-end mt-3 border-top pt-3">
                                    <button class="btn btn-success rounded-pill px-4" onclick="updateStatus('leave_requests', '${data.id}', 'approved', '${data.requester_email}', '‡πÉ‡∏ö‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')"><i class="fa-solid fa-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    <button class="btn btn-outline-danger rounded-pill px-4" onclick="updateStatus('leave_requests', '${data.id}', 'rejected', '${data.requester_email}', '‡πÉ‡∏ö‡∏•‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')"><i class="fa-solid fa-xmark"></i></button>
                                </div>`;
                        }

                        list.innerHTML += `
                            <div class="card card-request border-leave p-4">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="fw-bold text-dark mb-0">${data.leave_type}</h5>
                                    ${statusBadge}
                                </div>
                                <div class="text-muted small mb-3"><i class="fa-regular fa-calendar"></i> ${dateTxt} (‡∏£‡∏ß‡∏° ${data.total_days} ‡∏ß‡∏±‡∏ô)</div>
                                
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:35px; height:35px;">${data.requester_name.charAt(0)}</div>
                                    <div>
                                        <div class="fw-bold text-dark">${data.requester_name}</div>
                                        <div class="text-muted small">${data.requester_role}</div>
                                    </div>
                                </div>
                                
                                <div class="bg-light p-3 rounded text-secondary small">
                                    <i class="fa-solid fa-quote-left me-2 text-muted"></i> ${data.reason}
                                </div>
                                ${btnGroup}
                            </div>`;
                    });
                }
            });

            // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Outside)
            onSnapshot(query(collection(db, "outside_requests"), orderBy("created_at", "desc")), (snapshot) => {
                const list = document.getElementById('outsideList');
                list.innerHTML = "";
                
                let items = [];
                snapshot.forEach(doc => items.push({ id: doc.id, ...doc.data() }));
                items.sort((a,b) => (a.status === 'pending' ? -1 : 1));

                if(items.length === 0) {
                    list.innerHTML = `<div class="text-center py-5 text-muted">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà -</div>`;
                } else {
                    items.forEach(data => {
                        const dateTxt = new Date(data.out_date).toLocaleDateString('th-TH');
                        const statusBadge = getStatusBadge(data.status);
                        const isPending = data.status === 'pending';

                        let btnGroup = '';
                        if(isPending) {
                            btnGroup = `
                                <div class="d-flex gap-2 justify-content-end mt-3 border-top pt-3">
                                    <button class="btn btn-info text-white rounded-pill px-4" onclick="updateStatus('outside_requests', '${data.id}', 'approved', '${data.requester_email}', '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥')"><i class="fa-solid fa-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                    <button class="btn btn-outline-danger rounded-pill px-4" onclick="updateStatus('outside_requests', '${data.id}', 'rejected', '${data.requester_email}', '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà')"><i class="fa-solid fa-xmark"></i></button>
                                </div>`;
                        }

                        list.innerHTML += `
                            <div class="card card-request border-outside p-4">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="fw-bold text-dark mb-0">‡πÑ‡∏õ: ${data.destination}</h5>
                                    ${statusBadge}
                                </div>
                                <div class="text-muted small mb-3"><i class="fa-regular fa-clock"></i> ${dateTxt} | ${data.start_time} - ${data.end_time} ‡∏ô.</div>
                                
                                <div class="d-flex align-items-center mb-2">
                                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:35px; height:35px;">${data.requester_name.charAt(0)}</div>
                                    <div>
                                        <div class="fw-bold text-dark">${data.requester_name}</div>
                                        <div class="text-muted small">${data.requester_role} (${data.department})</div>
                                    </div>
                                </div>
                                
                                <div class="bg-light p-3 rounded text-secondary small">
                                    <div class="mb-1"><strong>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à:</strong> ${data.reason}</div>
                                    <div><strong>‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞:</strong> ${data.vehicle_type} ${data.license_plate ? '('+data.license_plate+')' : ''}</div>
                                </div>
                                ${btnGroup}
                            </div>`;
                    });
                }
            });
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•
        window.updateStatus = async (collectionName, id, status, email, subjectText) => {
            const confirmBtnColor = status === 'approved' ? '#198754' : '#dc3545';
            const actionText = status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';

            const result = await Swal.fire({
                title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£${actionText}?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: confirmBtnColor,
                confirmButtonText: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô${actionText}`
            });

            if (result.isConfirmed) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
                try {
                    await updateDoc(doc(db, collectionName, id), { status: status });
                    
                    // ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•
                    if(email) {
                        let colorHeader = status === 'approved' ? '#198754' : '#dc3545';
                        let msgBody = status === 'approved' 
                            ? `<p style="color:green;"><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</strong></p>`
                            : `<p style="color:red;"><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</strong></p>`;

                        await addDoc(collection(db, "mail"), {
                            to: email,
                            message: { 
                                subject: `üîî ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•: ${subjectText}`, 
                                html: `
                                    <div style="font-family: sans-serif; padding: 20px; border: 1px solid ${colorHeader}; border-radius: 10px;">
                                        <h2 style="color: ${colorHeader}; margin-top:0;">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠</h2>
                                        ${msgBody}
                                        <hr>
                                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö School Hub</p>
                                        <a href="#" style="background: ${colorHeader}; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                                    </div>
                                ` 
                            }
                        });
                    }
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        };

        function getStatusBadge(status) {
            const map = { 
                'approved': '<span class="badge bg-success badge-status">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>', 
                'rejected': '<span class="badge bg-danger badge-status">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>', 
                'pending': '<span class="badge bg-warning text-dark badge-status">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>',
                'ongoing': '<span class="badge bg-info text-dark badge-status">‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å</span>',
                'completed': '<span class="badge bg-secondary badge-status">‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß</span>'
            };
            return map[status] || `<span class="badge bg-secondary badge-status">${status}</span>`;
        }
    </script>
</body>
</html>