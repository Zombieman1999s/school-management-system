<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Meeting Assistant - School Hub</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å html2pdf ‡πÄ‡∏õ‡πá‡∏ô docxjs ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Word -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: #f0f2f5;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            color: #2d3748;
            padding-bottom: 50px; 
        }

        .navbar-custom {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        .navbar-brand { font-weight: 700; color: white !important; letter-spacing: 0.5px; }
        
        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white; border: none; border-radius: 30px;
            padding: 8px 20px; font-weight: 500; transition: all 0.3s;
            text-decoration: none; display: flex; align-items: center; gap: 8px;
        }
        .btn-back:hover { background: white; color: #333; transform: translateY(-2px); }

        .ai-card {
            background: var(--glass-bg);
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            border: var(--glass-border);
            overflow: hidden;
            margin-top: 20px;
            min-height: 85vh; 
        }

        .left-panel { padding: 30px; border-right: 1px solid #eee; }
        .right-panel { padding: 30px; background-color: #f8fafc; }

        .form-floating > .form-control { border-radius: 12px; border: 1px solid #e2e8f0; background: #fff; }
        .form-floating > .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
        .form-floating > label { color: #64748b; }

        .textarea-container { position: relative; }
        #rawContent { 
            border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; 
            resize: none; font-size: 1rem; line-height: 1.6;
            background: #fff; transition: all 0.3s;
        }
        #rawContent:focus { border-color: #667eea; outline: none; }

        .mic-wrapper { position: absolute; bottom: 20px; right: 20px; z-index: 10; }
        .mic-btn {
            width: 60px; height: 60px; border-radius: 50%;
            border: none; background: #fff; color: #4a5568;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .mic-btn:hover { transform: scale(1.1); color: #667eea; }
        
        .mic-active {
            background: #ef4444 !important; color: white !important;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .btn-generate {
            background: var(--primary-gradient); border: none;
            border-radius: 12px; padding: 15px; width: 100%;
            color: white; font-weight: 700; font-size: 1.1rem;
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
            transition: all 0.3s;
        }
        .btn-generate:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(118, 75, 162, 0.4); }
        .btn-generate:disabled { background: #cbd5e1; transform: none; cursor: not-allowed; box-shadow: none; }

        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .result-title { font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.5rem; }
        
        .markdown-content {
            background: white; border-radius: 16px; padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7;
            min-height: 400px; font-size: 1rem; line-height: 1.8; color: #374151;
        }
        .markdown-content h2 { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-top: 1.5em; margin-bottom: 0.8em; border-left: 4px solid #764ba2; padding-left: 12px; }
        .markdown-content ul { padding-left: 20px; }
        .markdown-content li { margin-bottom: 8px; }
        .markdown-content strong { color: #764ba2; }

        .btn-action-sm { border: 1px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; padding: 6px 12px; font-size: 0.85rem; transition: 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
        .btn-action-sm:hover { background: #f1f5f9; color: #333; }
        
        /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô Word */
        .btn-word-export { color: #2563eb; border-color: #bfdbfe; background: #eff6ff; }
        .btn-word-export:hover { background: #dbeafe; color: #1d4ed8; }

        .empty-state { text-align: center; color: #94a3b8; padding-top: 100px; }
        .empty-state i { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }

        .file-upload-zone {
            border: 2px dashed #cbd5e1; border-radius: 12px;
            padding: 15px; text-align: center; background: #f8fafc;
            margin-bottom: 15px; cursor: pointer; transition: all 0.2s;
        }
        .file-upload-zone:hover { border-color: #667eea; background: #eff6ff; }
        .file-upload-zone.has-file { border-color: #10b981; background: #ecfdf5; }

        @media (max-width: 768px) {
            .left-panel { border-right: none; border-bottom: 1px solid #eee; padding: 20px; }
            .right-panel { padding: 20px; }
            .ai-card { margin-top: 15px; border-radius: 15px; }
            .mic-btn { width: 55px; height: 55px; font-size: 1.3rem; }
        }
    </style>
</head>
<body>

    <nav class="navbar-custom sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fa-solid fa-wand-magic-sparkles me-2"></i> School Hub AI
            </a>
            <a href="dashboard.html" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i> <span class="d-none d-sm-inline">‡∏Å‡∏•‡∏±‡∏ö Dashboard</span>
            </a>
        </div>
    </nav>

    <div class="container mb-5">
        <div class="ai-card">
            <div class="row g-0 h-100">
                
                <div class="col-lg-5 left-panel">
                    <h4 class="fw-bold mb-4 text-dark"><i class="fa-solid fa-pen-to-square text-primary me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="topic" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠">
                        <label for="topic">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
                    </div>

                    <div class="form-floating mb-4">
                        <input type="text" class="form-control" id="participants" placeholder="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°">
                        <label for="participants">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏≠., ‡∏Ñ‡∏£‡∏π‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£)</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-secondary ms-1">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (mp3, wav, m4a) <span class="text-danger">*Max 100MB</span></label>
                        <input type="file" id="audioFile" class="d-none" accept="audio/*" onchange="handleFileSelect(this)">
                        <div class="file-upload-zone" onclick="document.getElementById('audioFile').click()">
                            <div id="uploadText">
                                <i class="fa-solid fa-cloud-arrow-up fs-3 text-secondary mb-2"></i><br>
                                <span class="small text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</span><br>
                                <span class="text-danger small" style="font-size: 0.7rem;">(‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô)</span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 position-relative textarea-container">
                        <label class="form-label fw-bold small text-secondary ms-1">‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡∏û‡∏π‡∏î/‡∏û‡∏¥‡∏°‡∏û‡πå)</label>
                        <textarea id="rawContent" class="form-control" rows="8" placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢... ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏á‡πÑ‡∏õ"></textarea>
                        
                        <div class="mic-wrapper">
                            <button id="btnMic" class="mic-btn" onclick="toggleRecording()" title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏π‡∏î">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="recordingStatus" class="align-items-center justify-content-center text-danger mb-3 fw-bold small" style="display:none; gap:8px;">
                        <span class="spinner-grow spinner-grow-sm" role="status"></span> 
                        <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏ô‡∏¥‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)</span>
                    </div>

                    <button onclick="generateSummary()" id="btnGenerate" class="btn-generate">
                        <i class="fa-solid fa-bolt me-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏ß‡∏¢ AI
                    </button>
                    
                    <div id="modelStatus" class="text-center mt-3 text-muted" style="font-size: 0.75rem; opacity: 0.7;">
                        Auto-detecting available model...
                    </div>
                </div>

                <div class="col-lg-7 right-panel">
                    <div class="result-header">
                        <div class="result-title"><i class="fa-brands fa-google me-2"></i>AI Summary</div>
                        <div>
                            <!-- üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏° PDF ‡πÄ‡∏õ‡πá‡∏ô Word Export -->
                            <button class="btn-action-sm btn-word-export shadow-sm me-2" onclick="exportToWord()">
                                <i class="fa-solid fa-file-word"></i> Word (.docx)
                            </button>
                            <button class="btn-action-sm shadow-sm" onclick="copyToClipboard()">
                                <i class="fa-regular fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                            </button>
                        </div>
                    </div>

                    <div id="aiOutput" class="markdown-content">
                        <div class="empty-state">
                            <i class="fa-solid fa-robot"></i>
                            <h5>‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì...</h5>
                            <p class="small">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢<br>‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô</p>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button onclick="saveToHistory()" id="btnSave" class="btn btn-success w-100 py-2 rounded-pill fw-bold shadow-sm" disabled>
                            <i class="fa-solid fa-floppy-disk me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        const GEMINI_API_KEY = "AIzaSyB9hNjZ6wG88cKITg9IA5d7UMiP9v-Cj5I"; 

        onAuthStateChanged(auth, (user) => { if(user) currentUser = user; else window.location.href = "index.html"; });

        let recognition;
        let isRecording = false;
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = true; 
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' ';
                }
                if (finalTranscript) {
                    const textarea = document.getElementById('rawContent');
                    textarea.value += finalTranscript;
                    textarea.scrollTop = textarea.scrollHeight;
                }
            };
            recognition.onerror = (e) => { console.error("Mic Error", e); stopRecording(); };
        } else {
            document.getElementById('btnMic').style.display = 'none';
        }

        window.toggleRecording = () => isRecording ? stopRecording() : startRecording();
        function startRecording() {
            isRecording = true; recognition.start();
            document.getElementById('btnMic').classList.add('mic-active');
            document.getElementById('btnMic').innerHTML = '<i class="fa-solid fa-stop"></i>';
            document.getElementById('recordingStatus').style.display = 'flex';
        }
        function stopRecording() {
            isRecording = false; recognition.stop();
            document.getElementById('btnMic').classList.remove('mic-active');
            document.getElementById('btnMic').innerHTML = '<i class="fa-solid fa-microphone"></i>';
            document.getElementById('recordingStatus').style.display = 'none';
        }

        let selectedAudioBase64 = null;
        let selectedAudioType = null;

        window.handleFileSelect = (input) => {
            const file = input.files[0];
            const zone = document.querySelector('.file-upload-zone');
            const text = document.getElementById('uploadText');

            if (file) {
                // üî• Allow up to 100MB
                if (file.size > 100 * 1024 * 1024) { 
                    Swal.fire({
                        icon: 'warning',
                        title: '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100MB',
                        html: '‡∏£‡∏∞‡∏ö‡∏ö Web-App ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100MB ‡∏Ñ‡∏£‡∏±‡∏ö<br>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏¢‡∏≤‡∏ß ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô',
                        footer: '<a href="https://www.mp3smaller.com/" target="_blank">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ü‡∏£‡∏µ (MP3Smaller)</a>'
                    });
                    input.value = '';
                    return;
                }
                zone.classList.add('has-file');
                text.innerHTML = `<i class="fa-solid fa-file-audio fs-3 text-success mb-2"></i><br><span class="fw-bold text-success">${file.name}</span><br><span class="small text-muted">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>`;
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedAudioBase64 = e.target.result.split(',')[1];
                    selectedAudioType = file.type;
                    text.innerHTML = `<i class="fa-solid fa-file-audio fs-3 text-success mb-2"></i><br><span class="fw-bold text-success">${file.name}</span><br><span class="small text-muted">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>`;
                };
                reader.readAsDataURL(file);
            } else {
                zone.classList.remove('has-file');
                selectedAudioBase64 = null;
                text.innerHTML = `<i class="fa-solid fa-cloud-arrow-up fs-3 text-secondary mb-2"></i><br><span class="small text-muted">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</span>`;
            }
        };

        async function callGeminiAPI(modelName, parts) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`;
            console.log("Calling Model:", modelName); 
            
            const response = await fetch(url, {
                method: "POST", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        async function checkAvailableModels() {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                const data = await response.json();
                if(data.models) {
                    const modelNames = data.models.map(m => m.name.replace('models/', ''));
                    console.log("Available Models for this Key:", modelNames);
                    return modelNames;
                }
            } catch (e) {
                console.error("Check models failed", e);
            }
            return [];
        }

        window.generateSummary = async () => {
            if (isRecording) stopRecording();
            
            const rawText = document.getElementById('rawContent').value;
            const topic = document.getElementById('topic').value;
            const hasAudio = !!selectedAudioBase64;

            if(!rawText && !hasAudio) { 
                Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏û‡∏π‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö' }); 
                return; 
            }

            const btn = document.getElementById('btnGenerate');
            const output = document.getElementById('aiOutput');
            const btnSave = document.getElementById('btnSave');
            const statusDiv = document.getElementById('modelStatus');
            
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> <span class="txt-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>';
            btn.disabled = true;
            output.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary mb-3"></div><p class="text-muted">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 1-2 ‡∏ô‡∏≤‡∏ó‡∏µ)</p></div>';

            try {
                let promptText = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ñ‡∏≠‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢:
                    ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°: ${topic || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}
                    
                    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:
                    1. ‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
                    2. ‡∏£‡∏∞‡∏ö‡∏∏‡∏°‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    3. ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡πà‡∏≠ (Action Plan) ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
                    
                    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Output (Markdown):
                    ## üìù ‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                    ...
                    ## ‚úÖ ‡∏°‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
                    ...
                    ## üöÄ Action Plan
                    ...`;

                if (rawText) promptText += `\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏à‡∏≤‡∏Å Note): "${rawText}"`;

                const parts = [{ text: promptText }];

                if (hasAudio) {
                    parts.push({
                        inlineData: {
                            mimeType: selectedAudioType || "audio/mp3",
                            data: selectedAudioBase64
                        }
                    });
                }

                let aiText;
                
                const CANDIDATE_MODELS = [
                    "gemini-2.0-flash",          
                    "gemini-2.0-flash-lite",     
                    "gemini-2.5-flash",          
                    "gemini-2.0-flash-exp",      
                    "gemini-flash-latest"        
                ];

                let success = false;
                let lastError = "";

                for (const model of CANDIDATE_MODELS) {
                    try {
                        statusDiv.innerText = `Trying Model: ${model}...`;
                        aiText = await callGeminiAPI(model, parts);
                        success = true;
                        statusDiv.innerText = `Success with Model: ${model}`;
                        break;
                    } catch (err) {
                        console.warn(`Model ${model} failed:`, err.message);
                        lastError = err.message;
                    }
                }

                if (!success) {
                    const availableModels = await checkAvailableModels();
                    let errorMsg = `‡∏ó‡∏∏‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Last Error: ${lastError})`;
                    if (availableModels.length > 0) {
                        errorMsg += `<br><br><b>Models ‡∏ó‡∏µ‡πà Key ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:</b><br>${availableModels.join(', ')}`;
                    } else {
                        errorMsg += `<br><br><b>‡πÑ‡∏°‡πà‡∏û‡∏ö Model ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:</b> ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡πÉ‡∏ô Google Cloud Console ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Gemini API ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á`;
                    }
                    throw new Error(errorMsg);
                }

                output.innerHTML = marked.parse(aiText);
                output.dataset.raw = aiText;
                btnSave.disabled = false;

            } catch (error) {
                console.error(error);
                let errMsg = error.message;
                if(errMsg.includes('400') || errMsg.includes('INVALID_ARGUMENT')) errMsg = "‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Format ‡∏ú‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)";
                if(errMsg.includes('413')) errMsg = "Payload Too Large (‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏•‡∏¥‡∏°‡∏¥‡∏ï Browser)";
                
                output.innerHTML = `<div class="text-center py-5 text-danger"><i class="fa-solid fa-triangle-exclamation fa-2x mb-2"></i><br>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:<br>${errMsg}</div>`;
                statusDiv.innerText = "Processing Failed";
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles me-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                btn.disabled = false;
            }
        };

        // üî•üî•üî• Export to Word Function (docx.js with Thai Font & Professional Styling) üî•üî•üî•
        window.exportToWord = async () => {
            const summaryRaw = document.getElementById('aiOutput').dataset.raw;
            const topic = document.getElementById('topic').value || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠";
            const participants = document.getElementById('participants').value || "-";
            const dateStr = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

            if (!summaryRaw) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Export ‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                return;
            }

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Word...', didOpen: () => Swal.showLoading() });

            const sections = summaryRaw.split('##');
            const docContent = [];
            const fontName = "TH Sarabun New"; // Standard Thai font name

            // üìù Header Section (‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)
            docContent.push(
                new docx.Paragraph({
                    children: [new docx.TextRun({ text: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°", bold: true, size: 48, font: fontName })], // 24pt
                    alignment: docx.AlignmentType.CENTER,
                    spacing: { after: 100 }
                }),
                new docx.Paragraph({
                    children: [new docx.TextRun({ text: "School Hub Management System", size: 32, color: "666666", font: fontName })], // 16pt
                    alignment: docx.AlignmentType.CENTER,
                    spacing: { after: 400 }
                })
            );

            // üìÖ Meta Data (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°)
             docContent.push(
                new docx.Paragraph({ children: [new docx.TextRun({ text: `‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°: ${topic}`, bold: true, size: 32, font: fontName })], spacing: { line: 360 } }),
                new docx.Paragraph({ children: [new docx.TextRun({ text: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr}`, bold: true, size: 32, font: fontName })], spacing: { line: 360 } }),
                new docx.Paragraph({ children: [new docx.TextRun({ text: `‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ${participants}`, bold: true, size: 32, font: fontName })], spacing: { after: 400, line: 360 } })
            );

            // üìÑ Body Content (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°)
             sections.forEach(sec => {
                const lines = sec.trim().split('\n');
                if (lines.length > 0 && lines[0].trim() !== '') {
                    const headerText = lines[0].replace(/\*/g, '').trim();
                    if(headerText) {
                         docContent.push(new docx.Paragraph({
                            children: [new docx.TextRun({ text: headerText, bold: true, size: 36, color: "2E75B5", font: fontName })], // 18pt Blue Header
                            spacing: { before: 300, after: 100 }
                        }));
                    }
                   
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim().replace(/\*/g, '');
                        if (line) {
                            if (line.startsWith('-') || line.startsWith('‚Ä¢')) {
                                docContent.push(new docx.Paragraph({
                                    children: [new docx.TextRun({ text: line.substring(1).trim(), size: 32, font: fontName })], // 16pt Body
                                    bullet: { level: 0 },
                                    spacing: { line: 360 } // Line height 1.5
                                }));
                            } else {
                                docContent.push(new docx.Paragraph({
                                    children: [new docx.TextRun({ text: line, size: 32, font: fontName })], // 16pt Body
                                    spacing: { line: 360 }
                                }));
                            }
                        }
                    }
                }
            });
            
            // ‚úçÔ∏è Footer Signature (‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠)
             docContent.push(
                new docx.Paragraph({ text: "", spacing: { before: 800 } }),
                new docx.Paragraph({
                    children: [
                        new docx.TextRun({ text: "___________________________          ___________________________", size: 32, font: fontName })
                    ],
                    alignment: docx.AlignmentType.CENTER
                }),
                new docx.Paragraph({
                    children: [
                        new docx.TextRun({ text: "‡∏ú‡∏π‡πâ‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°                    ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°", size: 32, font: fontName })
                    ],
                    alignment: docx.AlignmentType.CENTER
                })
            );

            // Create Document
            const doc = new docx.Document({
                sections: [{
                    properties: {},
                    children: docContent
                }]
            });

            // Save
            docx.Packer.toBlob(doc).then(blob => {
                saveAs(blob, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°_${topic.replace(/\s+/g, '_')}.docx`);
                Swal.fire({ icon: 'success', title: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', showConfirmButton: false, timer: 1500 });
            }).catch(err => {
                console.error(err);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Word ‡πÑ‡∏î‡πâ', 'error');
            });
        };

        window.saveToHistory = async () => {
            const topic = document.getElementById('topic').value;
            const participants = document.getElementById('participants').value;
            const rawContent = document.getElementById('rawContent').value;
            const summary = document.getElementById('aiOutput').dataset.raw;
            if(!summary) return;
            try {
                await addDoc(collection(db, "meeting_summaries"), {
                    topic: topic || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏", participants: participants, raw_content: rawContent || "(‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á)", ai_summary: summary,
                    created_by: currentUser.uid, created_at: serverTimestamp()
                });
                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton: false, timer: 1500 });
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.copyToClipboard = () => {
            const text = document.getElementById('aiOutput').innerText;
            if(!text || text.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) return;
            navigator.clipboard.writeText(text);
            Swal.fire({ icon: 'success', title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
        }
    </script>
</body>
</html>