<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Meeting Assistant - School Hub</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: #f0f2f5;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: cover;
            background-attachment: fixed;
            min-height: 100vh;
            color: #2d3748;
            padding-bottom: 50px; /* ‡∏Å‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        }

        /* Navbar Style */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
        }
        .navbar-brand { font-weight: 700; color: white !important; letter-spacing: 0.5px; }
        
        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white; border: none; border-radius: 30px;
            padding: 8px 20px; font-weight: 500; transition: all 0.3s;
            text-decoration: none; display: flex; align-items: center; gap: 8px;
        }
        .btn-back:hover { background: white; color: #333; transform: translateY(-2px); }

        /* Main Card */
        .ai-card {
            background: var(--glass-bg);
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            border: var(--glass-border);
            overflow: hidden;
            margin-top: 20px;
            min-height: 85vh; /* ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        }

        .left-panel { padding: 30px; border-right: 1px solid #eee; }
        .right-panel { padding: 30px; background-color: #f8fafc; }

        /* Form Elements */
        .form-floating > .form-control { border-radius: 12px; border: 1px solid #e2e8f0; background: #fff; }
        .form-floating > .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1); }
        .form-floating > label { color: #64748b; }

        .textarea-container { position: relative; }
        #rawContent { 
            border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; 
            resize: none; font-size: 1rem; line-height: 1.6;
            background: #fff; transition: all 0.3s;
        }
        #rawContent:focus { border-color: #667eea; outline: none; }

        /* Mic Button (‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) */
        .mic-wrapper {
            position: absolute; bottom: 20px; right: 20px; z-index: 10;
        }
        .mic-btn {
            width: 60px; height: 60px; border-radius: 50%;
            border: none; background: #fff; color: #4a5568;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .mic-btn:hover { transform: scale(1.1); color: #667eea; }
        
        .mic-active {
            background: #ef4444 !important; color: white !important;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Action Buttons */
        .btn-generate {
            background: var(--primary-gradient); border: none;
            border-radius: 12px; padding: 15px; width: 100%;
            color: white; font-weight: 700; font-size: 1.1rem;
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
            transition: all 0.3s;
        }
        .btn-generate:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(118, 75, 162, 0.4); }
        .btn-generate:disabled { background: #cbd5e1; transform: none; cursor: not-allowed; box-shadow: none; }

        /* Output Area */
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .result-title { font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.5rem; }
        
        .markdown-content {
            background: white; border-radius: 16px; padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7;
            min-height: 400px; font-size: 1rem; line-height: 1.8; color: #374151;
        }
        .markdown-content h2 { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-top: 1.5em; margin-bottom: 0.8em; border-left: 4px solid #764ba2; padding-left: 12px; }
        .markdown-content ul { padding-left: 20px; }
        .markdown-content li { margin-bottom: 8px; }
        .markdown-content strong { color: #764ba2; }

        .btn-copy { border: 1px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; padding: 6px 12px; font-size: 0.85rem; transition: 0.2s; }
        .btn-copy:hover { background: #f1f5f9; color: #333; }

        .empty-state { text-align: center; color: #94a3b8; padding-top: 100px; }
        .empty-state i { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }

        @keyframes fade { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        .txt-pulse { animation: fade 1.5s infinite; }

        @media (max-width: 768px) {
            .left-panel { border-right: none; border-bottom: 1px solid #eee; padding: 20px; }
            .right-panel { padding: 20px; }
            .ai-card { margin-top: 15px; border-radius: 15px; }
            .mic-btn { width: 55px; height: 55px; font-size: 1.3rem; }
        }
    </style>
</head>
<body>

    <nav class="navbar-custom sticky-top">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fa-solid fa-wand-magic-sparkles me-2"></i> School Hub AI
            </a>
            <a href="dashboard.html" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i> <span class="d-none d-sm-inline">‡∏Å‡∏•‡∏±‡∏ö Dashboard</span>
            </a>
        </div>
    </nav>

    <div class="container mb-5">
        <div class="ai-card">
            <div class="row g-0 h-100">
                
                <div class="col-lg-5 left-panel">
                    <h4 class="fw-bold mb-4 text-dark"><i class="fa-solid fa-pen-to-square text-primary me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
                    
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="topic" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠">
                        <label for="topic">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</label>
                    </div>

                    <div class="form-floating mb-4">
                        <input type="text" class="form-control" id="participants" placeholder="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°">
                        <label for="participants">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏≠., ‡∏Ñ‡∏£‡∏π‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£)</label>
                    </div>

                    <div class="mb-4 position-relative textarea-container">
                        <label class="form-label fw-bold small text-secondary ms-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå)</label>
                        <textarea id="rawContent" class="form-control" rows="12" placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢..."></textarea>
                        
                        <div class="mic-wrapper">
                            <button id="btnMic" class="mic-btn" onclick="toggleRecording()" title="‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏π‡∏î">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="recordingStatus" class="align-items-center justify-content-center text-danger mb-3 fw-bold small" style="display:none; gap:8px;">
                        <span class="spinner-grow spinner-grow-sm" role="status"></span> 
                        <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏ô‡∏¥‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)</span>
                    </div>

                    <button onclick="generateSummary()" id="btnGenerate" class="btn-generate">
                        <i class="fa-solid fa-bolt me-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏ß‡∏¢ AI
                    </button>
                    
                    <div id="modelStatus" class="text-center mt-3 text-muted" style="font-size: 0.75rem; opacity: 0.7;">
                        Ready to process with Gemini AI
                    </div>
                </div>

                <div class="col-lg-7 right-panel">
                    <div class="result-header">
                        <div class="result-title"><i class="fa-brands fa-google me-2"></i>AI Summary</div>
                        <button class="btn-copy shadow-sm" onclick="copyToClipboard()">
                            <i class="fa-regular fa-copy me-1"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                        </button>
                    </div>

                    <div id="aiOutput" class="markdown-content">
                        <div class="empty-state">
                            <i class="fa-solid fa-robot"></i>
                            <h5>‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì...</h5>
                            <p class="small">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô</p>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button onclick="saveToHistory()" id="btnSave" class="btn btn-success w-100 py-2 rounded-pill fw-bold shadow-sm" disabled>
                            <i class="fa-solid fa-floppy-disk me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // üî•üî•üî• ‡πÉ‡∏™‡πà API Key ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üî•üî•üî•
        const GEMINI_API_KEY = "AIzaSyB9hNjZ6wG88cKITg9IA5d7UMiP9v-Cj5I"; 

        onAuthStateChanged(auth, (user) => { if(user) currentUser = user; else window.location.href = "index.html"; });

        // --- üéôÔ∏è Speech to Text (Mobile Optimized) ---
        let recognition;
        let isRecording = false;
        let wakeLock = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏î‡∏±‡∏ö

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠ Wake Lock (‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏î‡∏±‡∏ö)
        const requestWakeLock = async () => {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) { console.error(`${err.name}, ${err.message}`); }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢ Wake Lock
        const releaseWakeLock = async () => {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock released');
            }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô "‡∏≠‡∏∏‡πà‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡∏Ñ‡πå" (Hack ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡πà‡∏á Gain)
        async function boostMicrophone() {
            try {
                // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ settings ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏î‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Hardware ‡∏ï‡∏∑‡πà‡∏ô‡∏ï‡∏±‡∏ß
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: true, // ‡πÄ‡∏£‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    }
                });
                // ‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏¥‡∏î stream ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Hardware ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ SpeechRecognition ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á)
                stream.getTracks().forEach(track => track.stop());
            } catch(e) {
                console.warn("Cannot boost mic:", e);
            }
        }

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'th-TH';
            recognition.continuous = true; // ‡∏ü‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡πÜ
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' ';
                    }
                }
                if (finalTranscript) {
                    const textarea = document.getElementById('rawContent');
                    textarea.value += finalTranscript;
                    textarea.scrollTop = textarea.scrollHeight;
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech Error:", event.error);
                if(event.error === 'no-speech') return; // ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÑ‡∏õ‡πÄ‡∏â‡∏¢‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á error
                stopRecording();
                Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡∏™‡∏∞‡∏î‡∏∏‡∏î', text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏±‡πâ‡∏ô' });
            };

            recognition.onend = () => {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏î ‡πÅ‡∏ï‡πà‡∏´‡∏•‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ô‡πá‡∏ï‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å) ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                if(isRecording) { 
                    console.log("Reconnecting mic...");
                    recognition.start(); 
                } else { 
                    stopRecording(); 
                }
            };
        } else {
            document.getElementById('btnMic').style.display = 'none';
        }

        window.toggleRecording = async () => {
            if (!recognition) return Swal.fire('‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö', '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á', 'warning');
            
            if (isRecording) {
                stopRecording();
            } else {
                await boostMicrophone(); // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡πÑ‡∏°‡∏Ñ‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
                startRecording();
            }
        };

        function startRecording() {
            isRecording = true;
            recognition.start();
            requestWakeLock(); // ‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ö
            document.getElementById('btnMic').classList.add('mic-active');
            document.getElementById('btnMic').innerHTML = '<i class="fa-solid fa-stop"></i>';
            document.getElementById('recordingStatus').style.display = 'flex';
        }

        function stopRecording() {
            isRecording = false;
            recognition.stop();
            releaseWakeLock(); // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏•‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            document.getElementById('btnMic').classList.remove('mic-active');
            document.getElementById('btnMic').innerHTML = '<i class="fa-solid fa-microphone"></i>';
            document.getElementById('recordingStatus').style.display = 'none';
        }

        // --- üß† AI Generation ---
        async function detectAvailableModel() {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                const data = await response.json();
                if (data.models) {
                    const preferred = data.models.find(m => m.supportedGenerationMethods.includes("generateContent") && (m.name.includes("gemini-1.5") || m.name.includes("gemini-pro")));
                    if (preferred) return preferred.name.replace('models/', '');
                    return "gemini-pro";
                }
                return "gemini-pro";
            } catch (e) { return "gemini-pro"; }
        }

        window.generateSummary = async () => {
            if (isRecording) stopRecording();
            const rawText = document.getElementById('rawContent').value;
            const topic = document.getElementById('topic').value;
            
            if(!rawText) { Swal.fire({ icon: 'warning', title: '‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö' }); return; }

            const btn = document.getElementById('btnGenerate');
            const output = document.getElementById('aiOutput');
            const btnSave = document.getElementById('btnSave');
            
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> <span class="txt-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>';
            btn.disabled = true;
            output.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary mb-3"></div><p class="text-muted">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...</p></div>';

            try {
                const modelName = await detectAvailableModel();
                document.getElementById('modelStatus').innerText = `Powered by ${modelName}`; 

                const prompt = `
                    ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û:
                    ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${topic}
                    ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡∏¥‡∏ö: "${rawText}"
                    
                    ‡∏Ç‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Markdown ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                    ## üìù ‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                    (‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠‡πÜ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢)
                    ## ‚úÖ ‡∏°‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
                    (‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ)
                    ## üöÄ Action Plan
                    (‡πÉ‡∏Ñ‡∏£ ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà)
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const aiText = data.candidates[0].content.parts[0].text;
                output.innerHTML = marked.parse(aiText);
                output.dataset.raw = aiText;
                btnSave.disabled = false;

            } catch (error) {
                console.error(error);
                output.innerHTML = `<div class="text-center py-5 text-danger"><i class="fa-solid fa-triangle-exclamation fa-2x mb-2"></i><br>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles me-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                btn.disabled = false;
            }
        };

        window.saveToHistory = async () => {
            const topic = document.getElementById('topic').value;
            const participants = document.getElementById('participants').value;
            const rawContent = document.getElementById('rawContent').value;
            const summary = document.getElementById('aiOutput').dataset.raw;
            if(!summary) return;
            try {
                await addDoc(collection(db, "meeting_summaries"), {
                    topic: topic || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏", participants: participants, raw_content: rawContent, ai_summary: summary,
                    created_by: currentUser.uid, created_at: serverTimestamp()
                });
                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', showConfirmButton: false, timer: 1500 });
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.copyToClipboard = () => {
            const text = document.getElementById('aiOutput').innerText;
            if(!text || text.includes('‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')) return;
            navigator.clipboard.writeText(text);
            Swal.fire({ icon: 'success', title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
        }
    </script>
</body>
</html>