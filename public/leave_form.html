<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤ - School System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f3e5f5; font-family: 'Sarabun', sans-serif; }
        
        /* ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á (Personnel) */
        .main-header {
            background-color: #7b1fa2; 
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-back {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: white;
            border-radius: 50px;
            padding: 6px 16px;
            font-size: 0.9rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: 0.3s;
        }
        .btn-back:hover {
            background-color: white;
            color: #7b1fa2;
        }

        .form-container { 
            max-width: 800px; margin: 30px auto; 
            background: white; padding: 40px; 
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
        }

        .section-header { 
            background-color: #f3e5f5; padding: 10px 15px; 
            border-radius: 8px; margin-bottom: 20px; color: #6a1b9a; 
            font-weight: bold; border: 1px solid #e1bee7;
            display: flex; align-items: center;
        }
        .section-header i { margin-right: 10px; }

        .btn-submit { 
            width: 100%; padding: 12px; font-size: 1.1rem; border-radius: 50px; 
            background-color: #7b1fa2; color: white; border: none;
            transition: 0.3s; margin-top: 20px;
        }
        .btn-submit:hover {
            background-color: #4a148c; transform: translateY(-2px);
        }

        .readonly-field { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #6c757d; }
        
        .schedule-table th { background-color: #6a1b9a; color: white; text-align: center; }
        .schedule-table td { vertical-align: middle; }
        .schedule-input { border: 1px solid #eee; width: 100%; text-align: center; padding: 5px; border-radius: 4px; }
        .schedule-input:focus { outline: 2px solid #ce93d8; border-color: transparent; }

        .btn-outline-purple { color: #6a1b9a; border-color: #6a1b9a; }
        .btn-outline-purple:hover, .btn-check:checked + .btn-outline-purple { background-color: #6a1b9a; color: white; }
    </style>
</head>
<body>

    <div class="main-header">
        <div class="fw-bold fs-5"><i class="fa-solid fa-file-signature"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
        <a href="dashboard.html" class="btn-back">
            <i class="fa-solid fa-house"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
        </a>
    </div>

    <div class="container mb-5">
        <div class="form-container">
            <h3 class="text-center mb-4" style="color: #4a148c; font-weight: bold;">ü§í ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î</h3>
            
            <form id="leaveForm">
                
                <div class="text-center mb-4">
                    <label class="form-label fw-bold mb-2">‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î?</label><br>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="staffType" id="typeTeacher" value="teacher" checked onchange="toggleForm()">
                        <label class="btn btn-outline-purple" for="typeTeacher">üë®‚Äçüè´ ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π / ‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πâ‡∏≤‡∏á</label>

                        <input type="radio" class="btn-check" name="staffType" id="typeStaff" value="staff" onchange="toggleForm()">
                        <label class="btn btn-outline-purple" for="typeStaff">üìã ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏™‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</label>
                    </div>
                </div>

                <div class="section-header"><i class="fa-solid fa-user"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏•‡∏≤</div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</label>
                        <input type="date" id="writeDate" class="form-control readonly-field" readonly>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="requesterName" class="form-control readonly-field" readonly value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                        <input type="text" id="requesterRole" class="form-control readonly-field" readonly value="...">
                    </div>
                </div>

                <div class="section-header mt-4"><i class="fa-solid fa-calendar-days"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤) <span class="text-danger">*</span></label>
                    <select id="leaveType" class="form-select" required>
                        <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                        <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                        <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">üíº ‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                        <option value="‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î">üë∂ ‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£</option>
                        <option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (Vacation)</option>
                        <option value="‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">ü™ñ ‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏´‡∏≤‡∏£</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤) <span class="text-danger">*</span></label>
                    <textarea id="reason" class="form-control" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏..." required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏≤ <span class="text-danger">*</span></label>
                    <select id="leaveDuration" class="form-select" onchange="toggleDuration()">
                        <option value="full">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô (1 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)</option>
                        <option value="half_morning">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πâ‡∏≤) (0.5 ‡∏ß‡∏±‡∏ô)</option>
                        <option value="half_afternoon">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô (‡∏ö‡πà‡∏≤‡∏¢) (0.5 ‡∏ß‡∏±‡∏ô)</option>
                    </select>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">‡∏•‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="startDate" class="form-control" required onchange="calculateDays()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="endDate" class="form-control" required onchange="calculateDays()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">‡∏£‡∏ß‡∏° (‡∏ß‡∏±‡∏ô)</label>
                        <input type="number" id="totalDays" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1" min="0.5" step="0.5" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ <span class="text-danger">*</span></label>
                    <input type="tel" id="contactPhone" class="form-control" placeholder="08x-xxxxxxx" required>
                </div>

                <div id="teacherScheduleSection">
                    <div class="section-header mt-4 bg-warning text-dark border-warning">
                        <i class="fa-solid fa-chalkboard-user"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π)
                    </div>
                    <p class="text-muted small">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏¥‡∏ä‡∏≤/‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered schedule-table">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà</th>
                                    <th style="width: 45%;">‡∏ß‡∏¥‡∏ä‡∏≤ / ‡∏ä‡∏±‡πâ‡∏ô / ‡∏´‡πâ‡∏≠‡∏á</th>
                                    <th style="width: 45%;">‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô (‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏•)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <script>
                                    for(let i=1; i<=9; i++) {
                                        document.write(`
                                            <tr>
                                                <td class="text-center fw-bold">${i}</td>
                                                <td><input type="text" class="schedule-input period-subject" data-period="${i}" placeholder="-"></td>
                                                <td><input type="text" class="schedule-input period-teacher" data-period="${i}" placeholder="-"></td>
                                            </tr>
                                        `);
                                    }
                                </script>
                            </tbody>
                        </table>
                    </div>
                </div>

                <hr class="my-4">
                
                <button type="submit" class="btn btn-submit shadow">
                    <i class="fa-solid fa-paper-plane me-2"></i> ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• Config ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡πå‡∏°
        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339",
            measurementId: "G-MELYCLE3XW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        document.getElementById('writeDate').valueAsDate = new Date();

        window.toggleForm = () => {
            const isTeacher = document.getElementById('typeTeacher').checked;
            const scheduleSection = document.getElementById('teacherScheduleSection');
            if (isTeacher) {
                scheduleSection.style.display = 'block';
            } else {
                scheduleSection.style.display = 'none';
                document.querySelectorAll('.schedule-input').forEach(input => input.value = '');
            }
        }

        window.toggleDuration = () => {
            const duration = document.getElementById('leaveDuration').value;
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const totalDays = document.getElementById('totalDays');

            if (duration === 'half_morning' || duration === 'half_afternoon') {
                if (startDate.value) endDate.value = startDate.value;
                endDate.readOnly = true;
                totalDays.value = 0.5;
                totalDays.readOnly = true;
            } else {
                endDate.readOnly = false;
                totalDays.readOnly = false;
                calculateDays();
            }
        }

        window.calculateDays = () => {
            const duration = document.getElementById('leaveDuration').value;
            const start = document.getElementById('startDate').value;
            
            if (duration === 'half_morning' || duration === 'half_afternoon') {
                if (start) document.getElementById('endDate').value = start;
                document.getElementById('totalDays').value = 0.5;
                return;
            }

            const end = document.getElementById('endDate').value;
            if (start && end) {
                const s = new Date(start);
                const e = new Date(end);
                const diffTime = Math.abs(e - s);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                if (diffDays > 0) document.getElementById('totalDays').value = diffDays;
            }
        }

        async function getEmailsByMultipleRoles(rolesArray) {
            console.log("üîç ‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏• Role:", rolesArray);
            const emails = new Set();
            try {
                const q = query(collection(db, "users"), where("role", "in", rolesArray));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.email) emails.add(userData.email);
                });
            } catch (error) { console.error("‚ùå Error fetching emails:", error); }
            return Array.from(emails);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        document.getElementById('requesterName').value = data.firstName || user.email;
                        document.getElementById('requesterRole').value = getRoleName(data.role);
                        
                        if(data.role === 'teacher') {
                            document.getElementById('typeTeacher').checked = true;
                        } else {
                            document.getElementById('typeStaff').checked = true;
                        }
                        toggleForm();
                    }
                } catch(err) { console.error(err); }
            } else {
                window.location.href = "index.html";
            }
        });

        function getRoleName(role) {
            const roles = { 'teacher': '‡∏Ñ‡∏£‡∏π ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', 'admin': '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'personnel': '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', 'technician': '‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', 'transport': '‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞' };
            return roles[role] || role;
        }

        document.getElementById('leaveForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) { Swal.fire('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà', 'error'); return; }

            const staffType = document.getElementById('typeTeacher').checked ? '‡∏™‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô' : '‡∏™‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô';
            const leaveType = document.getElementById('leaveType').value;
            const leaveDuration = document.getElementById('leaveDuration').value;
            const reason = document.getElementById('reason').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const totalDays = document.getElementById('totalDays').value;
            const contactPhone = document.getElementById('contactPhone').value;
            const requesterName = document.getElementById('requesterName').value;

            let durationText = "";
            if (leaveDuration === 'half_morning') durationText = " (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤)";
            else if (leaveDuration === 'half_afternoon') durationText = " (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢)";

            let substituteSchedule = [];
            let scheduleHtmlForEmail = "";
            
            // Logic ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏™‡∏ß‡∏¢‡πÜ)
            if (staffType === '‡∏™‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô') {
                const subjects = document.querySelectorAll('.period-subject');
                const teachers = document.querySelectorAll('.period-teacher');
                let hasClass = false;
                let tableRows = "";

                for (let i = 0; i < 9; i++) {
                    const sub = subjects[i].value.trim();
                    const teach = teachers[i].value.trim();
                    if (sub || teach) { 
                        substituteSchedule.push({ period: i+1, subject: sub, substitute: teach });
                        tableRows += `
                            <tr style="background-color: ${i % 2 === 0 ? '#fafafa' : '#fff'};">
                                <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: center; font-weight: bold; color: #7b1fa2;">${i+1}</td>
                                <td style="padding: 10px; border: 1px solid #e0e0e0;">${sub || '-'}</td>
                                <td style="padding: 10px; border: 1px solid #e0e0e0;">${teach || '-'}</td>
                            </tr>
                        `;
                        hasClass = true;
                    }
                }

                if (hasClass) {
                    scheduleHtmlForEmail = `
                        <br>
                        <div style="background-color: #fff3e0; border: 1px solid #ffcc80; border-radius: 8px; overflow: hidden; margin-top: 15px;">
                            <div style="background-color: #ffcc80; padding: 8px 15px; color: #e65100; font-weight: bold; font-size: 14px;">
                                üìö ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                            </div>
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background-color: #ffe0b2;">
                                        <th style="padding: 8px; border: 1px solid #ffcc80; width: 15%;">‡∏Ñ‡∏≤‡∏ö</th>
                                        <th style="padding: 8px; border: 1px solid #ffcc80; width: 40%;">‡∏ß‡∏¥‡∏ä‡∏≤/‡∏´‡πâ‡∏≠‡∏á</th>
                                        <th style="padding: 8px; border: 1px solid #ffcc80; width: 45%;">‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                    `;
                }
            }

            Swal.fire({ 
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', 
                allowOutsideClick: false, didOpen: () => Swal.showLoading() 
            });

            try {
                await addDoc(collection(db, "leave_requests"), {
                    staff_type: staffType,
                    leave_type: leaveType + durationText,
                    leave_duration_code: leaveDuration,
                    reason: reason,
                    start_date: startDate,
                    end_date: endDate,
                    total_days: totalDays,
                    contact_phone: contactPhone,
                    substitute_schedule: substituteSchedule,
                    requester_uid: currentUser.uid,
                    requester_name: requesterName,
                    requester_email: currentUser.email,
                    requester_role: document.getElementById('requesterRole').value,
                    status: "pending", 
                    created_at: serverTimestamp()
                });

                let targetRoles = ["personnel", "admin", "Admin"];
                let emailTo = await getEmailsByMultipleRoles(targetRoles);
                if (emailTo.length === 0) emailTo = ["armvbn.123my4@gmail.com"]; 

                // üî• HTML Email Template ‡∏™‡∏ß‡∏¢‡πÜ
                await addDoc(collection(db, "mail"), {
                    to: emailTo,
                    message: {
                        subject: `üìÑ ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏•‡∏≤ (${leaveType}): ${requesterName}`,
                        html: `
                            <div style="font-family: 'Sarabun', sans-serif; max-width: 600px; margin: auto; border: 1px solid #e1bee7; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                                <div style="background-color: #7b1fa2; padding: 20px; text-align: center;">
                                    <h2 style="color: #ffffff; margin: 0; font-size: 22px;">üì¢ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏•‡∏≤ (${staffType})</h2>
                                </div>
                                
                                <div style="padding: 30px; background-color: #ffffff;">
                                    <div style="margin-bottom: 20px;">
                                        <p style="margin: 5px 0; color: #555;"><strong>‡∏ú‡∏π‡πâ‡∏•‡∏≤:</strong> <span style="font-size: 1.1em; color: #000;">${requesterName}</span></p>
                                        <p style="margin: 5px 0; color: #555;"><strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${document.getElementById('requesterRole').value}</p>
                                        <p style="margin: 5px 0; color: #555;"><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> ${contactPhone}</p>
                                    </div>

                                    <div style="background-color: #f3e5f5; border-left: 5px solid #7b1fa2; padding: 15px; border-radius: 4px;">
                                        <h3 style="color: #6a1b9a; margin-top: 0; font-size: 18px;">${leaveType} ${durationText}</h3>
                                        <p style="margin: 5px 0;"><strong>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${startDate} ‡∏ñ‡∏∂‡∏á ${endDate}</p>
                                        <p style="margin: 5px 0;"><strong>‚è≥ ‡∏£‡∏ß‡∏°:</strong> ${totalDays} ‡∏ß‡∏±‡∏ô</p>
                                        <p style="margin: 10px 0 0 0;"><strong>üìù ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong><br>${reason}</p>
                                    </div>

                                    ${scheduleHtmlForEmail}

                                    <div style="text-align: center; margin-top: 30px;">
                                        <a href="#" style="background-color: #7b1fa2; color: white; padding: 12px 25px; text-decoration: none; border-radius: 50px; font-weight: bold; display: inline-block;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</a>
                                    </div>
                                </div>
                                
                                <div style="background-color: #f8f9fa; padding: 15px; text-align: center; font-size: 12px; color: #999; border-top: 1px solid #eee;">
                                    School Hub Management System
                                </div>
                            </div>
                        `
                    }
                });

                Swal.fire({
                    icon: 'success', title: '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 2000, showConfirmButton: false
                }).then(() => window.location.href = "dashboard.html");

            } catch (error) {
                console.error("Error:", error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        });
    </script>
</body>
</html>