<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì 2567 - School Hub</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --primary-color: #0f766e; --secondary-color: #14b8a6; --bg-color: #f0fdfa; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); color: #1f2937; padding-bottom: 80px; }
        
        .main-header {
            background: linear-gradient(135deg, #0f766e, #0d9488); color: white;
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(15, 118, 110, 0.2); position: sticky; top: 0; z-index: 1000;
        }
        .btn-back {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);
            color: white; border-radius: 50px; padding: 5px 15px; font-size: 0.9rem;
            text-decoration: none; transition: 0.3s; display: flex; align-items: center; gap: 5px;
        }
        .btn-back:hover { background: white; color: #0f766e; }

        .filter-card {
            background: white; border-radius: 16px; padding: 15px;
            margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            border: 1px solid #ccfbf1;
        }

        .nav-pills { 
            background: #e0f2fe; padding: 5px; border-radius: 50px; 
            display: inline-flex; width: 100%; overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        .nav-pills::-webkit-scrollbar { display: none; }
        .nav-pills .nav-link { 
            color: #0369a1; border-radius: 50px; padding: 8px 15px; 
            font-weight: 600; font-size: 0.9rem; white-space: nowrap; flex: 0 0 auto; margin-right: 5px;
        }
        .nav-pills .nav-link.active { background-color: white; color: #0284c7; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .doc-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); border-left: 5px solid #ccc;
            transition: 0.2s; position: relative;
        }
        .doc-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        /* Color Coding */
        .border-memo { border-left-color: #3b82f6; }       
        .border-command { border-left-color: #ef4444; }    
        .border-send { border-left-color: #f97316; }       
        .border-announce { border-left-color: #8b5cf6; }   
        .border-certificate { border-left-color: #eab308; }
        .border-student_affairs { border-left-color: #10b981; }

        .doc-id { font-weight: bold; font-size: 1.1rem; color: #374151; }
        .doc-date { font-size: 0.85rem; color: #6b7280; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; }
        .doc-subject { font-size: 1rem; font-weight: 500; margin: 5px 0; color: #1f2937; }
        .doc-meta { font-size: 0.85rem; color: #6b7280; display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .doc-meta span { display: flex; align-items: center; gap: 4px; }
        .doc-meta i { color: #9ca3af; }

        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 999; display: flex; flex-direction: column; align-items: end; gap: 10px; }
        .fab-main {
            width: 60px; height: 60px; background: #0f766e; color: white; border-radius: 50%; border: none;
            box-shadow: 0 4px 15px rgba(15, 118, 110, 0.4); font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
        }
        .fab-main:active { transform: scale(0.9); }
        .fab-item {
            width: 45px; height: 45px; background: white; color: #4b5563; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: none; cursor: pointer; opacity: 0; transform: translateY(20px); transition: 0.3s;
        }
        .fab-container:hover .fab-item { opacity: 1; transform: translateY(0); }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #9ca3af; }
        .btn-ai-magic {
            background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; color: white;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); transition: 0.3s;
        }
        .btn-ai-magic:hover { transform: scale(1.05); color: white; }
    </style>
</head>
<body>

    <div class="main-header">
        <div class="fw-bold fs-5"><i class="fa-solid fa-folder-tree me-2"></i> ‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì</div>
        <a href="dashboard.html" class="btn-back"><i class="fa-solid fa-house"></i> ‡∏Å‡∏•‡∏±‡∏ö</a>
    </div>

    <div class="container py-3">

        <!-- Filter & Search -->
        <div class="filter-card">
            <div class="row g-2">
                <div class="col-8">
                    <input type="text" id="searchInput" class="form-control rounded-pill border-0 bg-light" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)...">
                </div>
                <div class="col-4">
                    <select id="yearSelect" class="form-select rounded-pill border-0 bg-light text-center fw-bold text-secondary">
                        <option value="2569">2569</option>
                        <option value="2568" selected>2568</option>
                        <option value="2567">2567</option>
                        <option value="2566">2566</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 6 Tabs -->
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" onclick="changeCategory('memo')">üì® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button></li>
            <li class="nav-item"><button class="nav-link" onclick="changeCategory('command')">‚öñÔ∏è ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</button></li>
            <li class="nav-item"><button class="nav-link" onclick="changeCategory('send')">üì§ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡πà‡∏á</button></li>
            <li class="nav-item"><button class="nav-link" onclick="changeCategory('announce')">üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></li>
            <li class="nav-item"><button class="nav-link" onclick="changeCategory('certificate')">üéñÔ∏è ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</button></li>
            <li class="nav-item"><button class="nav-link" onclick="changeCategory('student_affairs')">üéì ‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏Ø</button></li>
        </ul>

        <!-- Content Header -->
        <div class="d-flex justify-content-between align-items-center mb-2 px-1">
            <small class="text-muted fw-bold" id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</small>
            <div class="d-flex gap-2">
                 <button class="btn btn-sm btn-outline-danger rounded-pill px-3" onclick="clearCategoryData()">
                    <i class="fa-solid fa-trash me-1"></i> ‡∏•‡πâ‡∏≤‡∏á
                </button>
                <button class="btn btn-sm btn-outline-success rounded-pill px-3" onclick="exportToExcel()">
                    <i class="fa-solid fa-file-excel me-1"></i>
                </button>
            </div>
        </div>

        <div id="documentList">
            <div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>
        </div>
        
        <!-- Load More Button -->
        <div id="loadMoreContainer" class="text-center my-3" style="display:none;">
            <button class="btn btn-light text-primary rounded-pill px-4 fw-bold shadow-sm" onclick="loadMoreItems()">
                <i class="fa-solid fa-circle-chevron-down me-2"></i> ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
        </div>

    </div>

    <!-- Floating Menu -->
    <div class="fab-container">
        <button class="fab-item bg-warning text-dark" onclick="importFromText()" title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"><i class="fa-solid fa-paste"></i></button>
        <button class="fab-item bg-info text-white" onclick="importFromGoogleSheet()" title="‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Google Sheet"><i class="fa-brands fa-google-drive"></i></button>
        <button class="fab-item bg-success text-white" onclick="importFromExcel()" title="‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel"><i class="fa-solid fa-file-import"></i></button>
        <button class="fab-main" onclick="openAddModal()"><i class="fa-solid fa-plus"></i></button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentCategory = 'memo'; 
        let currentYear = '2568';
        let allDocs = [];
        let filteredDocs = [];
        let displayLimit = 50; 
        let unsubscribe = null;

        // Init
        document.getElementById('yearSelect').value = currentYear;
        
        document.getElementById('yearSelect').addEventListener('change', (e) => {
            currentYear = e.target.value;
            displayLimit = 50;
            filterLocalData(); 
            loadDocuments();   
        });

        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            displayLimit = 50;
            filterLocalData(e.target.value.toLowerCase());
        });

        function filterLocalData(term = "") {
            const searchTerm = term || document.getElementById('searchInput').value.toLowerCase();
            
            filteredDocs = allDocs.filter(d => {
                let itemYear = String(d.year || "");
                if (d.doc_no && d.doc_no.includes('/' + currentYear)) {
                    itemYear = currentYear;
                }
                else if (!itemYear && d.doc_date) {
                    const parts = d.doc_date.split('-');
                    if (parts.length === 3) {
                        let y = parseInt(parts[0]);
                        itemYear = y < 2400 ? String(y + 543) : String(y);
                    }
                }
                
                if (itemYear && itemYear !== String(currentYear)) return false;

                const subject = (d.subject || "").toLowerCase();
                const docNo = (d.doc_no || "").toLowerCase();
                const to = (d.to || "").toLowerCase();
                const practitioner = (d.practitioner || "").toLowerCase();
                const dept = (d.department || "").toLowerCase();
                const activity = (d.activity || "").toLowerCase();
                
                return subject.includes(searchTerm) || docNo.includes(searchTerm) || to.includes(searchTerm) || practitioner.includes(searchTerm) || dept.includes(searchTerm) || activity.includes(searchTerm);
            });
            renderList();
        }

        window.changeCategory = (cat) => {
            currentCategory = cat;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.target.classList.add('active');
            displayLimit = 50;
            loadDocuments();
        }

        window.loadMoreItems = () => {
            displayLimit += 50;
            renderList();
        }

        function loadDocuments() {
            const list = document.getElementById('documentList');
            list.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-secondary"></div></div>';
            
            let q = query(collection(db, "documents"), where("category", "==", currentCategory));

            if(unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(q, (snapshot) => {
                allDocs = [];
                snapshot.forEach(doc => { allDocs.push({ id: doc.id, ...doc.data() }); });
                
                // üî• SORT BY DATE DESCENDING, THEN DOC NO
                allDocs.sort((a, b) => {
                    // Primary: Date Desc
                    const dateA = a.doc_date || "";
                    const dateB = b.doc_date || "";
                    if (dateA !== dateB) {
                        return dateB.localeCompare(dateA); // Newest first
                    }
                    
                    // Secondary: Doc No Desc
                    const idA = a.doc_no || "";
                    const idB = b.doc_no || "";
                    return idB.localeCompare(idA, undefined, { numeric: true, sensitivity: 'base' });
                });
                
                filterLocalData(); 
            }, (error) => {
                console.error("Query Error:", error);
                list.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            });
        }

        function renderList() {
            const list = document.getElementById('documentList');
            const status = document.getElementById('statusText');
            const loadMoreBtn = document.getElementById('loadMoreContainer');
            
            const catNames = {
                'memo': '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°', 'command': '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', 'send': '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡πà‡∏á',
                'announce': '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', 'certificate': '‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£', 'student_affairs': '‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
            };
            
            status.innerHTML = `${catNames[currentCategory]} <span class="badge bg-secondary rounded-pill">${filteredDocs.length}/${allDocs.length}</span>`;
            list.innerHTML = "";

            if(filteredDocs.length === 0) {
                list.innerHTML = `<div class="empty-state"><i class="fa-regular fa-folder-open fa-3x mb-3 opacity-50"></i><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ ${currentYear}</p></div>`;
                loadMoreBtn.style.display = 'none';
                return;
            }

            const itemsToShow = filteredDocs.slice(0, displayLimit);

            itemsToShow.forEach(d => {
                let thaiDate = d.doc_date || '-';
                if(d.doc_date && d.doc_date.includes('-')) {
                    const parts = d.doc_date.split('-');
                    if(parts.length === 3) {
                        const m = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
                        let y = parseInt(parts[0]);
                        if(y < 2400) y += 543;
                        thaiDate = `${parseInt(parts[2])} ${m[parseInt(parts[1])-1]} ${y}`;
                    }
                }

                let metaHtml = '';
                let subjectText = d.subject || '-';

                if(currentCategory === 'memo') {
                    if(d.practitioner && d.practitioner !== '-') metaHtml += `<span><i class="fa-solid fa-user-pen"></i> ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥: ${d.practitioner}</span>`;
                } else if(currentCategory === 'command') {
                    if(d.signer && d.signer !== '-') metaHtml += `<span><i class="fa-solid fa-file-signature"></i> ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°: ${d.signer}</span>`;
                } else if(currentCategory === 'send' || currentCategory === 'student_affairs') {
                    if(d.from && d.from !== '-') metaHtml += `<span><i class="fa-solid fa-right-from-bracket"></i> ‡∏à‡∏≤‡∏Å: ${d.from}</span>`;
                    if(d.to && d.to !== '-') metaHtml += `<span><i class="fa-solid fa-right-to-bracket"></i> ‡∏ñ‡∏∂‡∏á: ${d.to}</span>`;
                    if(d.practitioner && d.practitioner !== '-') metaHtml += `<span><i class="fa-solid fa-user-pen"></i> ${d.practitioner}</span>`;
                } else if(currentCategory === 'announce') {
                    if(d.signer && d.signer !== '-') metaHtml += `<span><i class="fa-solid fa-file-signature"></i> ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°: ${d.signer}</span>`;
                } else if(currentCategory === 'certificate') {
                    subjectText = d.activity || d.subject || '-';
                    if(d.department) metaHtml += `<span><i class="fa-solid fa-layer-group"></i> ‡∏ù‡πà‡∏≤‡∏¢: ${d.department}</span>`;
                    if(d.signer) metaHtml += `<span><i class="fa-solid fa-file-signature"></i> ‡∏•‡∏á‡∏ô‡∏≤‡∏°: ${d.signer}</span>`;
                    if(d.practitioner) metaHtml += `<span><i class="fa-solid fa-user-check"></i> ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${d.practitioner}</span>`;
                }

                list.innerHTML += `
                    <div class="doc-card border-${currentCategory}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="doc-id text-primary">${d.doc_no || '-'}</span>
                                <span class="doc-date ms-2 badge bg-light text-dark border"><i class="fa-regular fa-calendar"></i> ${thaiDate}</span>
                            </div>
                            <div class="dropdown">
                                <i class="fa-solid fa-ellipsis-vertical text-muted p-2" data-bs-toggle="dropdown" style="cursor:pointer"></i>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocItem('${d.id}')">‡∏•‡∏ö</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="doc-subject mt-2">${subjectText}</div>
                        <div class="doc-meta small text-muted">${metaHtml}</div>
                    </div>`;
            });

            loadMoreBtn.style.display = (filteredDocs.length > displayLimit) ? 'block' : 'none';
        }

        // --- Helper for Auto ID ---
        function generateNextDocNo(docs, category, year) {
            let maxNum = 0;
            let lastSuffix = ''; 

            allDocs.forEach(d => {
                if (d.category !== category) return;
                if (category === 'certificate') {
                    if (!d.doc_no.includes('/' + year)) return;
                } else {
                    if (String(d.year) !== String(year)) return;
                }
                
                if (!d.doc_no) return;

                let num = 0;
                let suffix = '';

                if (category === 'memo') {
                    const m = d.doc_no.match(/‡∏Æ\.‡∏≠‡∏ö\.(\d+)(\.\d+)?\//);
                    if (m) {
                        num = parseInt(m[1]);
                        suffix = m[2] || '';
                    }
                } else if (category === 'certificate') {
                    const rangeMatch = d.doc_no.match(/-(\d+)\//);
                    if (rangeMatch) {
                        num = parseInt(rangeMatch[1]);
                    } else {
                        const singleMatch = d.doc_no.match(/‡∏Æ\.‡∏≠‡∏ö\.(\d+)\//);
                        if (singleMatch) num = parseInt(singleMatch[1]);
                    }
                } else if (category === 'command' || category === 'announce') {
                    const m = d.doc_no.match(/‡∏Æ\.‡∏≠‡∏ö\.(\d+)\//);
                    if (m) num = parseInt(m[1]);
                } else if (category === 'send') {
                    const m = d.doc_no.match(/\/(\d+)$/);
                    if (m) num = parseInt(m[1]);
                } else if (category === 'student_affairs') {
                    const m = d.doc_no.match(/(\d+)$/);
                    if (m) num = parseInt(m[1]);
                }

                if (num > maxNum) {
                    maxNum = num;
                    lastSuffix = suffix;
                }
            });

            const nextNum = maxNum + 1;
            
            if (category === 'memo') {
                if (!lastSuffix) lastSuffix = '.1';
                return `‡∏Æ.‡∏≠‡∏ö.${String(nextNum).padStart(3, '0')}${lastSuffix}/${year}`;
            } else if (category === 'command' || category === 'announce') {
                return `‡∏Æ.‡∏≠‡∏ö.${nextNum}/${year}`;
            } else if (category === 'send') {
                return `‡∏ó‡∏µ‡πà ‡∏®‡∏ò 02132.023/${String(nextNum).padStart(3, '0')}`;
            } else if (category === 'student_affairs') {
                return `‡∏Å‡∏ô‡∏£.‡∏Æ.‡∏≠‡∏ö. ${String(nextNum).padStart(3, '0')}`;
            } else if (category === 'certificate') {
                return `‡∏Æ.‡∏≠‡∏ö.${nextNum}/${year}`;
            }
            return '';
        }

        // --- NEW: Dynamic Fields Generator ---
        function getFieldsHtml(cat, nextId) {
            const inputStyle = `class="form-control mb-2" style="background:#f9fafb;"`;
            
            if(cat === 'memo') {
                return `
                    <label class="small text-muted w-100 text-start">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà (Auto Lock)</label>
                    <div class="input-group mb-2">
                        <input id="swal-no" ${inputStyle} value="${nextId}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('swal-no').readOnly = false"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <input id="swal-subject" class="form-control mb-2" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                    <input id="swal-practitioner" class="form-control mb-2" placeholder="‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥">`;
            } else if(cat === 'command') {
                return `
                    <label class="small text-muted w-100 text-start">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Auto Lock)</label>
                    <div class="input-group mb-2">
                        <input id="swal-no" ${inputStyle} value="${nextId}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('swal-no').readOnly = false"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <input id="swal-subject" class="form-control mb-2" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                    <input id="swal-signer" class="form-control mb-2" placeholder="‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°">`;
            } else if(cat === 'send' || cat === 'student_affairs') {
                return `
                    <label class="small text-muted w-100 text-start">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (Auto Lock)</label>
                    <div class="input-group mb-2">
                        <input id="swal-no" ${inputStyle} value="${nextId}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('swal-no').readOnly = false"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <input id="swal-from" class="form-control mb-2" placeholder="‡∏à‡∏≤‡∏Å">
                    <input id="swal-to" class="form-control mb-2" placeholder="‡∏ñ‡∏∂‡∏á">
                    <input id="swal-subject" class="form-control mb-2" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                    <input id="swal-practitioner" class="form-control mb-2" placeholder="‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥">`;
            } else if(cat === 'announce') {
                return `
                    <label class="small text-muted w-100 text-start">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (Auto Lock)</label>
                    <div class="input-group mb-2">
                        <input id="swal-no" ${inputStyle} value="${nextId}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('swal-no').readOnly = false"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <input id="swal-subject" class="form-control mb-2" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                    <input id="swal-signer" class="form-control mb-2" placeholder="‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°">`;
            } else if(cat === 'certificate') {
                return `
                    <label class="small text-muted w-100 text-start">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡∏ñ‡∏∂‡∏á ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
                    <div class="input-group mb-2">
                        <input id="swal-no" ${inputStyle} value="${nextId}" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Æ.‡∏≠‡∏ö.1/2568-33/2568">
                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('swal-no').readOnly = false"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <input id="swal-department" class="form-control mb-2" placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø/‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">
                    <input id="swal-activity" class="form-control mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                    <input id="swal-signer" class="form-control mb-2" placeholder="‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°">
                    <input id="swal-practitioner" class="form-control mb-2" placeholder="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">`;
            }
            return '';
        }

        window.openAddModal = async () => {
            const nextId = generateNextDocNo(allDocs, currentCategory, currentYear);
            
            // Dropdown HTML
            const catSelectHtml = `
                <select id="swal-cat-select" class="form-select mb-3" onchange="updateModalFields()">
                    <option value="memo" ${currentCategory==='memo'?'selected':''}>üì® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                    <option value="command" ${currentCategory==='command'?'selected':''}>‚öñÔ∏è ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</option>
                    <option value="send" ${currentCategory==='send'?'selected':''}>üì§ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡πà‡∏á</option>
                    <option value="announce" ${currentCategory==='announce'?'selected':''}>üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</option>
                    <option value="certificate" ${currentCategory==='certificate'?'selected':''}>üéñÔ∏è ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</option>
                    <option value="student_affairs" ${currentCategory==='student_affairs'?'selected':''}>üéì ‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                </select>
                <div id="swal-dynamic-fields">${getFieldsHtml(currentCategory, nextId)}</div>
            `;

            // Expose update function globally for inline onchange
            window.updateModalFields = () => {
                const sel = document.getElementById('swal-cat-select').value;
                const newNextId = generateNextDocNo(allDocs, sel, currentYear);
                document.getElementById('swal-dynamic-fields').innerHTML = getFieldsHtml(sel, newNextId);
            };

            const { value: form } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà',
                html: `${catSelectHtml}<label class="small text-muted w-100 text-start">‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="swal-date" type="date" class="form-control mb-2" value="${new Date().toISOString().split('T')[0]}">`,
                showCancelButton: true, confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                preConfirm: () => {
                    const selCat = document.getElementById('swal-cat-select').value;
                    const no = document.getElementById('swal-no').value;
                    const date = document.getElementById('swal-date').value;
                    
                    if(!no || !date) Swal.showValidationMessage('‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');
                    
                    return {
                        doc_no: no, doc_date: date,
                        subject: document.getElementById('swal-subject')?.value || '-',
                        from: document.getElementById('swal-from')?.value || '-',
                        to: document.getElementById('swal-to')?.value || '-',
                        practitioner: document.getElementById('swal-practitioner')?.value || '-',
                        signer: document.getElementById('swal-signer')?.value || '-',
                        department: document.getElementById('swal-department')?.value || '-',
                        activity: document.getElementById('swal-activity')?.value || '-',
                        category: selCat, 
                        year: String(currentYear), 
                        created_at: serverTimestamp()
                    }
                }
            });

            if(form) {
                await addDoc(collection(db, "documents"), form);
                Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß', 'success');
                // If added category matches current view, reload
                if (form.category === currentCategory) loadDocuments();
            }
        };

        // --- NEW: Multi-Category Smart Paste With Select ---
        window.importFromText = async () => {
            const { value: formValues } = await Swal.fire({
                title: '‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (Smart Paste)',
                html: `
                    <select id="swal-paste-cat" class="form-select mb-3">
                        <option value="memo" selected>üì® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏Æ.‡∏≠‡∏ö.xxx.x)</option>
                        <option value="command">‚öñÔ∏è ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡∏Æ.‡∏≠‡∏ö.xxx)</option>
                        <option value="send">üì§ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡πà‡∏á (‡∏ó‡∏µ‡πà ‡∏®‡∏ò...)</option>
                        <option value="announce">üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® (‡∏Æ.‡∏≠‡∏ö/‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)</option>
                        <option value="student_affairs">üéì ‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏Å‡∏ô‡∏£...)</option>
                        <option value="certificate">üéñÔ∏è ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£ (‡∏Æ.‡∏≠‡∏ö...)</option>
                    </select>
                    <textarea id="swal-paste-text" class="form-control" style="height:250px" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•',
                preConfirm: () => {
                    return {
                        cat: document.getElementById('swal-paste-cat').value,
                        text: document.getElementById('swal-paste-text').value
                    }
                }
            });

            if (formValues && formValues.text) {
                Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...', didOpen: () => Swal.showLoading()});
                
                const staffNames = [
                    "‡∏™‡∏∏‡∏†‡∏≤‡∏ß‡∏î‡∏µ", "‡∏Å‡∏ô‡∏Å‡∏≠‡∏£", "‡∏™‡∏∏‡∏Å‡∏±‡∏ç‡∏ç‡∏≤", "‡∏™‡∏∏‡∏∏‡∏Å‡∏±‡∏ç‡∏ç‡∏≤", "‡∏ô‡∏∏‡∏ä‡∏à‡∏£‡∏¥‡∏¢‡∏≤", "‡∏ò‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥", "‡∏ß‡∏µ‡∏£‡∏¢‡∏≤", "Ryan", "‡∏Å‡∏ô‡∏Å‡∏ß‡∏£‡∏£‡∏ì", "Grip", "‡∏ô‡∏á‡∏Ñ‡∏£‡∏≤‡∏ç", 
                    "‡∏≠‡∏†‡∏¥‡∏ç‡∏ç‡∏≤", "‡∏ß‡∏£‡∏£‡∏ì‡∏¥‡∏®‡∏≤", "‡∏ß‡∏±‡∏ä‡∏£‡∏≤", "‡∏ô‡∏£‡∏¥‡∏™‡∏£‡∏≤", "‡∏ä‡∏•‡∏ò‡∏¥‡∏ä‡∏≤", "‡πÑ‡∏û‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡πÑ‡∏û‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå‡πå", "‡∏ó‡∏¥‡∏û‡∏¢‡πå‡∏™‡∏∏‡∏î‡∏≤", "‡∏ó‡∏¥‡∏û‡∏¢‡πå‡∏™‡∏∏‡∏∏‡∏î‡∏≤", "‡∏≠‡∏†‡∏±‡∏™‡∏£‡∏≤", "‡∏†‡∏≤‡∏ì‡∏∏‡∏ß‡∏±‡∏í‡∏ô‡πå", 
                    "‡∏†‡∏±‡∏ó‡∏ò‡∏¥‡∏£‡∏≤", "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ô‡∏±‡∏ô‡∏ó‡∏≤", "‡∏û‡∏¥‡∏°‡∏û‡πå‡πå‡∏ô‡∏±‡∏ô‡∏ó‡∏≤", "‡∏£‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç", "‡∏õ‡∏£‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥", "‡∏≠‡∏£‡∏¥‡∏©‡∏≤", "‡∏≠‡∏£‡∏¥‡∏¥‡∏©‡∏≤", "‡∏≠‡∏£‡∏¥‡∏¥‡∏¥‡∏©‡∏≤", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏≤ ‡∏à‡∏±‡∏ô‡∏ó‡∏°‡∏≤‡∏®", 
                    "‡∏ß‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå", "‡∏ß‡∏£‡∏≤‡∏†‡∏£‡∏ì‡πå‡πå", "‡∏®‡∏ï‡∏û‡∏•", "‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå", "‡πÄ‡∏Å‡∏®‡∏Å‡∏±‡∏ç‡∏ç‡∏≤", "‡∏à‡∏≤‡∏£‡∏∏‡∏ì‡∏µ", "‡∏û‡∏¥‡∏ä‡∏¢‡∏≤", "‡∏®‡∏∏‡∏†‡∏Å‡∏£", "‡∏ê‡∏¥‡∏ï‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏†‡∏±‡∏ó‡∏£‡∏≤‡∏û‡∏£", "‡∏†‡∏±‡∏±‡∏ó‡∏£‡∏≤‡∏û‡∏£", 
                    "‡∏û‡∏¥‡∏ä‡∏ç‡πå", "‡∏û‡∏¥‡∏¥‡∏ä‡∏ç‡πå", "‡∏•‡∏•‡∏¥‡∏ï‡∏≤", "‡πÄ‡∏û‡πá‡∏ç‡∏ô‡∏†‡∏≤", "‡πÄ‡∏û‡πá‡πá‡∏ç‡∏ô‡∏†‡∏≤", "‡∏î‡∏≤‡∏£‡∏∏‡∏ì‡∏µ", "‡∏ô‡∏¥‡∏ï‡∏¢‡∏≤", "‡∏à‡∏≤‡∏£‡∏∏‡∏ß‡∏£‡∏£‡∏ì", "‡∏à‡∏≤‡∏£‡∏∏‡∏∏‡∏ß‡∏£‡∏£‡∏ì", "‡∏ä‡∏∏‡∏ï‡∏¥‡∏°‡∏≤ ‡∏®‡∏¥‡∏•‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥", 
                    "‡∏ß‡∏¥‡∏ä‡∏¢‡∏≤‡∏ô‡∏±‡∏ô‡∏ó‡πå", "‡∏ß‡∏¥‡∏ä‡∏¢‡∏≤‡∏ô‡∏±‡∏ô‡∏ó‡πå‡πå", "‡∏ß‡∏¥‡∏ä‡∏¢‡∏≤‡∏ô‡∏±‡∏±‡∏ô‡∏ó‡πå", "‡∏â‡∏±‡∏ï‡∏£‡∏ä‡∏±‡∏¢", "‡∏õ‡∏£‡∏£‡∏±‡∏ï‡∏ô‡πå", "‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏†‡∏≤", "‡πÄ‡∏ö‡∏ç‡∏à‡∏û‡∏£", "‡πÇ‡∏ä‡∏ï‡∏¥‡∏¥‡∏Å‡∏≤", "‡∏ú‡∏≠.", "‡∏ú‡∏à‡∏Å.", "‡∏Å‡∏¥‡∏ï‡∏¥‡∏û‡∏á‡∏©‡πå", "‡∏Å‡∏¥‡∏¥‡∏ï‡∏¥‡∏û‡∏á‡∏©‡πå"
                ];

                const items = [];
                const cat = formValues.cat;
                
                // Determine Splitter based on category
                let splitter;
                if(cat === 'memo') splitter = /(?=^‡∏Æ\.‡∏≠‡∏ö\.[\d\.]+\/)/gm;
                else if(cat === 'command' || cat === 'announce' || cat === 'certificate') splitter = /(?=^‡∏Æ\.‡∏≠‡∏ö\.\d+\/)/gm;
                else if(cat === 'send') splitter = /(?=^‡∏ó‡∏µ‡πà ‡∏®‡∏ò)/gm;
                else if(cat === 'student_affairs') splitter = /(?=^‡∏Å‡∏ô‡∏£\.)/gm;
                else splitter = /\n/; // Fallback

                let lines = formValues.text.split('\n').filter(l => l.trim().length > 0);
                
                if(lines.length > 0 && !lines[0].match(/^(‡∏Æ\.‡∏≠‡∏ö\.|‡∏ó‡∏µ‡πà ‡∏®‡∏ò|‡∏Å‡∏ô‡∏£\.|‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®)/)) {
                     lines = formValues.text.split(splitter);
                }

                lines.forEach(chunk => {
                    chunk = chunk.trim();
                    if (!chunk) return;

                    let docNo = '', docDateRaw = '', subject = '', practitioner = '-', from = '-', to = '-', signer = '-';
                    let department = '-', activity = '-';
                    
                    let match;
                    
                    if(cat === 'student_affairs') {
                        // FIX: Aggressive parsing for Student Affairs
                        // Pattern: ‡∏Å‡∏ô‡∏£.‡∏Æ.‡∏≠‡∏ö. 00127 ‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2568‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...
                        const dateRegex = /(\d{1,2}\s+[‡∏Å-‡πô]+\s+\d{4})/;
                        const dateMatch = chunk.match(dateRegex);
                        
                        if (dateMatch) {
                            docDateRaw = dateMatch[1]; 
                            const dateIndex = chunk.indexOf(docDateRaw);
                            
                            docNo = chunk.substring(0, dateIndex).trim(); 
                            let content = chunk.substring(dateIndex + docDateRaw.length).trim();
                            
                            // Extract Practitioner
                            for (const name of staffNames) {
                                if (content.endsWith(name)) {
                                    practitioner = name;
                                    content = content.substring(0, content.lastIndexOf(name)).trim();
                                    break;
                                }
                            }

                            // Extract From/To
                            if (content.startsWith("‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")) {
                                from = "‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                                content = content.substring("‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô".length).trim();
                            } else if (content.startsWith("‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")) {
                                from = "‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                                content = content.substring("‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô".length).trim();
                            }

                            if (content.startsWith("‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô")) {
                                to = "‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
                                content = content.substring("‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô".length).trim();
                            } else if (content.startsWith("‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á")) {
                                to = "‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á";
                                content = content.substring("‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á".length).trim();
                            }

                            subject = content;
                        } else {
                            match = chunk.match(/^(‡∏Å‡∏ô‡∏£\.‡∏Æ\.‡∏≠‡∏ö\.\s*\d+)(.*)/);
                            if(match) {
                                docNo = match[1];
                                subject = match[2].trim();
                            }
                        }
                    }
                    else if (cat === 'certificate') {
                        match = chunk.match(/^(‡∏Æ\.‡∏≠‡∏ö\.[\d\/]+(-[\d\/]+)?)(.*)/);
                        if(match) {
                            docNo = match[1];
                            let content = match[3].trim();
                            const dateMatch = content.match(/(\d{1,2}\s*[\u0E00-\u0E7F\.]+\s*\d{4})/);
                            if(dateMatch) {
                                docDateRaw = dateMatch[1];
                                const dateIndex = content.indexOf(docDateRaw);
                                const part1 = content.substring(0, dateIndex).trim(); 
                                const part2 = content.substring(dateIndex + docDateRaw.length).trim(); 

                                const depts = ["‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠", "‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢", "‡∏û‡∏•‡∏∞‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©", "‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô", "‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£", "‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏®‡∏¥‡∏•‡∏õ‡∏∞", "‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û", "‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß", "‡∏õ‡∏ê‡∏°‡∏ß‡∏±‡∏¢"];
                                let foundDept = false;
                                for (const d of depts) {
                                    if (part1.startsWith(d)) {
                                        department = d;
                                        activity = part1.substring(d.length).trim(); 
                                        foundDept = true;
                                        break;
                                    }
                                }
                                if (!foundDept) activity = part1; 
                                subject = activity;

                                for (const name of staffNames) {
                                    if (part2.endsWith(name)) {
                                        practitioner = name;
                                        signer = part2.substring(0, part2.lastIndexOf(name)).trim();
                                        break;
                                    }
                                }
                                if (practitioner === '-') signer = part2; 
                            }
                        }
                    } 
                    else if(cat === 'memo') {
                        match = chunk.match(/^(‡∏Æ\.‡∏≠‡∏ö\.[\d\.]+\/\d{4})(\d{1,2}\s+[‡∏Å-‡πô]+\s+\d{4})?(.*)/);
                        if(match) {
                            docNo = match[1];
                            docDateRaw = match[2] ? match[2].trim() : "";
                            subject = match[3] ? match[3].trim() : "";
                        }
                    } 
                    else if(cat === 'command' || cat === 'announce') {
                        match = chunk.match(/^(‡∏Æ\.‡∏≠‡∏ö\.\d+\/\d{4})(.*)/);
                        if(match) {
                            docNo = match[1];
                            let rest = match[2].trim();
                            const dateMatch = rest.match(/(\d{1,2}\s+[‡∏Å-‡πô]+\s+\d{4})/);
                            if(dateMatch) {
                                docDateRaw = dateMatch[1];
                                let parts = rest.split(docDateRaw);
                                subject = parts[0].trim();
                                signer = parts[1] ? parts[1].trim() : '-';
                            } else {
                                subject = rest;
                            }
                        }
                    }
                    else if(cat === 'send') {
                        match = chunk.match(/^(‡∏ó‡∏µ‡πà ‡∏®‡∏ò [0-9\.]+\/[\d]+)(.*)/);
                        if(match) {
                            docNo = match[1];
                            let rest = match[2].trim();
                            const dateMatch = rest.match(/(\d{1,2}\s+[‡∏Å-‡πô]+\s+\d{4})/);
                            if(dateMatch) {
                                docDateRaw = dateMatch[1];
                                subject = rest.replace(docDateRaw, '').trim(); 
                            } else {
                                subject = rest;
                            }
                        }
                    }

                    if (docNo) {
                        // Date Fallback
                        if (!docDateRaw) {
                             const dateMatch = chunk.substring(docNo.length).match(/^\s*(\d{1,2}\s+[^\s0-9]+\s+\d{4})(.*)/);
                             if(dateMatch) {
                                docDateRaw = dateMatch[1];
                                if(cat === 'memo') subject = dateMatch[2].trim();
                             }
                        }

                        let docDateISO = '';
                        if (docDateRaw) {
                            const mNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥.‡∏¢."];
                            let normalizedDate = docDateRaw.trim();
                            normalizedDate = normalizedDate.replace('‡∏°‡∏¥.‡∏¢.', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô').replace('‡∏Å.‡∏û.', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå').replace('‡∏°.‡∏Ñ.', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°').replace('‡∏°‡∏µ.‡∏Ñ.', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°').replace('‡πÄ‡∏°.‡∏¢.', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô').replace('‡∏û.‡∏Ñ.', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°').replace('‡∏Å.‡∏Ñ.', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°').replace('‡∏™.‡∏Ñ.', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°').replace('‡∏Å.‡∏¢.', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô').replace('‡∏ï.‡∏Ñ.', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°').replace('‡∏û.‡∏¢.', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô').replace('‡∏ò.‡∏Ñ.', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°');
                            
                            const parts = normalizedDate.split(' ');
                            if(parts.length >= 3) {
                                const day = parts[0].replace(/[^\d]/g, '').padStart(2, '0');
                                const monthIdx = mNames.findIndex(m => parts[1].includes(m)) + 1;
                                const month = monthIdx > 0 ? monthIdx.toString().padStart(2, '0') : '01';
                                let year = parseInt(parts[2]);
                                if (year > 2400) year -= 543;
                                docDateISO = `${year}-${month}-${day}`;
                            }
                        }

                        // Extract Practitioner for other cats
                        if(cat === 'memo' || cat === 'send') {
                            for (const name of staffNames) {
                                if (subject.endsWith(name)) {
                                    practitioner = name;
                                    subject = subject.substring(0, subject.lastIndexOf(name)).trim();
                                    break;
                                }
                            }
                        }
                        
                        subject = subject.replace(/^,|,$/g, '').trim();

                        items.push({
                            doc_no: docNo,
                            doc_date: docDateISO || new Date().toISOString().split('T')[0],
                            subject: subject,
                            practitioner: practitioner,
                            signer: signer,
                            from: from,
                            to: to,
                            department: department,
                            activity: activity,
                            category: cat,
                            year: String(currentYear),
                            created_at: serverTimestamp()
                        });
                    }
                });

                if (items.length > 0) {
                    const CHUNK_SIZE = 400; 
                    for (let i = 0; i < items.length; i += CHUNK_SIZE) {
                        const batch = writeBatch(db);
                        const chunk = items.slice(i, i + CHUNK_SIZE);
                        chunk.forEach(item => {
                            const ref = doc(collection(db, "documents"));
                            batch.set(ref, item);
                        });
                        await batch.commit();
                    }
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏°‡∏ß‡∏î: ${formValues.cat})`, 'success');
                    setTimeout(() => loadDocuments(), 1000);
                } else {
                    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'warning');
                }
            }
        };

        // ... (Other functions same as before) ...
        async function processRawData(arrayBufferOrString, isString = false) {
            try {
                let jsonData;
                if (isString) {
                    const workbook = XLSX.read(arrayBufferOrString, {type: 'string'});
                    jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                } else {
                    const data = new Uint8Array(arrayBufferOrString);
                    const workbook = XLSX.read(data, {type: 'array'});
                    jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                }

                const batch = writeBatch(db);
                let count = 0;

                jsonData.forEach((row, index) => {
                    if(row.length < 2) return; 
                    const c0 = (row[0]||'').toString().trim();
                    if(c0.includes('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà') || c0.includes('‡∏ó‡∏µ‡πà') || c0.includes('‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') || c0 === '') return;

                    let d = { category: currentCategory, year: String(currentYear), created_at: serverTimestamp() };
                    let dateRaw = null;

                    if(currentCategory === 'memo') { 
                        d.doc_no = row[0]||'-'; dateRaw = row[1]; d.subject = row[2]||'-'; d.practitioner = row[3]||'-';
                    } else if(currentCategory === 'command') { 
                        d.doc_no = row[0]||'-'; d.subject = row[1]||'-'; dateRaw = row[2]; d.signer = row[3]||'-';
                    } else if(currentCategory === 'send' || currentCategory === 'student_affairs') { 
                        d.doc_no = row[0]||'-'; dateRaw = row[1]; d.from = row[2]||'-'; d.to = row[3]||'-'; d.subject = row[4]||'-'; d.practitioner = row[5]||'-';
                    } else if(currentCategory === 'announce') { 
                        d.doc_no = row[0]||'-'; d.subject = row[1]||'-'; dateRaw = row[2]; d.signer = row[3]||'-';
                    } else if(currentCategory === 'certificate') { 
                        // Updated mapping for certificate
                        // Col: ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞, ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°, ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏°, ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
                        d.doc_no = row[0]||'-'; 
                        d.department = row[1]||'-'; 
                        d.activity = row[2]||'-'; 
                        d.subject = row[2]||'-'; // Also save activity as subject for searching
                        dateRaw = row[3]; 
                        d.signer = row[4]||'-'; 
                        d.practitioner = row[5]||'-';
                    }

                    try {
                        if(typeof dateRaw === 'number') {
                            d.doc_date = new Date((dateRaw - (25567 + 2)) * 86400 * 1000).toISOString().split('T')[0];
                        } else if(typeof dateRaw === 'string') {
                            if(dateRaw.match(/\d+\/\d+\/\d+/)) { 
                                const p = dateRaw.split('/');
                                let y = parseInt(p[2]); if(y>2400) y-=543;
                                d.doc_date = `${y}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                            } else if(dateRaw.includes(' ')) { 
                                const mNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
                                const p = dateRaw.split(' ');
                                const dNum = p[0];
                                const mIdx = mNames.findIndex(m => p[1].includes(m)) + 1;
                                let y = parseInt(p[2]); if(y>2400) y-=543;
                                d.doc_date = `${y}-${mIdx.toString().padStart(2,'0')}-${dNum.padStart(2,'0')}`;
                            } else {
                                d.doc_date = new Date().toISOString().split('T')[0];
                            }
                        } else {
                            d.doc_date = new Date().toISOString().split('T')[0];
                        }
                    } catch(e) { d.doc_date = new Date().toISOString().split('T')[0]; }

                    if(d.doc_no && d.doc_no !== '-') {
                        batch.set(doc(collection(db, "documents")), d);
                        count++;
                    }
                });

                await batch.commit();
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            } catch (e) {
                console.error(e);
                Swal.fire('Error', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ' + e.message, 'error');
            }
        }

        window.importFromExcel = async () => {
            const { value: file } = await Swal.fire({
                title: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå Excel',
                text: '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .xlsx, .xls, .csv',
                input: 'file',
                inputAttributes: { 'accept': '.xlsx, .xls, .csv' }
            });

            if(file) {
                Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...', didOpen:()=>Swal.showLoading()});
                const reader = new FileReader();
                reader.onload = async (e) => processRawData(e.target.result, false);
                reader.readAsArrayBuffer(file);
            }
        };

        window.importFromGoogleSheet = async () => {
            const { value: url } = await Swal.fire({
                title: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet',
                html: `<input id="swal-url" class="form-control" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">`,
                showCancelButton: true,
                confirmButtonText: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                preConfirm: () => document.getElementById('swal-url').value
            });

            if(url) {
                Swal.fire({title:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', didOpen:()=>Swal.showLoading()});
                try {
                    const response = await fetch(url);
                    if(!response.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
                    const csvText = await response.text();
                    await processRawData(csvText, true);
                } catch(e) {
                    Swal.fire('Error', e.message, 'error');
                }
            }
        }

        window.clearCategoryData = async () => {
            const res = await Swal.fire({
                title: `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${currentCategory}" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: '‡∏•‡∏ö'
            });

            if(res.isConfirmed) {
                Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', didOpen: () => Swal.showLoading()});
                const batch = writeBatch(db);
                filteredDocs.slice(0, 490).forEach(d => {
                    batch.delete(doc(db, "documents", d.id));
                });
                await batch.commit();
                Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success');
            }
        }

        window.deleteDocItem = async (id) => {
            if((await Swal.fire({title:'‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?', showCancelButton:true, confirmButtonText:'‡∏•‡∏ö'})).isConfirmed) {
                await deleteDoc(doc(db, "documents", id));
            }
        };

        window.exportToExcel = () => {
            const ws = XLSX.utils.json_to_sheet(filteredDocs);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `Sarabun_${currentCategory}.xlsx`);
        };

        onAuthStateChanged(auth, (user) => {
            if(user) loadDocuments();
            else signInAnonymously(auth);
        });
    </script>
</body>
</html>