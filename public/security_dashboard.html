<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏®‡∏π‡∏ô‡∏¢‡πå ‡∏£‡∏õ‡∏†. - School Hub</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary-bg: #374151; --secondary-bg: #f3f4f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--secondary-bg); color: #374151; padding-bottom: 80px; }
        
        .navbar { background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .navbar-brand { font-weight: 700; color: var(--primary-bg) !important; }
        
        .stat-card { border: none; border-radius: 12px; transition: transform 0.2s; color: white; overflow: hidden; position: relative; }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-icon { position: absolute; right: 10px; bottom: 10px; font-size: 3rem; opacity: 0.2; }
        
        .request-card { border: none; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; transition: all 0.2s; border-left: 5px solid transparent; }
        .request-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* Status Colors */
        .status-pending { border-left-color: #ffc107 !important; }
        .status-approved { border-left-color: #198754 !important; } 
        .status-ongoing { border-left-color: #0dcaf0 !important; }
        .status-completed { border-left-color: #6c757d !important; } 
        .status-rejected { border-left-color: #dc3545 !important; }

        .badge-status { font-weight: 500; padding: 0.5em 0.8em; border-radius: 50px; font-size: 0.8rem; }
        
        .badge-security { background-color: #374151; color: white; }
        .badge-outside { background-color: #8b5cf6; color: white; }

        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.3s; }
        #loadingScreen.hidden { opacity: 0; visibility: hidden; }

        .fab-btn {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            border-radius: 50%; background: var(--primary-bg); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000;
            border: none; transition: transform 0.2s;
        }
        .fab-btn:hover { transform: scale(1.1); background: #1f2937; }

        @media (max-width: 768px) {
            .container { padding-left: 15px; padding-right: 15px; }
            .stat-card { margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div id="loadingScreen"><div class="spinner-border text-dark mb-3"></div><h6>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå ‡∏£‡∏õ‡∏†...</h6></div>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html"><i class="fa-solid fa-chevron-left me-2"></i> ‡∏®‡∏π‡∏ô‡∏¢‡πå ‡∏£‡∏õ‡∏†. (Security Hub)</a>
            <div class="d-flex align-items-center">
                <span id="userRoleBadge" class="badge bg-dark me-2">...</span>
                <button class="btn btn-sm btn-outline-danger rounded-circle" id="btnLogout"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card stat-card bg-warning text-dark h-100 p-3">
                    <h3 class="fw-bold" id="countPending">0</h3>
                    <small>‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</small>
                    <i class="fa-solid fa-bell stat-icon"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card stat-card bg-info text-dark h-100 p-3">
                    <h3 class="fw-bold" id="countOngoing">0</h3>
                    <small>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å</small>
                    <i class="fa-solid fa-person-walking-arrow-right stat-icon"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card stat-card bg-success text-white h-100 p-3">
                    <h3 class="fw-bold" id="countCompleted">0</h3>
                    <small>‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß/‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</small>
                    <i class="fa-solid fa-check-circle stat-icon"></i>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card stat-card bg-secondary h-100 p-3">
                    <h3 class="fw-bold" id="countTotal">0</h3>
                    <small>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                    <i class="fa-solid fa-list stat-icon"></i>
                </div>
            </div>
        </div>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
            <h5 class="fw-bold m-0"><i class="fa-solid fa-tower-observation me-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h5>
            <div class="d-flex gap-2">
                <select id="filterType" class="form-select form-select-sm w-auto" onchange="loadRequests()">
                    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="security">üõ°Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ ‡∏£‡∏õ‡∏†.</option>
                    <option value="outside">üöó ‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
                </select>
                <select id="filterStatus" class="form-select form-select-sm w-auto" onchange="loadRequests()">
                    <option value="all" selected>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
                    <option value="active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (Approved/Ongoing)</option>
                    <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                </select>
            </div>
        </div>

        <div id="requestList"></div>

    </div>

    <button class="fab-btn" onclick="openReportModal()" title="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡∏°‡πà"><i class="fa-solid fa-plus"></i></button>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modalContent"></div>
                </div>
                <div class="modal-footer bg-light d-block" id="modalFooter"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUserRole = '';
        let securityList = [];
        let outsideList = [];
        let mergedList = [];

        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('loadingScreen');
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUserRole = userDoc.data().role;
                    
                    // üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 'personnel' ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                    if (!['admin', 'security_guard', 'personnel'].includes(currentUserRole)) {
                        Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', text: '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' })
                            .then(() => window.location.href = 'dashboard.html');
                        return;
                    }
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ Role ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                    let roleName = 'Security';
                    if(currentUserRole === 'admin') roleName = 'Admin';
                    if(currentUserRole === 'personnel') roleName = 'HR (‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)';
                    document.getElementById('userRoleBadge').innerText = roleName;
                    
                    listenToSecurity();
                    listenToOutside();
                }
            } else {
                window.location.href = 'index.html';
            }
            if(loader) loader.classList.add('hidden');
        });

        function listenToSecurity() {
            const q = query(collection(db, "security_requests"), orderBy("created_at", "desc"));
            onSnapshot(q, (snapshot) => {
                securityList = [];
                snapshot.forEach(doc => securityList.push({ id: doc.id, ...doc.data(), type: 'security' }));
                mergeAndRender();
            });
        }

        function listenToOutside() {
            const q = query(collection(db, "outside_requests"), orderBy("created_at", "desc"));
            onSnapshot(q, (snapshot) => {
                outsideList = [];
                snapshot.forEach(doc => outsideList.push({ id: doc.id, ...doc.data(), type: 'outside' }));
                mergeAndRender();
            });
        }

        function mergeAndRender() {
            mergedList = [...securityList, ...outsideList];
            mergedList.sort((a, b) => (b.created_at?.seconds || 0) - (a.created_at?.seconds || 0));
            updateStats();
            loadRequests();
        }

        function updateStats() {
            let pending = 0, ongoing = 0, completed = 0;
            const todayStr = new Date().toDateString();

            mergedList.forEach(item => {
                const itemDate = item.created_at?.seconds ? new Date(item.created_at.seconds * 1000).toDateString() : '';
                
                if(item.status === 'pending') pending++;
                if(item.status === 'ongoing' || item.status === 'approved') ongoing++; 
                if(item.status === 'completed' && itemDate === todayStr) completed++;
            });

            document.getElementById('countPending').innerText = pending;
            document.getElementById('countOngoing').innerText = ongoing;
            document.getElementById('countCompleted').innerText = completed;
            document.getElementById('countTotal').innerText = mergedList.length;
        }

        window.loadRequests = () => {
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const container = document.getElementById('requestList');
            container.innerHTML = "";

            const filtered = mergedList.filter(item => {
                const matchType = typeFilter === 'all' ? true : item.type === typeFilter;
                
                let matchStatus = true;
                if (statusFilter === 'all') matchStatus = true;
                else if (statusFilter === 'active') matchStatus = ['approved', 'ongoing', 'in_progress'].includes(item.status);
                else matchStatus = item.status === statusFilter;

                return matchType && matchStatus;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-5 text-muted bg-white rounded shadow-sm"><i class="fa-solid fa-check-double fs-1 mb-3"></i><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
                return;
            }

            filtered.forEach(item => {
                const dateStr = item.created_at?.seconds ? new Date(item.created_at.seconds * 1000).toLocaleString('th-TH', { hour:'2-digit', minute:'2-digit', day:'numeric', month:'short' }) : '-';
                const statusObj = getStatusInfo(item.status, item.type);
                
                let iconHtml = '', titleHtml = '', detailHtml = '', badgeType = '';

                if(item.type === 'security') {
                    iconHtml = '<i class="fa-solid fa-shield-halved text-danger fs-4 me-3"></i>';
                    titleHtml = item.topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏';
                    detailHtml = `<i class="fa-solid fa-location-dot text-danger me-1"></i> ${item.location || '-'}`;
                    badgeType = '<span class="badge badge-security me-1">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</span>';
                } else {
                    iconHtml = '<i class="fa-solid fa-car-side text-primary fs-4 me-3"></i>';
                    titleHtml = `‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å: ${item.destination || '-'}`;
                    detailHtml = `<i class="fa-regular fa-clock text-primary me-1"></i> ‡πÄ‡∏ß‡∏•‡∏≤: ${item.start_time || '-'} ‡∏ñ‡∏∂‡∏á ${item.end_time || '-'}`;
                    badgeType = '<span class="badge badge-outside me-1">‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span>';
                }

                const html = `
                <div class="card request-card bg-white status-${item.status}">
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="mt-1">${iconHtml}</div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h6 class="fw-bold mb-0 text-dark">${titleHtml}</h6>
                                    <span class="badge ${statusObj.bgClass} badge-status ms-2">${statusObj.label}</span>
                                </div>
                                <div class="mb-2">${badgeType}</div>
                                <p class="text-secondary small mb-2 bg-light p-2 rounded">${detailHtml}</p>
                                
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:28px; height:28px; font-size:10px;">
                                            ${(item.reporterName || item.requester_name || 'U').substring(0,2).toUpperCase()}
                                        </div>
                                        <div class="lh-1">
                                            <span class="d-block small fw-bold">${item.reporterName || item.requester_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</span>
                                            <small class="text-muted" style="font-size: 0.7rem;">${dateStr}</small>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-dark" onclick="viewDetail('${item.id}', '${item.type}')">
                                        ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        };

        function getStatusInfo(status, type) {
            if(type === 'outside') {
                switch(status) {
                    case 'pending': return { label: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', bgClass: 'bg-warning text-dark' };
                    case 'approved': return { label: '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß', bgClass: 'bg-success' }; 
                    case 'ongoing': return { label: '‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å', bgClass: 'bg-info text-dark' };
                    case 'completed': return { label: '‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß', bgClass: 'bg-secondary' };
                    case 'rejected': return { label: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï', bgClass: 'bg-danger' };
                    default: return { label: status, bgClass: 'bg-secondary' };
                }
            } else {
                switch(status) {
                    case 'pending': return { label: '‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà! ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', bgClass: 'bg-warning text-dark' };
                    case 'approved': return { label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏á‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏', bgClass: 'bg-info text-dark' };
                    case 'completed': return { label: '‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏Å‡∏ï‡∏¥', bgClass: 'bg-secondary' };
                    case 'rejected': return { label: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', bgClass: 'bg-danger' };
                    default: return { label: status, bgClass: 'bg-secondary' };
                }
            }
        }

        window.viewDetail = (id, type) => {
            const item = mergedList.find(r => r.id === id);
            if(!item) return;

            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const modalFooter = document.getElementById('modalFooter');
            
            modalTitle.innerHTML = type === 'security' ? '<i class="fa-solid fa-shield-halved"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏' : '<i class="fa-solid fa-car-side"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å';

            let contentHtml = '', buttonsHtml = '';

            if (type === 'security') {
                let imgHtml = item.evidence_url ? `<img src="${item.evidence_url}" class="img-fluid rounded mb-3 w-100 shadow-sm" style="max-height: 200px; object-fit: cover;">` : '';
                contentHtml = `
                    ${imgHtml}
                    <h5 class="fw-bold">${item.topic}</h5>
                    <p class="text-muted small"><i class="fa-solid fa-location-dot"></i> ${item.location}</p>
                    <div class="alert alert-light border"><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${item.detail || '-'}</div>
                    <small>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${item.reporterName}</small>
                `;
                
                // ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Security/Admin)
                if (item.status === 'pending') {
                    buttonsHtml = `
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="updateStatus('security_requests', '${item.id}', 'approved')"><i class="fa-solid fa-person-running"></i> ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                            <button class="btn btn-outline-danger" onclick="updateStatus('security_requests', '${item.id}', 'rejected')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ó‡πá‡∏à</button>
                        </div>`;
                } else if (item.status === 'approved') {
                    buttonsHtml = `<button class="btn btn-success w-100" onclick="updateStatus('security_requests', '${item.id}', 'completed')"><i class="fa-solid fa-check-circle"></i> ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà / ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</button>`;
                }
            } else {
                // ‡∏Ç‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                contentHtml = `
                    <div class="text-center mb-3">
                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width:60px; height:60px; font-size:24px;">
                            ${(item.requester_name||'U').substring(0,2)}
                        </div>
                        <h5 class="mt-2 fw-bold">${item.requester_name}</h5>
                        <span class="badge bg-light text-dark border">${item.requester_position || '‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'}</span>
                    </div>
                    <ul class="list-group mb-3">
                        <li class="list-group-item"><strong>‡πÑ‡∏õ‡∏ó‡∏µ‡πà:</strong> ${item.destination}</li>
                        <li class="list-group-item"><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${item.reason}</li>
                        <li class="list-group-item"><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${item.start_time} - ${item.end_time}</li>
                        <li class="list-group-item"><strong>‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞:</strong> ${item.vehicle_type || '-'} (${item.license_plate || '-'})</li>
                    </ul>
                `;
                
                if (item.status === 'pending') {
                    // üî•üî• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ Admin ‡πÅ‡∏•‡∏∞ Personnel ‡∏Å‡∏î‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
                    if (currentUserRole === 'admin' || currentUserRole === 'personnel') {
                        buttonsHtml = `
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="updateStatus('outside_requests', '${item.id}', 'approved')"><i class="fa-solid fa-check-circle"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-outline-danger" onclick="updateStatus('outside_requests', '${item.id}', 'rejected')"><i class="fa-solid fa-times-circle"></i> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                            </div>`;
                    } else {
                        // ‡∏£‡∏õ‡∏†. ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô (‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
                        buttonsHtml = `<div class="alert alert-warning text-center m-0 w-100"><i class="fa-solid fa-clock"></i> ‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•/‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>`;
                    }
                } else if (item.status === 'approved') {
                    buttonsHtml = `<button class="btn btn-warning w-100" onclick="updateStatus('outside_requests', '${item.id}', 'ongoing')"><i class="fa-solid fa-person-walking-arrow-right"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ‡∏£‡∏£.)</button>`;
                } else if (item.status === 'ongoing') {
                    buttonsHtml = `<button class="btn btn-success w-100" onclick="updateStatus('outside_requests', '${item.id}', 'completed')"><i class="fa-solid fa-person-walking-arrow-loop-left"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß)</button>`;
                } else if (item.status === 'completed') {
                    buttonsHtml = `<div class="alert alert-success text-center m-0 w-100"><i class="fa-solid fa-check"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏ö‡∏á‡∏≤‡∏ô)</div>`;
                }
            }

            modalContent.innerHTML = contentHtml;
            modalFooter.innerHTML = buttonsHtml;
            
            const el = document.getElementById('detailModal');
            const modal = new bootstrap.Modal(el);
            modal.show();
        };

        window.updateStatus = async (collectionName, docId, newStatus) => {
            try {
                // ‡∏õ‡∏¥‡∏î Modal ‡∏Å‡πà‡∏≠‡∏ô
                const el = document.getElementById('detailModal');
                const modal = bootstrap.Modal.getInstance(el);
                if(modal) modal.hide();

                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });

                // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô DB
                await updateDoc(doc(db, collectionName, docId), { status: newStatus });

                // 2. üî• ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
                const docSnap = await getDoc(doc(db, collectionName, docId));
                if(docSnap.exists()){
                    const data = docSnap.data();
                    const targetEmail = data.requester_email || data.reporterEmail;
                    if(targetEmail){
                         let subj = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠';
                         let body = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ${newStatus}`;
                         
                         // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏ß‡∏¢‡πÜ
                         if(newStatus === 'approved') { 
                             subj = '‚úÖ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; 
                             body = '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏°‡∏¢‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å'; 
                         } else if(newStatus === 'rejected') { 
                             subj = '‚ùå ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'; 
                             body = '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; 
                         } else if(newStatus === 'ongoing') { 
                             subj = 'üöó ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'; 
                             body = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß'; 
                         } else if(newStatus === 'completed') { 
                             subj = 'üèÅ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'; 
                             body = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'; 
                         }

                         await addDoc(collection(db, "mail"), {
                            to: targetEmail,
                            message: { 
                                subject: subj, 
                                html: `<div style="font-family: sans-serif; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
                                        <h3 style="color: #333;">${subj}</h3>
                                        <p>${body}</p>
                                        <hr><p style="color: gray; font-size: 0.9em;">School Hub System</p>
                                       </div>` 
                            }
                         });
                    }
                }

                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false });
            } catch (error) {
                console.error(error);
                Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
            }
        };

        window.openReportModal = () => {
            Swal.fire({
                title: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÉ‡∏´‡∏°‡πà',
                html: `<input id="swal-topic" class="form-control mb-2" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå"><input id="swal-loc" class="form-control mb-2" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"><textarea id="swal-detail" class="form-control mb-2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>`,
                showCancelButton: true, confirmButtonText: '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏',
                preConfirm: () => {
                    const topic = document.getElementById('swal-topic').value;
                    const loc = document.getElementById('swal-loc').value;
                    const detail = document.getElementById('swal-detail').value;
                    if(!topic) return Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠');
                    return { topic, loc, detail };
                }
            }).then(async (result) => {
                if(result.isConfirmed) {
                    const { topic, loc, detail } = result.value;
                    await addDoc(collection(db, 'security_requests'), {
                        topic, location: loc, detail, status: 'pending', created_at: serverTimestamp(),
                        reporterName: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà (' + (auth.currentUser.email.split('@')[0]) + ')',
                        uid: auth.currentUser.uid, reporterEmail: auth.currentUser.email
                    });
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                }
            });
        };

        document.getElementById('btnLogout').addEventListener('click', () => {
             Swal.fire({ title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes' })
                 .then((res) => { if(res.isConfirmed) signOut(auth); });
        });
    </script>
</body>
</html>