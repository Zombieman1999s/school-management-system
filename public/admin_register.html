<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ - Admin Control</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #212529; font-family: 'Kanit', sans-serif; color: white; }
        .form-container { 
            max-width: 500px; margin: 50px auto; 
            background: #2c3034; padding: 40px; 
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            border: 1px solid #444;
        }
        .form-control, .form-select {
            background-color: #3d4246; border: 1px solid #555; color: white;
        }
        .form-control:focus, .form-select:focus {
            background-color: #495057; border-color: #dc3545; color: white; box-shadow: none;
        }
        .btn-register { width: 100%; padding: 12px; font-size: 1.1rem; border-radius: 50px; }
        .section-icon { font-size: 3rem; color: #dc3545; margin-bottom: 20px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark border-bottom border-secondary mb-4">
        <div class="container">
            <span class="navbar-brand text-danger fw-bold"><i class="fa-solid fa-user-shield me-2"></i>Admin Center</span>
            <a href="dashboard.html" class="btn btn-sm btn-outline-light rounded-pill">üîô ‡∏Å‡∏•‡∏±‡∏ö Dashboard</a>
        </div>
    </nav>

    <div class="container">
        <div class="form-container text-center">
            <div class="section-icon"><i class="fa-solid fa-user-plus"></i></div>
            <h3 class="mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</h3>
            
            <form id="registerForm" class="text-start">
                
                <div class="mb-3">
                    <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Email)</label>
                    <input type="email" id="email" class="form-control" placeholder="user@school.com" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                    <div class="input-group">
                        <input type="text" id="password" class="form-control" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß" required>
                        <button class="btn btn-outline-secondary" type="button" onclick="generatePass()">‡∏™‡∏∏‡πà‡∏°</button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</label>
                    <input type="text" id="firstName" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required>
                </div>

                <div class="mb-4">
                    <label class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Role)</label>
                    <select id="role" class="form-select" required>
                        <option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>
                        <option value="teacher">üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π / ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå (Teacher)</option>
                        <option value="personnel">üìã ‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• / ‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£ (Personnel)</option>
                        <option value="technician">üõ†Ô∏è ‡∏ä‡πà‡∏≤‡∏á / ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Technician)</option>
                        <option value="transport">üöê ‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ (Transport)</option>
                        <option value="admin">üëÆ ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-danger btn-register shadow fw-bold">
                    <i class="fa-solid fa-check-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                </button>

            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ‡πÉ‡∏™‡πà Config ‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡πå‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM",
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb",
            storageBucket: "school-management-system-10cbb.firebasestorage.app",
            messagingSenderId: "674779385916",
            appId: "1:674779385916:web:9a26e4d25282dc23a6f339"
        };

        // 1. App ‡∏´‡∏•‡∏±‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Admin ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°)
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà Admin ‡πÑ‡∏´‡∏°?
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤
                } else {
                    alert("‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!");
                    window.location.href = "dashboard.html";
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å)
        window.generatePass = () => {
            const chars = "0123456789abcdefghijklmnopqrstuvwxyz";
            let pass = "";
            for (let i = 0; i < 6; i++) {
                pass += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('password').value = pass;
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á User (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!)
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const firstName = document.getElementById('firstName').value;
            const role = document.getElementById('role').value;

            if(password.length < 6) { Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô‡πÑ‡∏õ', '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'warning'); return; }

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...', didOpen: () => Swal.showLoading() });

            try {
                // üî• ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏™‡∏£‡πâ‡∏≤‡∏á App ‡∏£‡∏≠‡∏á (Secondary App) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏∞ Admin ‡∏≠‡∏≠‡∏Å
                const secondaryApp = initializeApp(firebaseConfig, "Secondary");
                const secondaryAuth = getAuth(secondaryApp);

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡πÉ‡∏ô Authentication (‡πÉ‡∏ä‡πâ App ‡∏£‡∏≠‡∏á)
                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                const newUser = userCredential.user;

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firestore (‡πÉ‡∏ä‡πâ App ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Admin ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô)
                // ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ uid ‡∏Ç‡∏≠‡∏á user ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏•‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢
                await setDoc(doc(db, "users", newUser.uid), {
                    email: email,
                    firstName: firstName,
                    role: role,
                    created_at: serverTimestamp()
                });

                // ‡∏•‡∏ö App ‡∏£‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏∑‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥)
                // (‡πÉ‡∏ô JS ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô module ‡∏°‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏∂‡∏á ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏à‡∏∞ clean ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ï‡πâ‡∏≠‡∏á deleteApp)
                
                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!',
                    html: `User: <b>${email}</b><br>Pass: <b>${password}</b><br>Role: <b>${role.toUpperCase()}</b>`,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });

                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('registerForm').reset();

            } catch (error) {
                console.error("Error:", error);
                let msg = error.message;
                if(error.code === 'auth/email-already-in-use') msg = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß";
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', msg, 'error');
            }
        });
    </script>
</body>
</html>