<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ù‡∏∏‡πà‡∏ô PM2.5 - School Hub</title>
    <link rel="icon" href="icon.png" type="image/png">
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --aqi-good: #00e400;     /* 0-50 */
            --aqi-moderate: #ffff00; /* 51-100 */
            --aqi-unhealthy-sens: #ff7e00; /* 101-150 */
            --aqi-unhealthy: #ff0000; /* 151-200 */
            --aqi-very-unhealthy: #8f3f97; /* 201-300 */
            --aqi-hazardous: #7e0023; /* 300+ */
            
            --bg-color: #f8fafc;
            --card-radius: 24px;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: #1e293b;
            padding-bottom: 100px;
            transition: background 0.5s;
        }

        /* Dynamic Background based on AQI */
        .bg-good { background: linear-gradient(180deg, #dcfce7 0%, #f0fdf4 100%); }
        .bg-moderate { background: linear-gradient(180deg, #fef9c3 0%, #fffbeb 100%); }
        .bg-unhealthy { background: linear-gradient(180deg, #fee2e2 0%, #fff1f2 100%); }

        .navbar-custom {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        .main-card {
            border: none; border-radius: var(--card-radius);
            background: white; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
            padding: 30px; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }

        /* AQI Gauge */
        .aqi-gauge-wrapper {
            position: relative; width: 250px; height: 250px; margin: 0 auto;
        }
        .aqi-value {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center;
        }
        .aqi-num { font-size: 5rem; font-weight: 800; line-height: 1; letter-spacing: -2px; }
        .aqi-unit { font-size: 1rem; color: #94a3b8; font-weight: 600; }
        .aqi-status { 
            margin-top: 10px; font-size: 1.2rem; font-weight: 700; 
            padding: 5px 15px; border-radius: 50px; display: inline-block;
            color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Activity Icons */
        .activity-item {
            background: white; border-radius: 16px; padding: 15px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid #f1f5f9; margin-bottom: 10px;
            transition: 0.2s;
        }
        .activity-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin-right: 15px;
        }
        .status-badge { font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }

        /* Floating Particles (Dust Effect) */
        .dust-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden; display: none;
        }
        .dust-particle {
            position: absolute; background: #94a3b8; border-radius: 50%;
            opacity: 0.6; animation: float 10s infinite linear;
        }
        @keyframes float {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            50% { opacity: 0.6; }
            100% { transform: translateY(-100px) translateX(50px); opacity: 0; }
        }

        /* AI Analysis Section */
        .ai-camera-box {
            border: 2px dashed #cbd5e1; border-radius: 20px;
            background: #f8fafc; padding: 30px; text-align: center;
            cursor: pointer; transition: 0.2s;
        }
        .ai-camera-box:hover { border-color: #3b82f6; background: #eff6ff; }
        
        .preview-img { width: 100%; border-radius: 16px; margin-top: 15px; display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-good" id="bodyTheme">

    <!-- Dust Effect Layer -->
    <div id="dustLayer" class="dust-container"></div>

    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="dashboard.html">
                <i class="fa-solid fa-chevron-left me-2"></i> Dashboard
            </a>
            <span class="fw-bold text-dark"><i class="fa-solid fa-wind text-secondary me-2"></i>Air Quality</span>
        </div>
    </nav>

    <div class="container py-4" style="position: relative; z-index: 1;">
        
        <!-- 1. Main Display -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6 mx-auto">
                <div class="main-card text-center pt-5">
                    <div class="d-flex justify-content-between align-items-start absolute-top px-4">
                        <div class="text-start">
                            <h5 class="fw-bold m-0 text-primary">
                                <i class="fa-solid fa-location-dot text-danger me-2"></i>‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ (‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á)
                            </h5>
                            <small class="text-muted" id="lastUpdate">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: -</small>
                        </div>
                        <button class="btn btn-sm btn-light border rounded-pill shadow-sm" onclick="refreshData()">
                            <i class="fa-solid fa-rotate-right"></i>
                        </button>
                    </div>

                    <div class="aqi-gauge-wrapper mt-3">
                        <canvas id="aqiGauge"></canvas>
                        <div class="aqi-value">
                            <div class="aqi-num" id="aqiNum">--</div>
                            <div class="aqi-unit">US AQI</div>
                        </div>
                    </div>
                    
                    <div class="mt-2 mb-4">
                        <span id="aqiStatus" class="aqi-status" style="background-color: #cbd5e1;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                        <p class="mt-3 text-muted px-4" id="healthAdvice">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</p>
                    </div>

                    <!-- Mini Stats -->
                    <div class="row border-top pt-3">
                        <div class="col-4 border-end">
                            <small class="text-muted d-block">PM2.5</small>
                            <span class="fw-bold fs-5" id="valPM25">-</span> <small>¬µg/m¬≥</small>
                        </div>
                        <div class="col-4 border-end">
                            <small class="text-muted d-block">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</small>
                            <span class="fw-bold fs-5" id="valTemp">-</span> <small>¬∞C</small>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô</small>
                            <span class="fw-bold fs-5" id="valHumid">-</span> <small>%</small>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-muted" style="font-size: 0.7rem;">Source: WAQI (aqicn.org)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. AI Sky Scanner -->
        <div class="row mb-4">
            <div class="col-lg-6 mx-auto">
                <div class="card border-0 shadow-sm p-4 rounded-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary bg-opacity-10 p-2 rounded-circle me-3 text-primary">
                            <i class="fa-solid fa-wand-magic-sparkles fs-4"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold m-0">AI Sky Scanner (Beta)</h6>
                            <small class="text-muted">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡∏®‡∏ô‡∏ß‡∏¥‡∏™‡∏±‡∏¢</small>
                        </div>
                    </div>

                    <input type="file" id="skyInput" accept="image/*" class="d-none" onchange="handleSkyImage(this)">
                    <div class="ai-camera-box" onclick="document.getElementById('skyInput').click()">
                        <i class="fa-solid fa-camera fa-2x text-muted mb-2"></i>
                        <p class="mb-0 text-muted fw-bold">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤</p>
                    </div>

                    <div id="aiPreviewSection" class="hidden text-center">
                        <img id="skyPreview" class="preview-img">
                        <div id="aiLoading" class="mt-3 text-primary fw-bold hidden">
                            <i class="fa-solid fa-spinner fa-spin me-2"></i> AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®...
                        </div>
                        <div id="aiResult" class="mt-3 p-3 bg-light rounded-3 text-start border hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Activity Guide -->
        <h6 class="fw-bold text-muted px-2 mb-3">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h6>
        <div class="row g-3">
            <div class="col-md-6 col-lg-4">
                <div class="activity-item">
                    <div class="d-flex align-items-center">
                        <div class="activity-icon bg-light text-primary"><i class="fa-solid fa-person-running"></i></div>
                        <div>
                            <div class="fw-bold">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á</div>
                            <small class="text-muted">‡∏ß‡∏¥‡πà‡∏á, ‡πÄ‡∏ï‡∏∞‡∏ö‡∏≠‡∏•, ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß</small>
                        </div>
                    </div>
                    <span id="actOutdoor" class="status-badge bg-secondary text-white">‡∏£‡∏≠‡∏ú‡∏•</span>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="activity-item">
                    <div class="d-flex align-items-center">
                        <div class="activity-icon bg-light text-warning"><i class="fa-solid fa-mask-face"></i></div>
                        <div>
                            <div class="fw-bold">‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢</div>
                            <small class="text-muted">N95 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏ú‡πâ‡∏≤</small>
                        </div>
                    </div>
                    <span id="actMask" class="status-badge bg-secondary text-white">‡∏£‡∏≠‡∏ú‡∏•</span>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="activity-item">
                    <div class="d-flex align-items-center">
                        <div class="activity-icon bg-light text-info"><i class="fa-solid fa-door-open"></i></div>
                        <div>
                            <div class="fw-bold">‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</div>
                            <small class="text-muted">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å</small>
                        </div>
                    </div>
                    <span id="actWindow" class="status-badge bg-secondary text-white">‡∏£‡∏≠‡∏ú‡∏•</span>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        // ‡πÉ‡∏ä‡πâ Key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Dashboard
        const firebaseConfig = {
            apiKey: "AIzaSyDYqVJFyuge_4PcObIBMB9h5oIT3fYWuHM", 
            authDomain: "school-management-system-10cbb.firebaseapp.com",
            projectId: "school-management-system-10cbb"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const GEMINI_API_KEY = "AIzaSyBPdWK_BNfCXt_SXXGD-MKbG5qfAJlb5C8"; 

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
        });

        // --- 1. GET DATA FROM WAQI API (UBON) ---
        async function refreshData() {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏ö‡∏•‡∏Ø...', didOpen: () => Swal.showLoading() });
            
            // üî• ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ Token ‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà https://aqicn.org/data-platform/token/
            // ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ 'demo'
            const WAQI_TOKEN = 'cb156454d441f4724477c21f6b8f0eeae4d0534a'; 
            
            // Station ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "nai-mueang, Thailand" ‡∏ï‡∏≤‡∏° URL ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
            // URL API: https://api.waqi.info/feed/thailand/ubon-ratchathani/mueang/nai-mueang/?token=...
            const STATION_PATH = 'thailand/ubon-ratchathani/mueang/nai-mueang';

            try {
                const response = await fetch(`https://api.waqi.info/feed/${STATION_PATH}/?token=${WAQI_TOKEN}`);
                const result = await response.json();

                if (result.status === 'ok') {
                    const data = result.data;
                    const aqi = data.aqi;
                    // ‡∏ö‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏ö ‡∏ï‡πâ‡∏≠‡∏á check ‡∏Å‡πà‡∏≠‡∏ô
                    const pm25 = data.iaqi.pm25 ? data.iaqi.pm25.v : '-';
                    const temp = data.iaqi.t ? data.iaqi.t.v : '-';
                    const humid = data.iaqi.h ? data.iaqi.h.v : '-';
                    
                    updateUI(aqi, pm25, temp, humid);
                    Swal.close();
                } else {
                    console.warn("API returned error:", result.data);
                    throw new Error("API Limit or Invalid Token");
                }

            } catch (e) {
                console.error("Using Mock Data due to:", e);
                // Fallback: Mock Data ‡∏ñ‡πâ‡∏≤ API ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Token demo ‡∏à‡∏≥‡∏Å‡∏±‡∏î)
                const mockAQI = Math.floor(Math.random() * (150 - 50) + 50);
                updateUI(mockAQI, (mockAQI/2).toFixed(1), 34, 60);
                
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡πâ
                if (WAQI_TOKEN === 'demo') {
                    const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 4000 });
                    toast.fire({ icon: 'info', title: '‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (Demo Token Limit)' });
                }
            }
        }

        function updateUI(aqi, pm25, temp, humid) {
            // Update Numbers
            const numAnim = new CountUp('aqiNum', 0, aqi, 0, 1.5);
            numAnim.start();
            
            document.getElementById('valPM25').innerText = pm25;
            document.getElementById('valTemp').innerText = temp;
            document.getElementById('valHumid').innerText = humid;
            document.getElementById('lastUpdate').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + new Date().toLocaleTimeString('th-TH');

            // Determine Status
            let status = "", color = "", bgClass = "", dust = false;
            let advice = "";

            if (aqi <= 50) {
                status = "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°"; color = "#00e400"; bgClass = "bg-good";
                advice = "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏™‡∏î‡πÉ‡∏™ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó!";
                setGuide("‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥", "‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô", "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà", "bg-success", "bg-secondary", "bg-success");
            } else if (aqi <= 100) {
                status = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"; color = "#ffff00"; bgClass = "bg-moderate";
                advice = "‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡∏õ‡πà‡∏ß‡∏¢‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏û‡πâ‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏≤‡∏Å‡∏≤‡∏£";
                setGuide("‡∏ó‡∏≥‡πÑ‡∏î‡πâ", "‡∏Ñ‡∏ô‡∏õ‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà", "‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ", "bg-success", "bg-warning", "bg-success");
            } else if (aqi <= 150) {
                status = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö"; color = "#ff7e00"; bgClass = "bg-moderate"; dust = true;
                advice = "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á ‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å‡∏ô‡∏≤‡∏ô";
                setGuide("‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏á", "‡∏Ñ‡∏ß‡∏£‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà", "‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á", "bg-warning", "bg-warning", "bg-warning");
            } else {
                status = "‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ø"; color = "#ff0000"; bgClass = "bg-unhealthy"; dust = true;
                advice = "‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏á‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡∏ô‡∏¥‡∏î ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏®";
                setGuide("‡∏á‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", "‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà", "‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏¥‡∏ó", "bg-danger", "bg-danger", "bg-danger");
            }

            // Update Colors & Theme
            document.getElementById('aqiStatus').innerText = status;
            document.getElementById('aqiStatus').style.backgroundColor = color;
            document.getElementById('aqiStatus').style.color = (aqi > 50 && aqi <= 100) ? "#333" : "#fff"; // Yellow needs dark text
            document.getElementById('healthAdvice').innerText = advice;
            document.getElementById('bodyTheme').className = bgClass;

            // Dust Animation
            const dustLayer = document.getElementById('dustLayer');
            dustLayer.style.display = dust ? 'block' : 'none';
            if (dust) createDustParticles();

            // Update Gauge
            updateGauge(aqi, color);
        }

        function setGuide(outdoor, mask, window, c1, c2, c3) {
            const setBadge = (id, text, cls) => {
                const el = document.getElementById(id);
                el.innerText = text;
                el.className = `status-badge text-white ${cls}`;
            };
            setBadge('actOutdoor', outdoor, c1);
            setBadge('actMask', mask, c2);
            setBadge('actWindow', window, c3);
        }

        let gaugeChart = null;
        function updateGauge(value, color) {
            const ctx = document.getElementById('aqiGauge').getContext('2d');
            if (gaugeChart) gaugeChart.destroy();

            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['AQI', 'Max'],
                    datasets: [{
                        data: [value, 300 - value], // Max 300 for visual
                        backgroundColor: [color, '#e2e8f0'],
                        borderWidth: 0,
                        circumference: 270,
                        rotation: 225
                    }]
                },
                options: {
                    cutout: '85%',
                    plugins: { tooltip: { enabled: false }, legend: { display: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }

        function createDustParticles() {
            const container = document.getElementById('dustLayer');
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'dust-particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.width = Math.random() * 10 + 5 + 'px';
                p.style.height = p.style.width;
                p.style.animationDuration = Math.random() * 5 + 5 + 's';
                p.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(p);
            }
        }

        // --- 2. AI SKY SCANNER ---
        window.handleSkyImage = async (input) => {
            if (!input.files[0]) return;
            
            const file = input.files[0];
            const reader = new FileReader();
            
            document.getElementById('aiPreviewSection').classList.remove('hidden');
            const preview = document.getElementById('skyPreview');
            const loading = document.getElementById('aiLoading');
            const result = document.getElementById('aiResult');
            
            loading.classList.remove('hidden');
            result.classList.add('hidden');

            reader.onload = async (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                const base64 = e.target.result.split(',')[1];
                
                try {
                    const prompt = "Analyze this sky image for air quality/visibility. Estimate: 1. Visibility (Clear/Hazy/Foggy) 2. Likely PM2.5 Level (Low/Moderate/High) 3. Brief advice. Reply in Thai.";
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                    });
                    
                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    
                    result.innerHTML = `<h6><i class="fa-solid fa-robot me-2"></i>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û:</h6>` + marked.parse(text);
                    result.classList.remove('hidden');

                } catch (err) {
                    result.innerHTML = `<span class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</span>`;
                    result.classList.remove('hidden');
                } finally {
                    loading.classList.add('hidden');
                }
            };
            reader.readAsDataURL(file);
        };

        // Helper for Number Animation
        class CountUp {
            constructor(id, start, end, decimals, duration) {
                this.el = document.getElementById(id);
                this.startVal = start;
                this.endVal = end;
                this.duration = duration * 1000;
                this.startTime = null;
            }
            start() { requestAnimationFrame(timestamp => this.update(timestamp)); }
            update(timestamp) {
                if (!this.startTime) this.startTime = timestamp;
                const progress = timestamp - this.startTime;
                const pct = Math.min(progress / this.duration, 1);
                const current = Math.floor(this.startVal + (this.endVal - this.startVal) * pct);
                this.el.innerText = current;
                if (progress < this.duration) requestAnimationFrame(timestamp => this.update(timestamp));
            }
        }

        // Auto Start
        refreshData();

    </script>
</body>
</html>